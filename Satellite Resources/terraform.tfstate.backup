{
  "version": 4,
  "terraform_version": "1.5.3",
  "serial": 45,
  "lineage": "54ce96e7-7cdb-2075-2daa-d0dd69c455f4",
  "outputs": {},
  "resources": [
    {
      "module": "module.control_plane",
      "mode": "data",
      "type": "ibm_is_image",
      "name": "host",
      "provider": "provider[\"registry.terraform.io/ibm-cloud/ibm\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "access_tags": [],
            "architecture": "amd64",
            "catalog_offering": [
              {
                "managed": false,
                "version": []
              }
            ],
            "checksum": "0cbcc7e6b9b50ca388ed8c1aace8caaf3d12c99d7a4275dc28e3e623cbcaa8c9",
            "crn": "crn:v1:bluemix:public:is:us-east:a/811f8abfbd32425597dc7ba40da98fa6::image:r014-f0e1d733-f981-445a-ae66-de7a59f11e25",
            "encryption": "none",
            "encryption_key": null,
            "id": "r014-f0e1d733-f981-445a-ae66-de7a59f11e25",
            "identifier": null,
            "name": "ibm-redhat-8-6-minimal-amd64-3",
            "os": "red-8-amd64",
            "source_volume": null,
            "status": "deprecated",
            "visibility": "public"
          },
          "sensitive_attributes": []
        }
      ]
    },
    {
      "module": "module.control_plane",
      "mode": "data",
      "type": "ibm_is_ssh_key",
      "name": "existing",
      "provider": "provider[\"registry.terraform.io/ibm-cloud/ibm\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "access_tags": [],
            "crn": "crn:v1:bluemix:public:is:us-east:a/b77832f89c084e1d994ec9ae8e1bce0e::key:r014-c0c9915b-a1e6-4fd4-9e0c-6ad37eaab759",
            "fingerprint": "SHA256:EWU+xb5ueLAR0Nvh556gaFeiUYNAa34SHe1+BKL/t2M",
            "id": "r014-c0c9915b-a1e6-4fd4-9e0c-6ad37eaab759",
            "length": 4096,
            "name": "gs-satellite-ibm-east1",
            "public_key": "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCSekyIYOJR39CXTQBsfQrwDmUaTIBP7WdWPifQ7wOc56SZm8MsVRZgtsBfOQ3AEMf31XOtuyenFC3oWdn5qEXt/YOAUTYKlmtsY+wY8pMgZ77opd0Fl7WzjUbAedkzvnLHRWhCyFCtsITo4jl8WGN/pEVDoeySv9LxNTJ9hafsfg8hwc3GB90xNRcFzCtm6GSp6y9FSsyTu9w0FRbkIF1FZT3Z7eoAfR4jblsUuy2OgtNlpcRcrTBuvY2sKSx+TLOVhO8Hp4bCWH4eNPVkEFoE+yFnowIYHVDMsm2Vvu0pYQ8n/skyPcXRwEKzWv4r20p5UVCT1BRtdxUsda+SgnECTVyOXyFBeGgkIY1zLYPttPfaonEOCmTP5SMS5ed9bz7fpowzRmuZ0MY2LcMXKeZW6GVyCycAnnq9ffBd/LLvq11sS82MI1+WQehJe2g22cqsZURDycrBYmav9UG4Kr00q0VzYb9JEYZTNKG5+MDzO7BLpyBD039tu7plQJpbT4z4KUWX3zuzUiR3Sgni7E28k5zqd77+Txcz36vqvnppCUtahGQf2Llz/4AiJUyZdpjNPzFob+6u+GvYAXFzuJGPiRAy3H9GJk56WWsTFyBlSNh1YnjRaQa3iIxjAuWPgO06EXXN+9bYqJqy4oo5MnsEor864bSMB+ZdmMw86sdeGQ==",
            "resource_controller_url": "https://cloud.ibm.com/vpc/compute/sshKeys",
            "resource_crn": "crn:v1:bluemix:public:is:us-east:a/b77832f89c084e1d994ec9ae8e1bce0e::key:r014-c0c9915b-a1e6-4fd4-9e0c-6ad37eaab759",
            "resource_group": null,
            "resource_group_name": "ea72d012571e4c3dabd4d52df09331bf",
            "resource_name": "gs-satellite-ibm-east1",
            "type": "rsa"
          },
          "sensitive_attributes": []
        }
      ]
    },
    {
      "module": "module.control_plane",
      "mode": "managed",
      "type": "ibm_is_floating_ip",
      "name": "location_hosts",
      "provider": "provider[\"registry.terraform.io/ibm-cloud/ibm\"]",
      "instances": [
        {
          "index_key": 0,
          "schema_version": 0,
          "attributes": {
            "access_tags": [],
            "address": "150.239.113.244",
            "crn": "crn:v1:bluemix:public:is:us-east-1:a/b77832f89c084e1d994ec9ae8e1bce0e::floating-ip:r014-3e9c5998-711d-4cb1-a801-f405a5cd2228",
            "id": "r014-3e9c5998-711d-4cb1-a801-f405a5cd2228",
            "name": "gs-satellite-ibm1-cp-01",
            "resource_controller_url": "https://cloud.ibm.com/vpc-ext/network/floatingIPs",
            "resource_crn": "crn:v1:bluemix:public:is:us-east-1:a/b77832f89c084e1d994ec9ae8e1bce0e::floating-ip:r014-3e9c5998-711d-4cb1-a801-f405a5cd2228",
            "resource_group": "5b9d354ad44b4698aca47651741f47d3",
            "resource_group_name": "Default",
            "resource_name": "gs-satellite-ibm1-cp-01",
            "resource_status": "available",
            "status": "available",
            "tags": [],
            "target": "0757-ad2246ae-98d0-47d3-a701-8889255f5772",
            "target_list": [
              {
                "crn": "",
                "deleted": [],
                "href": "https://us-east.iaas.cloud.ibm.com/v1/instances/0757_d1a521d0-2e0e-405d-83f6-a52a0d27092f/network_interfaces/0757-ad2246ae-98d0-47d3-a701-8889255f5772",
                "id": "0757-ad2246ae-98d0-47d3-a701-8889255f5772",
                "name": "eth0",
                "primary_ip": [
                  {
                    "address": "10.241.0.6",
                    "href": "https://us-east.iaas.cloud.ibm.com/v1/subnets/0757-b3302169-9838-4498-9580-dc9898fcb19b/reserved_ips/0757-e1739106-2743-4908-aeb5-bb821ba1fe02",
                    "name": "mantis-swipe-bubble-jailer",
                    "reserved_ip": "0757-e1739106-2743-4908-aeb5-bb821ba1fe02",
                    "resource_type": "subnet_reserved_ip"
                  }
                ],
                "resource_type": "network_interface"
              }
            ],
            "timeouts": null,
            "zone": "us-east-1"
          },
          "sensitive_attributes": [],
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjo2MDAwMDAwMDAwMDAsImRlbGV0ZSI6NjAwMDAwMDAwMDAwfX0=",
          "dependencies": [
            "module.control_plane.data.ibm_is_image.host",
            "module.control_plane.data.ibm_is_ssh_key.existing",
            "module.control_plane.ibm_is_instance.location_hosts",
            "module.location.data.ibm_satellite_attach_host_script.script",
            "module.location.data.ibm_satellite_location.location",
            "module.location.ibm_is_security_group.location_security_group",
            "module.location.ibm_is_subnet.location_subnet_zone",
            "module.location.ibm_is_vpc.location_vpc",
            "module.location.ibm_satellite_location.create_location"
          ]
        },
        {
          "index_key": 1,
          "schema_version": 0,
          "attributes": {
            "access_tags": [],
            "address": "169.59.163.69",
            "crn": "crn:v1:bluemix:public:is:us-east-2:a/b77832f89c084e1d994ec9ae8e1bce0e::floating-ip:r014-f09fd47b-05b9-4a17-b57b-009627b6def8",
            "id": "r014-f09fd47b-05b9-4a17-b57b-009627b6def8",
            "name": "gs-satellite-ibm1-cp-02",
            "resource_controller_url": "https://cloud.ibm.com/vpc-ext/network/floatingIPs",
            "resource_crn": "crn:v1:bluemix:public:is:us-east-2:a/b77832f89c084e1d994ec9ae8e1bce0e::floating-ip:r014-f09fd47b-05b9-4a17-b57b-009627b6def8",
            "resource_group": "5b9d354ad44b4698aca47651741f47d3",
            "resource_group_name": "Default",
            "resource_name": "gs-satellite-ibm1-cp-02",
            "resource_status": "available",
            "status": "available",
            "tags": [],
            "target": "0767-68962f36-f855-476d-aad4-ffbacdce9ffa",
            "target_list": [
              {
                "crn": "",
                "deleted": [],
                "href": "https://us-east.iaas.cloud.ibm.com/v1/instances/0767_f314c3e4-4170-4a7e-a729-d6490fafc31f/network_interfaces/0767-68962f36-f855-476d-aad4-ffbacdce9ffa",
                "id": "0767-68962f36-f855-476d-aad4-ffbacdce9ffa",
                "name": "eth0",
                "primary_ip": [
                  {
                    "address": "10.241.64.7",
                    "href": "https://us-east.iaas.cloud.ibm.com/v1/subnets/0767-a0afd690-b8d6-4bbb-ae5a-a8621eb21155/reserved_ips/0767-f12799ea-d2ad-4d64-ae87-9f62b85482cd",
                    "name": "unpaid-overturn-panhandle-rockiness",
                    "reserved_ip": "0767-f12799ea-d2ad-4d64-ae87-9f62b85482cd",
                    "resource_type": "subnet_reserved_ip"
                  }
                ],
                "resource_type": "network_interface"
              }
            ],
            "timeouts": null,
            "zone": "us-east-2"
          },
          "sensitive_attributes": [],
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjo2MDAwMDAwMDAwMDAsImRlbGV0ZSI6NjAwMDAwMDAwMDAwfX0=",
          "dependencies": [
            "module.control_plane.data.ibm_is_image.host",
            "module.control_plane.data.ibm_is_ssh_key.existing",
            "module.control_plane.ibm_is_instance.location_hosts",
            "module.location.data.ibm_satellite_attach_host_script.script",
            "module.location.data.ibm_satellite_location.location",
            "module.location.ibm_is_security_group.location_security_group",
            "module.location.ibm_is_subnet.location_subnet_zone",
            "module.location.ibm_is_vpc.location_vpc",
            "module.location.ibm_satellite_location.create_location"
          ]
        },
        {
          "index_key": 2,
          "schema_version": 0,
          "attributes": {
            "access_tags": [],
            "address": "150.239.224.6",
            "crn": "crn:v1:bluemix:public:is:us-east-3:a/b77832f89c084e1d994ec9ae8e1bce0e::floating-ip:r014-f7cc0525-235b-4a8f-847d-85d3850dd62d",
            "id": "r014-f7cc0525-235b-4a8f-847d-85d3850dd62d",
            "name": "gs-satellite-ibm1-cp-03",
            "resource_controller_url": "https://cloud.ibm.com/vpc-ext/network/floatingIPs",
            "resource_crn": "crn:v1:bluemix:public:is:us-east-3:a/b77832f89c084e1d994ec9ae8e1bce0e::floating-ip:r014-f7cc0525-235b-4a8f-847d-85d3850dd62d",
            "resource_group": "5b9d354ad44b4698aca47651741f47d3",
            "resource_group_name": "Default",
            "resource_name": "gs-satellite-ibm1-cp-03",
            "resource_status": "available",
            "status": "available",
            "tags": [],
            "target": "0777-b8bf7590-a656-47e9-a015-15a2b6820244",
            "target_list": [
              {
                "crn": "",
                "deleted": [],
                "href": "https://us-east.iaas.cloud.ibm.com/v1/instances/0777_3098871f-e2e5-4f6a-b4ed-9141ff57eca0/network_interfaces/0777-b8bf7590-a656-47e9-a015-15a2b6820244",
                "id": "0777-b8bf7590-a656-47e9-a015-15a2b6820244",
                "name": "eth0",
                "primary_ip": [
                  {
                    "address": "10.241.128.4",
                    "href": "https://us-east.iaas.cloud.ibm.com/v1/subnets/0777-aa5ce777-4fda-4ff5-9fa0-1b872e35ef2e/reserved_ips/0777-b797d430-8a9f-4c7a-aeb5-8ac34fa7f42f",
                    "name": "sandfish-masses-carefully-savanna",
                    "reserved_ip": "0777-b797d430-8a9f-4c7a-aeb5-8ac34fa7f42f",
                    "resource_type": "subnet_reserved_ip"
                  }
                ],
                "resource_type": "network_interface"
              }
            ],
            "timeouts": null,
            "zone": "us-east-3"
          },
          "sensitive_attributes": [],
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjo2MDAwMDAwMDAwMDAsImRlbGV0ZSI6NjAwMDAwMDAwMDAwfX0=",
          "dependencies": [
            "module.control_plane.data.ibm_is_image.host",
            "module.control_plane.data.ibm_is_ssh_key.existing",
            "module.control_plane.ibm_is_instance.location_hosts",
            "module.location.data.ibm_satellite_attach_host_script.script",
            "module.location.data.ibm_satellite_location.location",
            "module.location.ibm_is_security_group.location_security_group",
            "module.location.ibm_is_subnet.location_subnet_zone",
            "module.location.ibm_is_vpc.location_vpc",
            "module.location.ibm_satellite_location.create_location"
          ]
        }
      ]
    },
    {
      "module": "module.control_plane",
      "mode": "managed",
      "type": "ibm_is_instance",
      "name": "location_hosts",
      "provider": "provider[\"registry.terraform.io/ibm-cloud/ibm\"]",
      "instances": [
        {
          "index_key": 0,
          "schema_version": 0,
          "attributes": {
            "access_tags": [],
            "action": null,
            "auto_delete_volume": null,
            "availability_policy_host_failure": "restart",
            "bandwidth": 16000,
            "boot_volume": [
              {
                "auto_delete_volume": true,
                "encryption": "",
                "iops": 3000,
                "name": "rogue-unsmooth-clone-overexert",
                "profile": "general-purpose",
                "size": 100,
                "snapshot": "",
                "tags": [],
                "volume_id": "r014-d2dbe515-a748-44eb-977e-70055e704e6f"
              }
            ],
            "catalog_offering": [],
            "crn": "crn:v1:bluemix:public:is:us-east-1:a/b77832f89c084e1d994ec9ae8e1bce0e::instance:0757_d1a521d0-2e0e-405d-83f6-a52a0d27092f",
            "dedicated_host": null,
            "dedicated_host_group": null,
            "default_trusted_profile_auto_link": null,
            "default_trusted_profile_target": null,
            "disks": [],
            "force_action": false,
            "force_recovery_time": null,
            "gpu": [],
            "id": "0757_d1a521d0-2e0e-405d-83f6-a52a0d27092f",
            "image": "r014-f0e1d733-f981-445a-ae66-de7a59f11e25",
            "instance_template": null,
            "keys": [
              "r014-c0c9915b-a1e6-4fd4-9e0c-6ad37eaab759"
            ],
            "lifecycle_reasons": [],
            "lifecycle_state": "stable",
            "memory": 32,
            "metadata_service_enabled": false,
            "name": "gs-satellite-ibm1-cp-01",
            "network_interfaces": [],
            "placement_group": null,
            "placement_target": [],
            "primary_network_interface": [
              {
                "allow_ip_spoofing": false,
                "id": "0757-ad2246ae-98d0-47d3-a701-8889255f5772",
                "name": "eth0",
                "port_speed": 12000,
                "primary_ip": [
                  {
                    "address": "10.241.0.6",
                    "auto_delete": true,
                    "href": "https://us-east.iaas.cloud.ibm.com/v1/subnets/0757-b3302169-9838-4498-9580-dc9898fcb19b/reserved_ips/0757-e1739106-2743-4908-aeb5-bb821ba1fe02",
                    "name": "mantis-swipe-bubble-jailer",
                    "reserved_ip": "0757-e1739106-2743-4908-aeb5-bb821ba1fe02",
                    "resource_type": "subnet_reserved_ip"
                  }
                ],
                "primary_ipv4_address": "10.241.0.6",
                "security_groups": [
                  "r014-736bc133-3b71-4d7f-b3c1-c52ef26e626a"
                ],
                "subnet": "0757-b3302169-9838-4498-9580-dc9898fcb19b"
              }
            ],
            "profile": "bx2-8x32",
            "resource_controller_url": "https://cloud.ibm.com/vpc-ext/compute/vs",
            "resource_crn": "crn:v1:bluemix:public:is:us-east-1:a/b77832f89c084e1d994ec9ae8e1bce0e::instance:0757_d1a521d0-2e0e-405d-83f6-a52a0d27092f",
            "resource_group": "5b9d354ad44b4698aca47651741f47d3",
            "resource_group_name": "Default",
            "resource_name": "gs-satellite-ibm1-cp-01",
            "resource_status": "running",
            "status": "running",
            "status_reasons": [],
            "tags": [],
            "timeouts": null,
            "total_network_bandwidth": 12000,
            "total_volume_bandwidth": 4000,
            "user_data": "#!/bin/bash\n\nsubscription-manager release --set=8\nsubscription-manager repos --disable='*eus*'\n\ncat \u003c\u003c'STOPP' | tee /tmp/attachHost.sh\n#!/usr/bin/env bash\ncat \u003c\u003c 'HERE' \u003e\u003e/usr/local/bin/ibm-host-attach.sh\n#!/usr/bin/env bash\nset -ex\nmkdir -p /etc/satelliteflags\nHOST_ASSIGN_FLAG=\"/etc/satelliteflags/hostattachflag\"\nif [[ -f \"$HOST_ASSIGN_FLAG\" ]]; then\n\techo \"host has already been assigned. need to reload before you try the attach again\"\n\texit 0\nfi\nset +x\nHOST_QUEUE_TOKEN=\"9f75cd5f618da970de4d6ba7b1eec08bc74ed3dc317881ce8af00c3e34429bec2a3d324dcbd6be3b129fe9e510fd348b7ab95c805b442944db7006c81d170a5a49d20c52bdabc6b6eb2acfe6b79ad6cdb50d8587cec843f2f94c5a57a2f95e089bcfecb0d681af4dede4143b29a64a91d014e6453a5af30e92a48e809d628f001008a8695381ba204f444211e9c6c925218bb97f64c03dea3588f7721114db4f8d2834508b12b1eb9691fd19e4d2412ec52a2e7955e538c7d8c6077d46b9c11fbad7eef398475825ce8b611439c3b1d71eebc6db619fe8951d26a5a6c66bce183c0c729e1cfea9c46f690a6e0c18096eb375c2812418b7c23cacb2c7365e8e8a\"\nset -x\nACCOUNT_ID=\"b77832f89c084e1d994ec9ae8e1bce0e\"\nCONTROLLER_ID=\"cjjme7lw0k8v5b0qob9g\"\nSELECTOR_LABELS='{}'\nAPI_URL=\"https://origin.us-east.containers.cloud.ibm.com/\"\nREGION=\"us-east\"\n\nexport HOST_QUEUE_TOKEN\nexport ACCOUNT_ID\nexport CONTROLLER_ID\nexport REGION\n\n#shutdown known blacklisted services for Satellite (these will break kube)\nset +e\nsystemctl stop -f iptables.service\nsystemctl disable iptables.service\nsystemctl mask iptables.service\nsystemctl stop -f firewalld.service\nsystemctl disable firewalld.service\nsystemctl mask firewalld.service\nset -e\n\n# ensure you can successfully communicate with redhat mirrors (this is a prereq to the rest of the automation working)\nif [[ $(grep -ic \"maipo\" \u003c /etc/redhat-release) -ne 0 ]]; then\n\t#RHEL 7\n\tOPERATING_SYSTEM=\"RHEL7\"\nelif [[ $(grep -ic \"ootpa\" \u003c /etc/redhat-release) -ne 0 ]]; then\n\t#RHEL 8\n\tOPERATING_SYSTEM=\"RHEL8\"\nelif grep -qi \"coreos\" \u003c /etc/redhat-release; then\n\tOPERATING_SYSTEM=\"RHCOS\"\nelse\n\tOPERATING_SYSTEM=\"UNKNOWN\"\nfi\n\nif [[ \"${OPERATING_SYSTEM}\" != \"RHEL7\" \u0026\u0026 \"${OPERATING_SYSTEM}\" != \"RHEL8\" ]]; then\n\techo \"This script is only intended to run with a RHEL7 or RHEL8 operating system. Current operating system ${OPERATING_SYSTEM}.\"\n\texit 1\nfi\nexport OPERATING_SYSTEM\n\nsubscription-manager refresh\nif [[ \"${OPERATING_SYSTEM}\" == \"RHEL7\" ]]; then\n\tsubscription-manager repos --enable rhel-server-rhscl-7-rpms\n\tsubscription-manager repos --enable rhel-7-server-optional-rpms\n\tsubscription-manager repos --enable rhel-7-server-rh-common-rpms\n\tsubscription-manager repos --enable rhel-7-server-supplementary-rpms\n\tsubscription-manager repos --enable rhel-7-server-extras-rpms\nelif [[ \"${OPERATING_SYSTEM}\" == \"RHEL8\" ]]; then\n\tsubscription-manager release --set=8\n\tsubscription-manager repos --disable='*eus*'\n\tsubscription-manager repos --enable rhel-8-for-x86_64-baseos-rpms \n\tsubscription-manager repos --enable rhel-8-for-x86_64-appstream-rpms;\nfi\nyum install container-selinux -y\n\n\nif [[ \"${OPERATING_SYSTEM}\" == \"RHEL7\" ]]; then\n\tyum install rh-python36 -y\n\t# shellcheck disable=SC1091\n\tsource /opt/rh/rh-python36/enable\nelif [[ \"${OPERATING_SYSTEM}\" == \"RHEL8\" ]]; then\n\tyum install python39 -y\nfi\n\nmkdir -p /etc/satellitemachineidgeneration\nif [[ ! -f /etc/satellitemachineidgeneration/machineidgenerated ]]; then\n    rm -f /etc/machine-id\n    systemd-machine-id-setup\n    if openssl rand -hex 16; then\n      openssl rand -hex 16 \u003e /etc/machine-id\n    fi\n    touch /etc/satellitemachineidgeneration/machineidgenerated\nfi\n#STEP 1: GATHER INFORMATION THAT WILL BE USED TO REGISTER THE HOST\nHOSTNAME=$(hostname -s)\nHOSTNAME=${HOSTNAME,,}\nMACHINE_ID=$(cat /etc/machine-id)\nCPUS=$(nproc)\nMEMORY=$(grep MemTotal /proc/meminfo | awk '{print $2}')\nexport CPUS\nexport MEMORY\n\nif [[ \"${OPERATING_SYSTEM}\" != \"RHEL7\" \u0026\u0026 \"${OPERATING_SYSTEM}\" != \"RHEL8\" ]]; then\n  echo \"This script is only intended to run with a RHEL7 or RHEL8 operating system. Current operating system ${OPERATING_SYSTEM}. Going to continue on for backwards compatibility\"\nfi\n\nSELECTOR_LABELS=$(echo \"${SELECTOR_LABELS}\" | python3 -c \"import sys, json, os; z = json.load(sys.stdin); y = {\\\"cpu\\\": os.getenv('CPUS'), \\\"memory\\\": os.getenv('MEMORY'), \\\"os\\\": os.getenv('OPERATING_SYSTEM')}; z.update(y); print(json.dumps(z))\")\n\nset +e\nexport ZONE=\"\"\nexport PROVIDER=\"\"\nexport TOKEN=\"\"\necho \"Probing for AWS metadata\"\ngather_aws_token() {\n\tHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 -X PUT \"http://169.254.169.254/latest/api/token\" -H \"X-aws-ec2-metadata-token-ttl-seconds: 21600\")\n\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\techo \"bad return code\"\n\t\treturn 1\n\tfi\n\tif [[ -z \"$HTTP_BODY\" ]]; then\n\t\techo \"no token found\"\n\t\treturn 1\n\tfi\n\techo \"found aws access token\"\n\tTOKEN=\"$HTTP_BODY\"\n}\ngather_zone_info() {\n\tHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 -H \"X-aws-ec2-metadata-token: $TOKEN\" http://169.254.169.254/latest/meta-data/placement/availability-zone)\n\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\t# if a 401 retry without auth\n\tif [[ \"$HTTP_STATUS\" -eq 401 ]]; then\n\t\techo \"unable to get aws metadata with v2 metadata service, trying v1...\"\n\t\tHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 http://169.254.169.254/latest/meta-data/placement/availability-zone)\n\t\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\t\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\tfi\n\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\techo \"bad return code\"\n\t\treturn 1\n\tfi\n\tif [[ \"$HTTP_BODY\" =~ [^a-zA-Z0-9-] ]]; then\n\t\techo \"invalid zone format\"\n\t\treturn 1\n\tfi\n\tZONE=\"$HTTP_BODY\"\n}\ngather_aws_info() {\n    if ! gather_aws_token; then\n        return 1\n    fi\n    if ! gather_zone_info; then\n        return 1\n    fi\n}\nif gather_aws_info; then\n\techo \"aws metadata detected\"\n\tPROVIDER=\"aws\"\nfi\nif [[ -z \"$ZONE\" ]]; then\n\techo \"echo Probing for Azure Metadata\"\n\texport LOCATION_INFO=\"\"\n\texport AZURE_ZONE_NUMBER_INFO=\"\"\n\tgather_location_info() {\n\t\tHTTP_RESPONSE=$(curl -H Metadata:true --noproxy \"*\" --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 \"http://169.254.169.254/metadata/instance/compute/location?api-version=2021-01-01\u0026format=text\")\n\t\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\t\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\t\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\t\techo \"bad return code\"\n\t\t\treturn 1\n\t\tfi\n\t\tif [[ \"$HTTP_BODY\" =~ [^a-zA-Z0-9-] ]]; then\n\t\t\techo \"invalid format\"\n\t\t\treturn 1\n\t\tfi\n\t\tLOCATION_INFO=\"$HTTP_BODY\"\n\t}\n\tgather_azure_zone_number_info() {\n\t\tHTTP_RESPONSE=$(curl -H Metadata:true --noproxy \"*\" --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 \"http://169.254.169.254/metadata/instance/compute/zone?api-version=2021-01-01\u0026format=text\")\n\t\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\t\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\t\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\t\techo \"bad return code\"\n\t\t\treturn 1\n\t\tfi\n\t\tif [[ \"$HTTP_BODY\" =~ [^a-zA-Z0-9-] ]]; then\n\t\t\techo \"invalid format\"\n\t\t\treturn 1\n\t\tfi\n\t\tAZURE_ZONE_NUMBER_INFO=\"$HTTP_BODY\"\n\t}\n\tgather_zone_info() {\n\t\tif ! gather_location_info; then\n\t\t\treturn 1\n\t\tfi\n\t\tif ! gather_azure_zone_number_info; then\n\t\t\treturn 1\n\t\tfi\n\t\tif [[ -n \"$AZURE_ZONE_NUMBER_INFO\" ]]; then\n\t\t  ZONE=\"${LOCATION_INFO}-${AZURE_ZONE_NUMBER_INFO}\"\n\t\telse\n\t\t  ZONE=\"${LOCATION_INFO}\"\n\t\tfi\n\t}\n\tif gather_zone_info; then\n\t\techo \"azure metadata detected\"\n\t\tPROVIDER=\"azure\"\n\tfi\nfi\nif [[ -z \"$ZONE\" ]]; then\n\techo \"echo Probing for GCP Metadata\"\n\tgather_zone_info() {\n\t\tHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 \"http://metadata.google.internal/computeMetadata/v1/instance/zone\" -H \"Metadata-Flavor: Google\")\n\t\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\t\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\t\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\t\techo \"bad return code\"\n\t\t\treturn 1\n\t\tfi\n\t\tPOTENTIAL_ZONE_RESPONSE=$(echo \"$HTTP_BODY\" | awk -F '/' '{print $NF}')\n\t\tif [[ \"$POTENTIAL_ZONE_RESPONSE\" =~ [^a-zA-Z0-9-] ]]; then\n\t\t\techo \"invalid zone format\"\n\t\t\treturn 1\n\t\tfi\n\t\tZONE=\"$POTENTIAL_ZONE_RESPONSE\"\n\t}\n\tif gather_zone_info; then\n\t\techo \"gcp metadata detected\"\n\t\tPROVIDER=\"google\"\n\tfi\nfi\nset -e\nif [[ -n \"$ZONE\" ]]; then\n\tSELECTOR_LABELS=$(echo \"${SELECTOR_LABELS}\" | python3 -c \"import sys, json, os; z = json.load(sys.stdin); y = {\\\"zone\\\": os.getenv('ZONE')}; z.update(y); print(json.dumps(z))\")\nfi\nif [[ -n \"$PROVIDER\" ]]; then\n\tSELECTOR_LABELS=$(echo \"${SELECTOR_LABELS}\" | python3 -c \"import sys, json, os; z = json.load(sys.stdin); y = {\\\"provider\\\": os.getenv('PROVIDER')}; z.update(y); print(json.dumps(z))\")\nfi\n#Step 2: SETUP METADATA\ncat \u003c\u003cEOF \u003eregister.json\n{\n\"controller\": \"$CONTROLLER_ID\",\n\"name\": \"$HOSTNAME\",\n\"identifier\": \"$MACHINE_ID\",\n\"labels\": $SELECTOR_LABELS\n}\nEOF\n\nset +e\n#try to download and run host health check script\nset +x\n#first try to the satellite-health service is enabled\nHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --retry 5 --retry-delay 10 --retry-max-time 60 \\\n        \"${API_URL}satellite-health/api/v1/hello\")\nset -x\nHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\nHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\necho \"$HTTP_STATUS\"\nif [[ \"$HTTP_STATUS\" -eq 200 ]]; then\n        set +x\n        HTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --retry 20 --retry-delay 10 --retry-max-time 360 \\\n                \"${API_URL}satellite-health/sat-host-check\" -o /usr/local/bin/sat-host-check)\n        set -x\n        HTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n        HTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n        echo \"$HTTP_BODY\"\n        echo \"$HTTP_STATUS\"\n        if [[ \"$HTTP_STATUS\" -eq 200 ]]; then\n                chmod +x /usr/local/bin/sat-host-check\n                set +x\n                timeout 5m /usr/local/bin/sat-host-check --region $REGION  --endpoint $API_URL\n                set -x\n        else\n                echo \"Error downloading host health check script [HTTP status: $HTTP_STATUS]\"\n        fi\nelse\n        echo \"Skipping downloading host health check script [HTTP status: $HTTP_STATUS]\"\nfi\nset -e\n\nset +x\n#STEP 3: REGISTER HOST TO THE HOSTQUEUE. NEED TO EVALUATE HTTP STATUS 409 EXISTS, 201 created. ALL OTHERS FAIL.\nHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --retry 100 --retry-delay 10 --retry-max-time 1800 -X POST \\\n\t-H \"X-Auth-Hostqueue-APIKey: $HOST_QUEUE_TOKEN\" \\\n\t-H \"X-Auth-Hostqueue-Account: $ACCOUNT_ID\" \\\n\t-H \"Content-Type: application/json\" \\\n\t-d @register.json \\\n\t\"${API_URL}v2/multishift/hostqueue/host/register\")\nset -x\nHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\nHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\necho \"$HTTP_BODY\"\necho \"$HTTP_STATUS\"\nif [[ \"$HTTP_STATUS\" -ne 201 ]]; then\n\techo \"Error [HTTP status: $HTTP_STATUS]\"\n\texit 1\nfi\n\nHOST_ID=$(echo \"$HTTP_BODY\" | python3 -c \"import sys, json; print(json.load(sys.stdin)['id'])\")\n\n#STEP 4: WAIT FOR MEMBERSHIP TO BE ASSIGNED\nwhile true; do\n\tset +ex\n\tASSIGNMENT=$(curl --retry 100 --retry-delay 10 --retry-max-time 1800 -G -X GET \\\n\t\t-H \"X-Auth-Hostqueue-APIKey: $HOST_QUEUE_TOKEN\" \\\n\t\t-H \"X-Auth-Hostqueue-Account: $ACCOUNT_ID\" \\\n\t\t-d controllerID=\"$CONTROLLER_ID\" \\\n\t\t-d hostID=\"$HOST_ID\" \\\n\t\t\"${API_URL}v2/multishift/hostqueue/host/getAssignment\")\n\tset -ex\n\tisAssigned=$(echo \"$ASSIGNMENT\" | python3 -c \"import sys, json; print(json.load(sys.stdin)['isAssigned'])\" | awk '{print tolower($0)}')\n\tif [[ \"$isAssigned\" == \"true\" ]]; then\n\t\tbreak\n\tfi\n\tif [[ \"$isAssigned\" != \"false\" ]]; then\n\t\techo \"unexpected value for assign retrying\"\n\tfi\n\tsleep 10\ndone\n\n#STEP 5: ASSIGNMENT HAS BEEN MADE. SAVE SCRIPT AND RUN\necho \"$ASSIGNMENT\" | python3 -c \"import sys, json; print(json.load(sys.stdin)['script'])\" \u003e/usr/local/bin/ibm-host-agent.sh\nexport HOST_ID\nASSIGNMENT_ID=$(echo \"$ASSIGNMENT\" | python3 -c \"import sys, json; print(json.load(sys.stdin)['id'])\")\ncat \u003c\u003cEOF \u003e/etc/satelliteflags/ibm-host-agent-vars\nexport HOST_ID=${HOST_ID}\nexport ASSIGNMENT_ID=${ASSIGNMENT_ID}\nEOF\nchmod 0600 /etc/satelliteflags/ibm-host-agent-vars\nchmod 0700 /usr/local/bin/ibm-host-agent.sh\ncat \u003c\u003cEOF \u003e/etc/systemd/system/ibm-host-agent.service\n[Unit]\nDescription=IBM Host Agent Service\nAfter=network.target\n\n[Service]\nEnvironment=\"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"\nExecStart=/usr/local/bin/ibm-host-agent.sh\nRestart=on-failure\nRestartSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\nchmod 0644 /etc/systemd/system/ibm-host-agent.service\nsystemctl daemon-reload\nsystemctl start ibm-host-agent.service\ntouch \"$HOST_ASSIGN_FLAG\"\nHERE\n\nchmod 0700 /usr/local/bin/ibm-host-attach.sh\ncat \u003c\u003c 'EOF' \u003e/etc/systemd/system/ibm-host-attach.service\n[Unit]\nDescription=IBM Host Attach Service\nAfter=network.target\n\n[Service]\nEnvironment=\"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"\nExecStart=/usr/local/bin/ibm-host-attach.sh\nRestart=on-failure\nRestartSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\nchmod 0644 /etc/systemd/system/ibm-host-attach.service\nsystemctl daemon-reload\nsystemctl enable ibm-host-attach.service\nsystemctl start ibm-host-attach.service\n\nSTOPP\n\nsudo nohup bash /tmp/attachHost.sh \u0026\n\n",
            "vcpu": [
              {
                "architecture": "amd64",
                "count": 8
              }
            ],
            "volume_attachments": [
              {
                "id": "0757-74c16a97-11b4-4d22-860f-2c7145cadc38",
                "name": "adjourn-magma-matinee-semester",
                "volume_crn": "crn:v1:bluemix:public:is:us-east-1:a/b77832f89c084e1d994ec9ae8e1bce0e::volume:r014-d2dbe515-a748-44eb-977e-70055e704e6f",
                "volume_id": "r014-d2dbe515-a748-44eb-977e-70055e704e6f",
                "volume_name": "rogue-unsmooth-clone-overexert"
              }
            ],
            "volumes": null,
            "vpc": "r014-3b20e91d-b51d-47bf-8fd9-9c26cb716073",
            "wait_before_delete": true,
            "zone": "us-east-1"
          },
          "sensitive_attributes": [],
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjoxODAwMDAwMDAwMDAwLCJkZWxldGUiOjE4MDAwMDAwMDAwMDAsInVwZGF0ZSI6MTgwMDAwMDAwMDAwMH19",
          "dependencies": [
            "module.control_plane.data.ibm_is_image.host",
            "module.control_plane.data.ibm_is_ssh_key.existing",
            "module.location.data.ibm_satellite_attach_host_script.script",
            "module.location.data.ibm_satellite_location.location",
            "module.location.ibm_is_security_group.location_security_group",
            "module.location.ibm_is_subnet.location_subnet_zone",
            "module.location.ibm_is_vpc.location_vpc",
            "module.location.ibm_satellite_location.create_location"
          ]
        },
        {
          "index_key": 1,
          "schema_version": 0,
          "attributes": {
            "access_tags": [],
            "action": null,
            "auto_delete_volume": null,
            "availability_policy_host_failure": "restart",
            "bandwidth": 16000,
            "boot_volume": [
              {
                "auto_delete_volume": true,
                "encryption": "",
                "iops": 3000,
                "name": "jurist-halved-splicing-primp",
                "profile": "general-purpose",
                "size": 100,
                "snapshot": "",
                "tags": [],
                "volume_id": "r014-cad2403b-9b3c-46c6-b405-afc21cd9a5e2"
              }
            ],
            "catalog_offering": [],
            "crn": "crn:v1:bluemix:public:is:us-east-2:a/b77832f89c084e1d994ec9ae8e1bce0e::instance:0767_f314c3e4-4170-4a7e-a729-d6490fafc31f",
            "dedicated_host": null,
            "dedicated_host_group": null,
            "default_trusted_profile_auto_link": null,
            "default_trusted_profile_target": null,
            "disks": [],
            "force_action": false,
            "force_recovery_time": null,
            "gpu": [],
            "id": "0767_f314c3e4-4170-4a7e-a729-d6490fafc31f",
            "image": "r014-f0e1d733-f981-445a-ae66-de7a59f11e25",
            "instance_template": null,
            "keys": [
              "r014-c0c9915b-a1e6-4fd4-9e0c-6ad37eaab759"
            ],
            "lifecycle_reasons": [],
            "lifecycle_state": "stable",
            "memory": 32,
            "metadata_service_enabled": false,
            "name": "gs-satellite-ibm1-cp-02",
            "network_interfaces": [],
            "placement_group": null,
            "placement_target": [],
            "primary_network_interface": [
              {
                "allow_ip_spoofing": false,
                "id": "0767-68962f36-f855-476d-aad4-ffbacdce9ffa",
                "name": "eth0",
                "port_speed": 12000,
                "primary_ip": [
                  {
                    "address": "10.241.64.7",
                    "auto_delete": true,
                    "href": "https://us-east.iaas.cloud.ibm.com/v1/subnets/0767-a0afd690-b8d6-4bbb-ae5a-a8621eb21155/reserved_ips/0767-f12799ea-d2ad-4d64-ae87-9f62b85482cd",
                    "name": "unpaid-overturn-panhandle-rockiness",
                    "reserved_ip": "0767-f12799ea-d2ad-4d64-ae87-9f62b85482cd",
                    "resource_type": "subnet_reserved_ip"
                  }
                ],
                "primary_ipv4_address": "10.241.64.7",
                "security_groups": [
                  "r014-736bc133-3b71-4d7f-b3c1-c52ef26e626a"
                ],
                "subnet": "0767-a0afd690-b8d6-4bbb-ae5a-a8621eb21155"
              }
            ],
            "profile": "bx2-8x32",
            "resource_controller_url": "https://cloud.ibm.com/vpc-ext/compute/vs",
            "resource_crn": "crn:v1:bluemix:public:is:us-east-2:a/b77832f89c084e1d994ec9ae8e1bce0e::instance:0767_f314c3e4-4170-4a7e-a729-d6490fafc31f",
            "resource_group": "5b9d354ad44b4698aca47651741f47d3",
            "resource_group_name": "Default",
            "resource_name": "gs-satellite-ibm1-cp-02",
            "resource_status": "running",
            "status": "running",
            "status_reasons": [],
            "tags": [],
            "timeouts": null,
            "total_network_bandwidth": 12000,
            "total_volume_bandwidth": 4000,
            "user_data": "#!/bin/bash\n\nsubscription-manager release --set=8\nsubscription-manager repos --disable='*eus*'\n\ncat \u003c\u003c'STOPP' | tee /tmp/attachHost.sh\n#!/usr/bin/env bash\ncat \u003c\u003c 'HERE' \u003e\u003e/usr/local/bin/ibm-host-attach.sh\n#!/usr/bin/env bash\nset -ex\nmkdir -p /etc/satelliteflags\nHOST_ASSIGN_FLAG=\"/etc/satelliteflags/hostattachflag\"\nif [[ -f \"$HOST_ASSIGN_FLAG\" ]]; then\n\techo \"host has already been assigned. need to reload before you try the attach again\"\n\texit 0\nfi\nset +x\nHOST_QUEUE_TOKEN=\"9f75cd5f618da970de4d6ba7b1eec08bc74ed3dc317881ce8af00c3e34429bec2a3d324dcbd6be3b129fe9e510fd348b7ab95c805b442944db7006c81d170a5a49d20c52bdabc6b6eb2acfe6b79ad6cdb50d8587cec843f2f94c5a57a2f95e089bcfecb0d681af4dede4143b29a64a91d014e6453a5af30e92a48e809d628f001008a8695381ba204f444211e9c6c925218bb97f64c03dea3588f7721114db4f8d2834508b12b1eb9691fd19e4d2412ec52a2e7955e538c7d8c6077d46b9c11fbad7eef398475825ce8b611439c3b1d71eebc6db619fe8951d26a5a6c66bce183c0c729e1cfea9c46f690a6e0c18096eb375c2812418b7c23cacb2c7365e8e8a\"\nset -x\nACCOUNT_ID=\"b77832f89c084e1d994ec9ae8e1bce0e\"\nCONTROLLER_ID=\"cjjme7lw0k8v5b0qob9g\"\nSELECTOR_LABELS='{}'\nAPI_URL=\"https://origin.us-east.containers.cloud.ibm.com/\"\nREGION=\"us-east\"\n\nexport HOST_QUEUE_TOKEN\nexport ACCOUNT_ID\nexport CONTROLLER_ID\nexport REGION\n\n#shutdown known blacklisted services for Satellite (these will break kube)\nset +e\nsystemctl stop -f iptables.service\nsystemctl disable iptables.service\nsystemctl mask iptables.service\nsystemctl stop -f firewalld.service\nsystemctl disable firewalld.service\nsystemctl mask firewalld.service\nset -e\n\n# ensure you can successfully communicate with redhat mirrors (this is a prereq to the rest of the automation working)\nif [[ $(grep -ic \"maipo\" \u003c /etc/redhat-release) -ne 0 ]]; then\n\t#RHEL 7\n\tOPERATING_SYSTEM=\"RHEL7\"\nelif [[ $(grep -ic \"ootpa\" \u003c /etc/redhat-release) -ne 0 ]]; then\n\t#RHEL 8\n\tOPERATING_SYSTEM=\"RHEL8\"\nelif grep -qi \"coreos\" \u003c /etc/redhat-release; then\n\tOPERATING_SYSTEM=\"RHCOS\"\nelse\n\tOPERATING_SYSTEM=\"UNKNOWN\"\nfi\n\nif [[ \"${OPERATING_SYSTEM}\" != \"RHEL7\" \u0026\u0026 \"${OPERATING_SYSTEM}\" != \"RHEL8\" ]]; then\n\techo \"This script is only intended to run with a RHEL7 or RHEL8 operating system. Current operating system ${OPERATING_SYSTEM}.\"\n\texit 1\nfi\nexport OPERATING_SYSTEM\n\nsubscription-manager refresh\nif [[ \"${OPERATING_SYSTEM}\" == \"RHEL7\" ]]; then\n\tsubscription-manager repos --enable rhel-server-rhscl-7-rpms\n\tsubscription-manager repos --enable rhel-7-server-optional-rpms\n\tsubscription-manager repos --enable rhel-7-server-rh-common-rpms\n\tsubscription-manager repos --enable rhel-7-server-supplementary-rpms\n\tsubscription-manager repos --enable rhel-7-server-extras-rpms\nelif [[ \"${OPERATING_SYSTEM}\" == \"RHEL8\" ]]; then\n\tsubscription-manager release --set=8\n\tsubscription-manager repos --disable='*eus*'\n\tsubscription-manager repos --enable rhel-8-for-x86_64-baseos-rpms \n\tsubscription-manager repos --enable rhel-8-for-x86_64-appstream-rpms;\nfi\nyum install container-selinux -y\n\n\nif [[ \"${OPERATING_SYSTEM}\" == \"RHEL7\" ]]; then\n\tyum install rh-python36 -y\n\t# shellcheck disable=SC1091\n\tsource /opt/rh/rh-python36/enable\nelif [[ \"${OPERATING_SYSTEM}\" == \"RHEL8\" ]]; then\n\tyum install python39 -y\nfi\n\nmkdir -p /etc/satellitemachineidgeneration\nif [[ ! -f /etc/satellitemachineidgeneration/machineidgenerated ]]; then\n    rm -f /etc/machine-id\n    systemd-machine-id-setup\n    if openssl rand -hex 16; then\n      openssl rand -hex 16 \u003e /etc/machine-id\n    fi\n    touch /etc/satellitemachineidgeneration/machineidgenerated\nfi\n#STEP 1: GATHER INFORMATION THAT WILL BE USED TO REGISTER THE HOST\nHOSTNAME=$(hostname -s)\nHOSTNAME=${HOSTNAME,,}\nMACHINE_ID=$(cat /etc/machine-id)\nCPUS=$(nproc)\nMEMORY=$(grep MemTotal /proc/meminfo | awk '{print $2}')\nexport CPUS\nexport MEMORY\n\nif [[ \"${OPERATING_SYSTEM}\" != \"RHEL7\" \u0026\u0026 \"${OPERATING_SYSTEM}\" != \"RHEL8\" ]]; then\n  echo \"This script is only intended to run with a RHEL7 or RHEL8 operating system. Current operating system ${OPERATING_SYSTEM}. Going to continue on for backwards compatibility\"\nfi\n\nSELECTOR_LABELS=$(echo \"${SELECTOR_LABELS}\" | python3 -c \"import sys, json, os; z = json.load(sys.stdin); y = {\\\"cpu\\\": os.getenv('CPUS'), \\\"memory\\\": os.getenv('MEMORY'), \\\"os\\\": os.getenv('OPERATING_SYSTEM')}; z.update(y); print(json.dumps(z))\")\n\nset +e\nexport ZONE=\"\"\nexport PROVIDER=\"\"\nexport TOKEN=\"\"\necho \"Probing for AWS metadata\"\ngather_aws_token() {\n\tHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 -X PUT \"http://169.254.169.254/latest/api/token\" -H \"X-aws-ec2-metadata-token-ttl-seconds: 21600\")\n\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\techo \"bad return code\"\n\t\treturn 1\n\tfi\n\tif [[ -z \"$HTTP_BODY\" ]]; then\n\t\techo \"no token found\"\n\t\treturn 1\n\tfi\n\techo \"found aws access token\"\n\tTOKEN=\"$HTTP_BODY\"\n}\ngather_zone_info() {\n\tHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 -H \"X-aws-ec2-metadata-token: $TOKEN\" http://169.254.169.254/latest/meta-data/placement/availability-zone)\n\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\t# if a 401 retry without auth\n\tif [[ \"$HTTP_STATUS\" -eq 401 ]]; then\n\t\techo \"unable to get aws metadata with v2 metadata service, trying v1...\"\n\t\tHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 http://169.254.169.254/latest/meta-data/placement/availability-zone)\n\t\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\t\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\tfi\n\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\techo \"bad return code\"\n\t\treturn 1\n\tfi\n\tif [[ \"$HTTP_BODY\" =~ [^a-zA-Z0-9-] ]]; then\n\t\techo \"invalid zone format\"\n\t\treturn 1\n\tfi\n\tZONE=\"$HTTP_BODY\"\n}\ngather_aws_info() {\n    if ! gather_aws_token; then\n        return 1\n    fi\n    if ! gather_zone_info; then\n        return 1\n    fi\n}\nif gather_aws_info; then\n\techo \"aws metadata detected\"\n\tPROVIDER=\"aws\"\nfi\nif [[ -z \"$ZONE\" ]]; then\n\techo \"echo Probing for Azure Metadata\"\n\texport LOCATION_INFO=\"\"\n\texport AZURE_ZONE_NUMBER_INFO=\"\"\n\tgather_location_info() {\n\t\tHTTP_RESPONSE=$(curl -H Metadata:true --noproxy \"*\" --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 \"http://169.254.169.254/metadata/instance/compute/location?api-version=2021-01-01\u0026format=text\")\n\t\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\t\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\t\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\t\techo \"bad return code\"\n\t\t\treturn 1\n\t\tfi\n\t\tif [[ \"$HTTP_BODY\" =~ [^a-zA-Z0-9-] ]]; then\n\t\t\techo \"invalid format\"\n\t\t\treturn 1\n\t\tfi\n\t\tLOCATION_INFO=\"$HTTP_BODY\"\n\t}\n\tgather_azure_zone_number_info() {\n\t\tHTTP_RESPONSE=$(curl -H Metadata:true --noproxy \"*\" --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 \"http://169.254.169.254/metadata/instance/compute/zone?api-version=2021-01-01\u0026format=text\")\n\t\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\t\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\t\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\t\techo \"bad return code\"\n\t\t\treturn 1\n\t\tfi\n\t\tif [[ \"$HTTP_BODY\" =~ [^a-zA-Z0-9-] ]]; then\n\t\t\techo \"invalid format\"\n\t\t\treturn 1\n\t\tfi\n\t\tAZURE_ZONE_NUMBER_INFO=\"$HTTP_BODY\"\n\t}\n\tgather_zone_info() {\n\t\tif ! gather_location_info; then\n\t\t\treturn 1\n\t\tfi\n\t\tif ! gather_azure_zone_number_info; then\n\t\t\treturn 1\n\t\tfi\n\t\tif [[ -n \"$AZURE_ZONE_NUMBER_INFO\" ]]; then\n\t\t  ZONE=\"${LOCATION_INFO}-${AZURE_ZONE_NUMBER_INFO}\"\n\t\telse\n\t\t  ZONE=\"${LOCATION_INFO}\"\n\t\tfi\n\t}\n\tif gather_zone_info; then\n\t\techo \"azure metadata detected\"\n\t\tPROVIDER=\"azure\"\n\tfi\nfi\nif [[ -z \"$ZONE\" ]]; then\n\techo \"echo Probing for GCP Metadata\"\n\tgather_zone_info() {\n\t\tHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 \"http://metadata.google.internal/computeMetadata/v1/instance/zone\" -H \"Metadata-Flavor: Google\")\n\t\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\t\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\t\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\t\techo \"bad return code\"\n\t\t\treturn 1\n\t\tfi\n\t\tPOTENTIAL_ZONE_RESPONSE=$(echo \"$HTTP_BODY\" | awk -F '/' '{print $NF}')\n\t\tif [[ \"$POTENTIAL_ZONE_RESPONSE\" =~ [^a-zA-Z0-9-] ]]; then\n\t\t\techo \"invalid zone format\"\n\t\t\treturn 1\n\t\tfi\n\t\tZONE=\"$POTENTIAL_ZONE_RESPONSE\"\n\t}\n\tif gather_zone_info; then\n\t\techo \"gcp metadata detected\"\n\t\tPROVIDER=\"google\"\n\tfi\nfi\nset -e\nif [[ -n \"$ZONE\" ]]; then\n\tSELECTOR_LABELS=$(echo \"${SELECTOR_LABELS}\" | python3 -c \"import sys, json, os; z = json.load(sys.stdin); y = {\\\"zone\\\": os.getenv('ZONE')}; z.update(y); print(json.dumps(z))\")\nfi\nif [[ -n \"$PROVIDER\" ]]; then\n\tSELECTOR_LABELS=$(echo \"${SELECTOR_LABELS}\" | python3 -c \"import sys, json, os; z = json.load(sys.stdin); y = {\\\"provider\\\": os.getenv('PROVIDER')}; z.update(y); print(json.dumps(z))\")\nfi\n#Step 2: SETUP METADATA\ncat \u003c\u003cEOF \u003eregister.json\n{\n\"controller\": \"$CONTROLLER_ID\",\n\"name\": \"$HOSTNAME\",\n\"identifier\": \"$MACHINE_ID\",\n\"labels\": $SELECTOR_LABELS\n}\nEOF\n\nset +e\n#try to download and run host health check script\nset +x\n#first try to the satellite-health service is enabled\nHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --retry 5 --retry-delay 10 --retry-max-time 60 \\\n        \"${API_URL}satellite-health/api/v1/hello\")\nset -x\nHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\nHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\necho \"$HTTP_STATUS\"\nif [[ \"$HTTP_STATUS\" -eq 200 ]]; then\n        set +x\n        HTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --retry 20 --retry-delay 10 --retry-max-time 360 \\\n                \"${API_URL}satellite-health/sat-host-check\" -o /usr/local/bin/sat-host-check)\n        set -x\n        HTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n        HTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n        echo \"$HTTP_BODY\"\n        echo \"$HTTP_STATUS\"\n        if [[ \"$HTTP_STATUS\" -eq 200 ]]; then\n                chmod +x /usr/local/bin/sat-host-check\n                set +x\n                timeout 5m /usr/local/bin/sat-host-check --region $REGION  --endpoint $API_URL\n                set -x\n        else\n                echo \"Error downloading host health check script [HTTP status: $HTTP_STATUS]\"\n        fi\nelse\n        echo \"Skipping downloading host health check script [HTTP status: $HTTP_STATUS]\"\nfi\nset -e\n\nset +x\n#STEP 3: REGISTER HOST TO THE HOSTQUEUE. NEED TO EVALUATE HTTP STATUS 409 EXISTS, 201 created. ALL OTHERS FAIL.\nHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --retry 100 --retry-delay 10 --retry-max-time 1800 -X POST \\\n\t-H \"X-Auth-Hostqueue-APIKey: $HOST_QUEUE_TOKEN\" \\\n\t-H \"X-Auth-Hostqueue-Account: $ACCOUNT_ID\" \\\n\t-H \"Content-Type: application/json\" \\\n\t-d @register.json \\\n\t\"${API_URL}v2/multishift/hostqueue/host/register\")\nset -x\nHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\nHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\necho \"$HTTP_BODY\"\necho \"$HTTP_STATUS\"\nif [[ \"$HTTP_STATUS\" -ne 201 ]]; then\n\techo \"Error [HTTP status: $HTTP_STATUS]\"\n\texit 1\nfi\n\nHOST_ID=$(echo \"$HTTP_BODY\" | python3 -c \"import sys, json; print(json.load(sys.stdin)['id'])\")\n\n#STEP 4: WAIT FOR MEMBERSHIP TO BE ASSIGNED\nwhile true; do\n\tset +ex\n\tASSIGNMENT=$(curl --retry 100 --retry-delay 10 --retry-max-time 1800 -G -X GET \\\n\t\t-H \"X-Auth-Hostqueue-APIKey: $HOST_QUEUE_TOKEN\" \\\n\t\t-H \"X-Auth-Hostqueue-Account: $ACCOUNT_ID\" \\\n\t\t-d controllerID=\"$CONTROLLER_ID\" \\\n\t\t-d hostID=\"$HOST_ID\" \\\n\t\t\"${API_URL}v2/multishift/hostqueue/host/getAssignment\")\n\tset -ex\n\tisAssigned=$(echo \"$ASSIGNMENT\" | python3 -c \"import sys, json; print(json.load(sys.stdin)['isAssigned'])\" | awk '{print tolower($0)}')\n\tif [[ \"$isAssigned\" == \"true\" ]]; then\n\t\tbreak\n\tfi\n\tif [[ \"$isAssigned\" != \"false\" ]]; then\n\t\techo \"unexpected value for assign retrying\"\n\tfi\n\tsleep 10\ndone\n\n#STEP 5: ASSIGNMENT HAS BEEN MADE. SAVE SCRIPT AND RUN\necho \"$ASSIGNMENT\" | python3 -c \"import sys, json; print(json.load(sys.stdin)['script'])\" \u003e/usr/local/bin/ibm-host-agent.sh\nexport HOST_ID\nASSIGNMENT_ID=$(echo \"$ASSIGNMENT\" | python3 -c \"import sys, json; print(json.load(sys.stdin)['id'])\")\ncat \u003c\u003cEOF \u003e/etc/satelliteflags/ibm-host-agent-vars\nexport HOST_ID=${HOST_ID}\nexport ASSIGNMENT_ID=${ASSIGNMENT_ID}\nEOF\nchmod 0600 /etc/satelliteflags/ibm-host-agent-vars\nchmod 0700 /usr/local/bin/ibm-host-agent.sh\ncat \u003c\u003cEOF \u003e/etc/systemd/system/ibm-host-agent.service\n[Unit]\nDescription=IBM Host Agent Service\nAfter=network.target\n\n[Service]\nEnvironment=\"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"\nExecStart=/usr/local/bin/ibm-host-agent.sh\nRestart=on-failure\nRestartSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\nchmod 0644 /etc/systemd/system/ibm-host-agent.service\nsystemctl daemon-reload\nsystemctl start ibm-host-agent.service\ntouch \"$HOST_ASSIGN_FLAG\"\nHERE\n\nchmod 0700 /usr/local/bin/ibm-host-attach.sh\ncat \u003c\u003c 'EOF' \u003e/etc/systemd/system/ibm-host-attach.service\n[Unit]\nDescription=IBM Host Attach Service\nAfter=network.target\n\n[Service]\nEnvironment=\"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"\nExecStart=/usr/local/bin/ibm-host-attach.sh\nRestart=on-failure\nRestartSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\nchmod 0644 /etc/systemd/system/ibm-host-attach.service\nsystemctl daemon-reload\nsystemctl enable ibm-host-attach.service\nsystemctl start ibm-host-attach.service\n\nSTOPP\n\nsudo nohup bash /tmp/attachHost.sh \u0026\n\n",
            "vcpu": [
              {
                "architecture": "amd64",
                "count": 8
              }
            ],
            "volume_attachments": [
              {
                "id": "0767-c81c3b0f-0acf-48ea-94c7-1bd3c9383d57",
                "name": "saddle-cranial-yin-glance",
                "volume_crn": "crn:v1:bluemix:public:is:us-east-2:a/b77832f89c084e1d994ec9ae8e1bce0e::volume:r014-cad2403b-9b3c-46c6-b405-afc21cd9a5e2",
                "volume_id": "r014-cad2403b-9b3c-46c6-b405-afc21cd9a5e2",
                "volume_name": "jurist-halved-splicing-primp"
              }
            ],
            "volumes": null,
            "vpc": "r014-3b20e91d-b51d-47bf-8fd9-9c26cb716073",
            "wait_before_delete": true,
            "zone": "us-east-2"
          },
          "sensitive_attributes": [],
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjoxODAwMDAwMDAwMDAwLCJkZWxldGUiOjE4MDAwMDAwMDAwMDAsInVwZGF0ZSI6MTgwMDAwMDAwMDAwMH19",
          "dependencies": [
            "module.control_plane.data.ibm_is_image.host",
            "module.control_plane.data.ibm_is_ssh_key.existing",
            "module.location.data.ibm_satellite_attach_host_script.script",
            "module.location.data.ibm_satellite_location.location",
            "module.location.ibm_is_security_group.location_security_group",
            "module.location.ibm_is_subnet.location_subnet_zone",
            "module.location.ibm_is_vpc.location_vpc",
            "module.location.ibm_satellite_location.create_location"
          ]
        },
        {
          "index_key": 2,
          "schema_version": 0,
          "attributes": {
            "access_tags": [],
            "action": null,
            "auto_delete_volume": null,
            "availability_policy_host_failure": "restart",
            "bandwidth": 16000,
            "boot_volume": [
              {
                "auto_delete_volume": true,
                "encryption": "",
                "iops": 3000,
                "name": "upbeat-unripe-squint-disclose",
                "profile": "general-purpose",
                "size": 100,
                "snapshot": "",
                "tags": [],
                "volume_id": "r014-f5c5839c-7c89-4fea-9229-e9c2fc5b6bdb"
              }
            ],
            "catalog_offering": [],
            "crn": "crn:v1:bluemix:public:is:us-east-3:a/b77832f89c084e1d994ec9ae8e1bce0e::instance:0777_3098871f-e2e5-4f6a-b4ed-9141ff57eca0",
            "dedicated_host": null,
            "dedicated_host_group": null,
            "default_trusted_profile_auto_link": null,
            "default_trusted_profile_target": null,
            "disks": [],
            "force_action": false,
            "force_recovery_time": null,
            "gpu": [],
            "id": "0777_3098871f-e2e5-4f6a-b4ed-9141ff57eca0",
            "image": "r014-f0e1d733-f981-445a-ae66-de7a59f11e25",
            "instance_template": null,
            "keys": [
              "r014-c0c9915b-a1e6-4fd4-9e0c-6ad37eaab759"
            ],
            "lifecycle_reasons": [],
            "lifecycle_state": "stable",
            "memory": 32,
            "metadata_service_enabled": false,
            "name": "gs-satellite-ibm1-cp-03",
            "network_interfaces": [],
            "placement_group": null,
            "placement_target": [],
            "primary_network_interface": [
              {
                "allow_ip_spoofing": false,
                "id": "0777-b8bf7590-a656-47e9-a015-15a2b6820244",
                "name": "eth0",
                "port_speed": 12000,
                "primary_ip": [
                  {
                    "address": "10.241.128.4",
                    "auto_delete": true,
                    "href": "https://us-east.iaas.cloud.ibm.com/v1/subnets/0777-aa5ce777-4fda-4ff5-9fa0-1b872e35ef2e/reserved_ips/0777-b797d430-8a9f-4c7a-aeb5-8ac34fa7f42f",
                    "name": "sandfish-masses-carefully-savanna",
                    "reserved_ip": "0777-b797d430-8a9f-4c7a-aeb5-8ac34fa7f42f",
                    "resource_type": "subnet_reserved_ip"
                  }
                ],
                "primary_ipv4_address": "10.241.128.4",
                "security_groups": [
                  "r014-736bc133-3b71-4d7f-b3c1-c52ef26e626a"
                ],
                "subnet": "0777-aa5ce777-4fda-4ff5-9fa0-1b872e35ef2e"
              }
            ],
            "profile": "bx2-8x32",
            "resource_controller_url": "https://cloud.ibm.com/vpc-ext/compute/vs",
            "resource_crn": "crn:v1:bluemix:public:is:us-east-3:a/b77832f89c084e1d994ec9ae8e1bce0e::instance:0777_3098871f-e2e5-4f6a-b4ed-9141ff57eca0",
            "resource_group": "5b9d354ad44b4698aca47651741f47d3",
            "resource_group_name": "Default",
            "resource_name": "gs-satellite-ibm1-cp-03",
            "resource_status": "running",
            "status": "running",
            "status_reasons": [],
            "tags": [],
            "timeouts": null,
            "total_network_bandwidth": 12000,
            "total_volume_bandwidth": 4000,
            "user_data": "#!/bin/bash\n\nsubscription-manager release --set=8\nsubscription-manager repos --disable='*eus*'\n\ncat \u003c\u003c'STOPP' | tee /tmp/attachHost.sh\n#!/usr/bin/env bash\ncat \u003c\u003c 'HERE' \u003e\u003e/usr/local/bin/ibm-host-attach.sh\n#!/usr/bin/env bash\nset -ex\nmkdir -p /etc/satelliteflags\nHOST_ASSIGN_FLAG=\"/etc/satelliteflags/hostattachflag\"\nif [[ -f \"$HOST_ASSIGN_FLAG\" ]]; then\n\techo \"host has already been assigned. need to reload before you try the attach again\"\n\texit 0\nfi\nset +x\nHOST_QUEUE_TOKEN=\"9f75cd5f618da970de4d6ba7b1eec08bc74ed3dc317881ce8af00c3e34429bec2a3d324dcbd6be3b129fe9e510fd348b7ab95c805b442944db7006c81d170a5a49d20c52bdabc6b6eb2acfe6b79ad6cdb50d8587cec843f2f94c5a57a2f95e089bcfecb0d681af4dede4143b29a64a91d014e6453a5af30e92a48e809d628f001008a8695381ba204f444211e9c6c925218bb97f64c03dea3588f7721114db4f8d2834508b12b1eb9691fd19e4d2412ec52a2e7955e538c7d8c6077d46b9c11fbad7eef398475825ce8b611439c3b1d71eebc6db619fe8951d26a5a6c66bce183c0c729e1cfea9c46f690a6e0c18096eb375c2812418b7c23cacb2c7365e8e8a\"\nset -x\nACCOUNT_ID=\"b77832f89c084e1d994ec9ae8e1bce0e\"\nCONTROLLER_ID=\"cjjme7lw0k8v5b0qob9g\"\nSELECTOR_LABELS='{}'\nAPI_URL=\"https://origin.us-east.containers.cloud.ibm.com/\"\nREGION=\"us-east\"\n\nexport HOST_QUEUE_TOKEN\nexport ACCOUNT_ID\nexport CONTROLLER_ID\nexport REGION\n\n#shutdown known blacklisted services for Satellite (these will break kube)\nset +e\nsystemctl stop -f iptables.service\nsystemctl disable iptables.service\nsystemctl mask iptables.service\nsystemctl stop -f firewalld.service\nsystemctl disable firewalld.service\nsystemctl mask firewalld.service\nset -e\n\n# ensure you can successfully communicate with redhat mirrors (this is a prereq to the rest of the automation working)\nif [[ $(grep -ic \"maipo\" \u003c /etc/redhat-release) -ne 0 ]]; then\n\t#RHEL 7\n\tOPERATING_SYSTEM=\"RHEL7\"\nelif [[ $(grep -ic \"ootpa\" \u003c /etc/redhat-release) -ne 0 ]]; then\n\t#RHEL 8\n\tOPERATING_SYSTEM=\"RHEL8\"\nelif grep -qi \"coreos\" \u003c /etc/redhat-release; then\n\tOPERATING_SYSTEM=\"RHCOS\"\nelse\n\tOPERATING_SYSTEM=\"UNKNOWN\"\nfi\n\nif [[ \"${OPERATING_SYSTEM}\" != \"RHEL7\" \u0026\u0026 \"${OPERATING_SYSTEM}\" != \"RHEL8\" ]]; then\n\techo \"This script is only intended to run with a RHEL7 or RHEL8 operating system. Current operating system ${OPERATING_SYSTEM}.\"\n\texit 1\nfi\nexport OPERATING_SYSTEM\n\nsubscription-manager refresh\nif [[ \"${OPERATING_SYSTEM}\" == \"RHEL7\" ]]; then\n\tsubscription-manager repos --enable rhel-server-rhscl-7-rpms\n\tsubscription-manager repos --enable rhel-7-server-optional-rpms\n\tsubscription-manager repos --enable rhel-7-server-rh-common-rpms\n\tsubscription-manager repos --enable rhel-7-server-supplementary-rpms\n\tsubscription-manager repos --enable rhel-7-server-extras-rpms\nelif [[ \"${OPERATING_SYSTEM}\" == \"RHEL8\" ]]; then\n\tsubscription-manager release --set=8\n\tsubscription-manager repos --disable='*eus*'\n\tsubscription-manager repos --enable rhel-8-for-x86_64-baseos-rpms \n\tsubscription-manager repos --enable rhel-8-for-x86_64-appstream-rpms;\nfi\nyum install container-selinux -y\n\n\nif [[ \"${OPERATING_SYSTEM}\" == \"RHEL7\" ]]; then\n\tyum install rh-python36 -y\n\t# shellcheck disable=SC1091\n\tsource /opt/rh/rh-python36/enable\nelif [[ \"${OPERATING_SYSTEM}\" == \"RHEL8\" ]]; then\n\tyum install python39 -y\nfi\n\nmkdir -p /etc/satellitemachineidgeneration\nif [[ ! -f /etc/satellitemachineidgeneration/machineidgenerated ]]; then\n    rm -f /etc/machine-id\n    systemd-machine-id-setup\n    if openssl rand -hex 16; then\n      openssl rand -hex 16 \u003e /etc/machine-id\n    fi\n    touch /etc/satellitemachineidgeneration/machineidgenerated\nfi\n#STEP 1: GATHER INFORMATION THAT WILL BE USED TO REGISTER THE HOST\nHOSTNAME=$(hostname -s)\nHOSTNAME=${HOSTNAME,,}\nMACHINE_ID=$(cat /etc/machine-id)\nCPUS=$(nproc)\nMEMORY=$(grep MemTotal /proc/meminfo | awk '{print $2}')\nexport CPUS\nexport MEMORY\n\nif [[ \"${OPERATING_SYSTEM}\" != \"RHEL7\" \u0026\u0026 \"${OPERATING_SYSTEM}\" != \"RHEL8\" ]]; then\n  echo \"This script is only intended to run with a RHEL7 or RHEL8 operating system. Current operating system ${OPERATING_SYSTEM}. Going to continue on for backwards compatibility\"\nfi\n\nSELECTOR_LABELS=$(echo \"${SELECTOR_LABELS}\" | python3 -c \"import sys, json, os; z = json.load(sys.stdin); y = {\\\"cpu\\\": os.getenv('CPUS'), \\\"memory\\\": os.getenv('MEMORY'), \\\"os\\\": os.getenv('OPERATING_SYSTEM')}; z.update(y); print(json.dumps(z))\")\n\nset +e\nexport ZONE=\"\"\nexport PROVIDER=\"\"\nexport TOKEN=\"\"\necho \"Probing for AWS metadata\"\ngather_aws_token() {\n\tHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 -X PUT \"http://169.254.169.254/latest/api/token\" -H \"X-aws-ec2-metadata-token-ttl-seconds: 21600\")\n\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\techo \"bad return code\"\n\t\treturn 1\n\tfi\n\tif [[ -z \"$HTTP_BODY\" ]]; then\n\t\techo \"no token found\"\n\t\treturn 1\n\tfi\n\techo \"found aws access token\"\n\tTOKEN=\"$HTTP_BODY\"\n}\ngather_zone_info() {\n\tHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 -H \"X-aws-ec2-metadata-token: $TOKEN\" http://169.254.169.254/latest/meta-data/placement/availability-zone)\n\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\t# if a 401 retry without auth\n\tif [[ \"$HTTP_STATUS\" -eq 401 ]]; then\n\t\techo \"unable to get aws metadata with v2 metadata service, trying v1...\"\n\t\tHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 http://169.254.169.254/latest/meta-data/placement/availability-zone)\n\t\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\t\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\tfi\n\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\techo \"bad return code\"\n\t\treturn 1\n\tfi\n\tif [[ \"$HTTP_BODY\" =~ [^a-zA-Z0-9-] ]]; then\n\t\techo \"invalid zone format\"\n\t\treturn 1\n\tfi\n\tZONE=\"$HTTP_BODY\"\n}\ngather_aws_info() {\n    if ! gather_aws_token; then\n        return 1\n    fi\n    if ! gather_zone_info; then\n        return 1\n    fi\n}\nif gather_aws_info; then\n\techo \"aws metadata detected\"\n\tPROVIDER=\"aws\"\nfi\nif [[ -z \"$ZONE\" ]]; then\n\techo \"echo Probing for Azure Metadata\"\n\texport LOCATION_INFO=\"\"\n\texport AZURE_ZONE_NUMBER_INFO=\"\"\n\tgather_location_info() {\n\t\tHTTP_RESPONSE=$(curl -H Metadata:true --noproxy \"*\" --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 \"http://169.254.169.254/metadata/instance/compute/location?api-version=2021-01-01\u0026format=text\")\n\t\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\t\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\t\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\t\techo \"bad return code\"\n\t\t\treturn 1\n\t\tfi\n\t\tif [[ \"$HTTP_BODY\" =~ [^a-zA-Z0-9-] ]]; then\n\t\t\techo \"invalid format\"\n\t\t\treturn 1\n\t\tfi\n\t\tLOCATION_INFO=\"$HTTP_BODY\"\n\t}\n\tgather_azure_zone_number_info() {\n\t\tHTTP_RESPONSE=$(curl -H Metadata:true --noproxy \"*\" --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 \"http://169.254.169.254/metadata/instance/compute/zone?api-version=2021-01-01\u0026format=text\")\n\t\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\t\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\t\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\t\techo \"bad return code\"\n\t\t\treturn 1\n\t\tfi\n\t\tif [[ \"$HTTP_BODY\" =~ [^a-zA-Z0-9-] ]]; then\n\t\t\techo \"invalid format\"\n\t\t\treturn 1\n\t\tfi\n\t\tAZURE_ZONE_NUMBER_INFO=\"$HTTP_BODY\"\n\t}\n\tgather_zone_info() {\n\t\tif ! gather_location_info; then\n\t\t\treturn 1\n\t\tfi\n\t\tif ! gather_azure_zone_number_info; then\n\t\t\treturn 1\n\t\tfi\n\t\tif [[ -n \"$AZURE_ZONE_NUMBER_INFO\" ]]; then\n\t\t  ZONE=\"${LOCATION_INFO}-${AZURE_ZONE_NUMBER_INFO}\"\n\t\telse\n\t\t  ZONE=\"${LOCATION_INFO}\"\n\t\tfi\n\t}\n\tif gather_zone_info; then\n\t\techo \"azure metadata detected\"\n\t\tPROVIDER=\"azure\"\n\tfi\nfi\nif [[ -z \"$ZONE\" ]]; then\n\techo \"echo Probing for GCP Metadata\"\n\tgather_zone_info() {\n\t\tHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 \"http://metadata.google.internal/computeMetadata/v1/instance/zone\" -H \"Metadata-Flavor: Google\")\n\t\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\t\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\t\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\t\techo \"bad return code\"\n\t\t\treturn 1\n\t\tfi\n\t\tPOTENTIAL_ZONE_RESPONSE=$(echo \"$HTTP_BODY\" | awk -F '/' '{print $NF}')\n\t\tif [[ \"$POTENTIAL_ZONE_RESPONSE\" =~ [^a-zA-Z0-9-] ]]; then\n\t\t\techo \"invalid zone format\"\n\t\t\treturn 1\n\t\tfi\n\t\tZONE=\"$POTENTIAL_ZONE_RESPONSE\"\n\t}\n\tif gather_zone_info; then\n\t\techo \"gcp metadata detected\"\n\t\tPROVIDER=\"google\"\n\tfi\nfi\nset -e\nif [[ -n \"$ZONE\" ]]; then\n\tSELECTOR_LABELS=$(echo \"${SELECTOR_LABELS}\" | python3 -c \"import sys, json, os; z = json.load(sys.stdin); y = {\\\"zone\\\": os.getenv('ZONE')}; z.update(y); print(json.dumps(z))\")\nfi\nif [[ -n \"$PROVIDER\" ]]; then\n\tSELECTOR_LABELS=$(echo \"${SELECTOR_LABELS}\" | python3 -c \"import sys, json, os; z = json.load(sys.stdin); y = {\\\"provider\\\": os.getenv('PROVIDER')}; z.update(y); print(json.dumps(z))\")\nfi\n#Step 2: SETUP METADATA\ncat \u003c\u003cEOF \u003eregister.json\n{\n\"controller\": \"$CONTROLLER_ID\",\n\"name\": \"$HOSTNAME\",\n\"identifier\": \"$MACHINE_ID\",\n\"labels\": $SELECTOR_LABELS\n}\nEOF\n\nset +e\n#try to download and run host health check script\nset +x\n#first try to the satellite-health service is enabled\nHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --retry 5 --retry-delay 10 --retry-max-time 60 \\\n        \"${API_URL}satellite-health/api/v1/hello\")\nset -x\nHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\nHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\necho \"$HTTP_STATUS\"\nif [[ \"$HTTP_STATUS\" -eq 200 ]]; then\n        set +x\n        HTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --retry 20 --retry-delay 10 --retry-max-time 360 \\\n                \"${API_URL}satellite-health/sat-host-check\" -o /usr/local/bin/sat-host-check)\n        set -x\n        HTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n        HTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n        echo \"$HTTP_BODY\"\n        echo \"$HTTP_STATUS\"\n        if [[ \"$HTTP_STATUS\" -eq 200 ]]; then\n                chmod +x /usr/local/bin/sat-host-check\n                set +x\n                timeout 5m /usr/local/bin/sat-host-check --region $REGION  --endpoint $API_URL\n                set -x\n        else\n                echo \"Error downloading host health check script [HTTP status: $HTTP_STATUS]\"\n        fi\nelse\n        echo \"Skipping downloading host health check script [HTTP status: $HTTP_STATUS]\"\nfi\nset -e\n\nset +x\n#STEP 3: REGISTER HOST TO THE HOSTQUEUE. NEED TO EVALUATE HTTP STATUS 409 EXISTS, 201 created. ALL OTHERS FAIL.\nHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --retry 100 --retry-delay 10 --retry-max-time 1800 -X POST \\\n\t-H \"X-Auth-Hostqueue-APIKey: $HOST_QUEUE_TOKEN\" \\\n\t-H \"X-Auth-Hostqueue-Account: $ACCOUNT_ID\" \\\n\t-H \"Content-Type: application/json\" \\\n\t-d @register.json \\\n\t\"${API_URL}v2/multishift/hostqueue/host/register\")\nset -x\nHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\nHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\necho \"$HTTP_BODY\"\necho \"$HTTP_STATUS\"\nif [[ \"$HTTP_STATUS\" -ne 201 ]]; then\n\techo \"Error [HTTP status: $HTTP_STATUS]\"\n\texit 1\nfi\n\nHOST_ID=$(echo \"$HTTP_BODY\" | python3 -c \"import sys, json; print(json.load(sys.stdin)['id'])\")\n\n#STEP 4: WAIT FOR MEMBERSHIP TO BE ASSIGNED\nwhile true; do\n\tset +ex\n\tASSIGNMENT=$(curl --retry 100 --retry-delay 10 --retry-max-time 1800 -G -X GET \\\n\t\t-H \"X-Auth-Hostqueue-APIKey: $HOST_QUEUE_TOKEN\" \\\n\t\t-H \"X-Auth-Hostqueue-Account: $ACCOUNT_ID\" \\\n\t\t-d controllerID=\"$CONTROLLER_ID\" \\\n\t\t-d hostID=\"$HOST_ID\" \\\n\t\t\"${API_URL}v2/multishift/hostqueue/host/getAssignment\")\n\tset -ex\n\tisAssigned=$(echo \"$ASSIGNMENT\" | python3 -c \"import sys, json; print(json.load(sys.stdin)['isAssigned'])\" | awk '{print tolower($0)}')\n\tif [[ \"$isAssigned\" == \"true\" ]]; then\n\t\tbreak\n\tfi\n\tif [[ \"$isAssigned\" != \"false\" ]]; then\n\t\techo \"unexpected value for assign retrying\"\n\tfi\n\tsleep 10\ndone\n\n#STEP 5: ASSIGNMENT HAS BEEN MADE. SAVE SCRIPT AND RUN\necho \"$ASSIGNMENT\" | python3 -c \"import sys, json; print(json.load(sys.stdin)['script'])\" \u003e/usr/local/bin/ibm-host-agent.sh\nexport HOST_ID\nASSIGNMENT_ID=$(echo \"$ASSIGNMENT\" | python3 -c \"import sys, json; print(json.load(sys.stdin)['id'])\")\ncat \u003c\u003cEOF \u003e/etc/satelliteflags/ibm-host-agent-vars\nexport HOST_ID=${HOST_ID}\nexport ASSIGNMENT_ID=${ASSIGNMENT_ID}\nEOF\nchmod 0600 /etc/satelliteflags/ibm-host-agent-vars\nchmod 0700 /usr/local/bin/ibm-host-agent.sh\ncat \u003c\u003cEOF \u003e/etc/systemd/system/ibm-host-agent.service\n[Unit]\nDescription=IBM Host Agent Service\nAfter=network.target\n\n[Service]\nEnvironment=\"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"\nExecStart=/usr/local/bin/ibm-host-agent.sh\nRestart=on-failure\nRestartSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\nchmod 0644 /etc/systemd/system/ibm-host-agent.service\nsystemctl daemon-reload\nsystemctl start ibm-host-agent.service\ntouch \"$HOST_ASSIGN_FLAG\"\nHERE\n\nchmod 0700 /usr/local/bin/ibm-host-attach.sh\ncat \u003c\u003c 'EOF' \u003e/etc/systemd/system/ibm-host-attach.service\n[Unit]\nDescription=IBM Host Attach Service\nAfter=network.target\n\n[Service]\nEnvironment=\"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"\nExecStart=/usr/local/bin/ibm-host-attach.sh\nRestart=on-failure\nRestartSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\nchmod 0644 /etc/systemd/system/ibm-host-attach.service\nsystemctl daemon-reload\nsystemctl enable ibm-host-attach.service\nsystemctl start ibm-host-attach.service\n\nSTOPP\n\nsudo nohup bash /tmp/attachHost.sh \u0026\n\n",
            "vcpu": [
              {
                "architecture": "amd64",
                "count": 8
              }
            ],
            "volume_attachments": [
              {
                "id": "0777-96895036-f519-45a2-b724-faacc32fb8d4",
                "name": "carport-protract-recite-making",
                "volume_crn": "crn:v1:bluemix:public:is:us-east-3:a/b77832f89c084e1d994ec9ae8e1bce0e::volume:r014-f5c5839c-7c89-4fea-9229-e9c2fc5b6bdb",
                "volume_id": "r014-f5c5839c-7c89-4fea-9229-e9c2fc5b6bdb",
                "volume_name": "upbeat-unripe-squint-disclose"
              }
            ],
            "volumes": null,
            "vpc": "r014-3b20e91d-b51d-47bf-8fd9-9c26cb716073",
            "wait_before_delete": true,
            "zone": "us-east-3"
          },
          "sensitive_attributes": [],
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjoxODAwMDAwMDAwMDAwLCJkZWxldGUiOjE4MDAwMDAwMDAwMDAsInVwZGF0ZSI6MTgwMDAwMDAwMDAwMH19",
          "dependencies": [
            "module.control_plane.data.ibm_is_image.host",
            "module.control_plane.data.ibm_is_ssh_key.existing",
            "module.location.data.ibm_satellite_attach_host_script.script",
            "module.location.data.ibm_satellite_location.location",
            "module.location.ibm_is_security_group.location_security_group",
            "module.location.ibm_is_subnet.location_subnet_zone",
            "module.location.ibm_is_vpc.location_vpc",
            "module.location.ibm_satellite_location.create_location"
          ]
        }
      ]
    },
    {
      "module": "module.customer",
      "mode": "data",
      "type": "ibm_is_image",
      "name": "host",
      "provider": "provider[\"registry.terraform.io/ibm-cloud/ibm\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "access_tags": [],
            "architecture": "amd64",
            "catalog_offering": [
              {
                "managed": false,
                "version": []
              }
            ],
            "checksum": "0cbcc7e6b9b50ca388ed8c1aace8caaf3d12c99d7a4275dc28e3e623cbcaa8c9",
            "crn": "crn:v1:bluemix:public:is:us-east:a/811f8abfbd32425597dc7ba40da98fa6::image:r014-f0e1d733-f981-445a-ae66-de7a59f11e25",
            "encryption": "none",
            "encryption_key": null,
            "id": "r014-f0e1d733-f981-445a-ae66-de7a59f11e25",
            "identifier": null,
            "name": "ibm-redhat-8-6-minimal-amd64-3",
            "os": "red-8-amd64",
            "source_volume": null,
            "status": "deprecated",
            "visibility": "public"
          },
          "sensitive_attributes": []
        }
      ]
    },
    {
      "module": "module.customer",
      "mode": "data",
      "type": "ibm_is_ssh_key",
      "name": "existing",
      "provider": "provider[\"registry.terraform.io/ibm-cloud/ibm\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "access_tags": [],
            "crn": "crn:v1:bluemix:public:is:us-east:a/b77832f89c084e1d994ec9ae8e1bce0e::key:r014-c0c9915b-a1e6-4fd4-9e0c-6ad37eaab759",
            "fingerprint": "SHA256:EWU+xb5ueLAR0Nvh556gaFeiUYNAa34SHe1+BKL/t2M",
            "id": "r014-c0c9915b-a1e6-4fd4-9e0c-6ad37eaab759",
            "length": 4096,
            "name": "gs-satellite-ibm-east1",
            "public_key": "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCSekyIYOJR39CXTQBsfQrwDmUaTIBP7WdWPifQ7wOc56SZm8MsVRZgtsBfOQ3AEMf31XOtuyenFC3oWdn5qEXt/YOAUTYKlmtsY+wY8pMgZ77opd0Fl7WzjUbAedkzvnLHRWhCyFCtsITo4jl8WGN/pEVDoeySv9LxNTJ9hafsfg8hwc3GB90xNRcFzCtm6GSp6y9FSsyTu9w0FRbkIF1FZT3Z7eoAfR4jblsUuy2OgtNlpcRcrTBuvY2sKSx+TLOVhO8Hp4bCWH4eNPVkEFoE+yFnowIYHVDMsm2Vvu0pYQ8n/skyPcXRwEKzWv4r20p5UVCT1BRtdxUsda+SgnECTVyOXyFBeGgkIY1zLYPttPfaonEOCmTP5SMS5ed9bz7fpowzRmuZ0MY2LcMXKeZW6GVyCycAnnq9ffBd/LLvq11sS82MI1+WQehJe2g22cqsZURDycrBYmav9UG4Kr00q0VzYb9JEYZTNKG5+MDzO7BLpyBD039tu7plQJpbT4z4KUWX3zuzUiR3Sgni7E28k5zqd77+Txcz36vqvnppCUtahGQf2Llz/4AiJUyZdpjNPzFob+6u+GvYAXFzuJGPiRAy3H9GJk56WWsTFyBlSNh1YnjRaQa3iIxjAuWPgO06EXXN+9bYqJqy4oo5MnsEor864bSMB+ZdmMw86sdeGQ==",
            "resource_controller_url": "https://cloud.ibm.com/vpc/compute/sshKeys",
            "resource_crn": "crn:v1:bluemix:public:is:us-east:a/b77832f89c084e1d994ec9ae8e1bce0e::key:r014-c0c9915b-a1e6-4fd4-9e0c-6ad37eaab759",
            "resource_group": null,
            "resource_group_name": "ea72d012571e4c3dabd4d52df09331bf",
            "resource_name": "gs-satellite-ibm-east1",
            "type": "rsa"
          },
          "sensitive_attributes": []
        }
      ]
    },
    {
      "module": "module.customer",
      "mode": "managed",
      "type": "ibm_is_floating_ip",
      "name": "location_hosts",
      "provider": "provider[\"registry.terraform.io/ibm-cloud/ibm\"]",
      "instances": []
    },
    {
      "module": "module.customer",
      "mode": "managed",
      "type": "ibm_is_instance",
      "name": "location_hosts",
      "provider": "provider[\"registry.terraform.io/ibm-cloud/ibm\"]",
      "instances": [
        {
          "index_key": 1,
          "schema_version": 0,
          "attributes": {
            "access_tags": [],
            "action": null,
            "auto_delete_volume": null,
            "availability_policy_host_failure": "restart",
            "bandwidth": 64000,
            "boot_volume": [
              {
                "auto_delete_volume": true,
                "encryption": "",
                "iops": 3000,
                "name": "amperage-elixir-thrift-slate",
                "profile": "general-purpose",
                "size": 100,
                "snapshot": "",
                "tags": [],
                "volume_id": "r014-2b1b5692-cbe1-42fb-88bd-9a22a6c84f79"
              }
            ],
            "catalog_offering": [],
            "crn": "crn:v1:bluemix:public:is:us-east-2:a/b77832f89c084e1d994ec9ae8e1bce0e::instance:0767_a2eda2c9-71a8-46fb-bb31-51dd102bfb24",
            "dedicated_host": null,
            "dedicated_host_group": null,
            "default_trusted_profile_auto_link": null,
            "default_trusted_profile_target": null,
            "disks": [],
            "force_action": false,
            "force_recovery_time": null,
            "gpu": [],
            "id": "0767_a2eda2c9-71a8-46fb-bb31-51dd102bfb24",
            "image": "r014-f0e1d733-f981-445a-ae66-de7a59f11e25",
            "instance_template": null,
            "keys": [
              "r014-c0c9915b-a1e6-4fd4-9e0c-6ad37eaab759"
            ],
            "lifecycle_reasons": [],
            "lifecycle_state": "stable",
            "memory": 128,
            "metadata_service_enabled": false,
            "name": "gs-satellite-ibm1-customer-02",
            "network_interfaces": [],
            "placement_group": null,
            "placement_target": [],
            "primary_network_interface": [
              {
                "allow_ip_spoofing": false,
                "id": "0767-3e33efed-ecfa-47ab-8ace-ae2fd031c047",
                "name": "eth0",
                "port_speed": 25000,
                "primary_ip": [
                  {
                    "address": "10.241.64.6",
                    "auto_delete": true,
                    "href": "https://us-east.iaas.cloud.ibm.com/v1/subnets/0767-a0afd690-b8d6-4bbb-ae5a-a8621eb21155/reserved_ips/0767-0c197413-9a2f-479a-81e3-4fca646bc147",
                    "name": "playmate-glucose-nanotech-auction",
                    "reserved_ip": "0767-0c197413-9a2f-479a-81e3-4fca646bc147",
                    "resource_type": "subnet_reserved_ip"
                  }
                ],
                "primary_ipv4_address": "10.241.64.6",
                "security_groups": [
                  "r014-736bc133-3b71-4d7f-b3c1-c52ef26e626a"
                ],
                "subnet": "0767-a0afd690-b8d6-4bbb-ae5a-a8621eb21155"
              }
            ],
            "profile": "bx2-32x128",
            "resource_controller_url": "https://cloud.ibm.com/vpc-ext/compute/vs",
            "resource_crn": "crn:v1:bluemix:public:is:us-east-2:a/b77832f89c084e1d994ec9ae8e1bce0e::instance:0767_a2eda2c9-71a8-46fb-bb31-51dd102bfb24",
            "resource_group": "5b9d354ad44b4698aca47651741f47d3",
            "resource_group_name": "Default",
            "resource_name": "gs-satellite-ibm1-customer-02",
            "resource_status": "running",
            "status": "running",
            "status_reasons": [],
            "tags": [],
            "timeouts": null,
            "total_network_bandwidth": 48000,
            "total_volume_bandwidth": 16000,
            "user_data": "#!/bin/bash\n\nsubscription-manager release --set=8\nsubscription-manager repos --disable='*eus*'\n\ncat \u003c\u003c'STOPP' | tee /tmp/attachHost.sh\n#!/usr/bin/env bash\ncat \u003c\u003c 'HERE' \u003e\u003e/usr/local/bin/ibm-host-attach.sh\n#!/usr/bin/env bash\nset -ex\nmkdir -p /etc/satelliteflags\nHOST_ASSIGN_FLAG=\"/etc/satelliteflags/hostattachflag\"\nif [[ -f \"$HOST_ASSIGN_FLAG\" ]]; then\n\techo \"host has already been assigned. need to reload before you try the attach again\"\n\texit 0\nfi\nset +x\nHOST_QUEUE_TOKEN=\"9f75cd5f618da970de4d6ba7b1eec08bc74ed3dc317881ce8af00c3e34429bec2a3d324dcbd6be3b129fe9e510fd348b7ab95c805b442944db7006c81d170a5a49d20c52bdabc6b6eb2acfe6b79ad6cdb50d8587cec843f2f94c5a57a2f95e089bcfecb0d681af4dede4143b29a64a91d014e6453a5af30e92a48e809d628f001008a8695381ba204f444211e9c6c925218bb97f64c03dea3588f7721114db4f8d2834508b12b1eb9691fd19e4d2412ec52a2e7955e538c7d8c6077d46b9c11fbad7eef398475825ce8b611439c3b1d71eebc6db619fe8951d26a5a6c66bce183c0c729e1cfea9c46f690a6e0c18096eb375c2812418b7c23cacb2c7365e8e8a\"\nset -x\nACCOUNT_ID=\"b77832f89c084e1d994ec9ae8e1bce0e\"\nCONTROLLER_ID=\"cjjme7lw0k8v5b0qob9g\"\nSELECTOR_LABELS='{}'\nAPI_URL=\"https://origin.us-east.containers.cloud.ibm.com/\"\nREGION=\"us-east\"\n\nexport HOST_QUEUE_TOKEN\nexport ACCOUNT_ID\nexport CONTROLLER_ID\nexport REGION\n\n#shutdown known blacklisted services for Satellite (these will break kube)\nset +e\nsystemctl stop -f iptables.service\nsystemctl disable iptables.service\nsystemctl mask iptables.service\nsystemctl stop -f firewalld.service\nsystemctl disable firewalld.service\nsystemctl mask firewalld.service\nset -e\n\n# ensure you can successfully communicate with redhat mirrors (this is a prereq to the rest of the automation working)\nif [[ $(grep -ic \"maipo\" \u003c /etc/redhat-release) -ne 0 ]]; then\n\t#RHEL 7\n\tOPERATING_SYSTEM=\"RHEL7\"\nelif [[ $(grep -ic \"ootpa\" \u003c /etc/redhat-release) -ne 0 ]]; then\n\t#RHEL 8\n\tOPERATING_SYSTEM=\"RHEL8\"\nelif grep -qi \"coreos\" \u003c /etc/redhat-release; then\n\tOPERATING_SYSTEM=\"RHCOS\"\nelse\n\tOPERATING_SYSTEM=\"UNKNOWN\"\nfi\n\nif [[ \"${OPERATING_SYSTEM}\" != \"RHEL7\" \u0026\u0026 \"${OPERATING_SYSTEM}\" != \"RHEL8\" ]]; then\n\techo \"This script is only intended to run with a RHEL7 or RHEL8 operating system. Current operating system ${OPERATING_SYSTEM}.\"\n\texit 1\nfi\nexport OPERATING_SYSTEM\n\nsubscription-manager refresh\nif [[ \"${OPERATING_SYSTEM}\" == \"RHEL7\" ]]; then\n\tsubscription-manager repos --enable rhel-server-rhscl-7-rpms\n\tsubscription-manager repos --enable rhel-7-server-optional-rpms\n\tsubscription-manager repos --enable rhel-7-server-rh-common-rpms\n\tsubscription-manager repos --enable rhel-7-server-supplementary-rpms\n\tsubscription-manager repos --enable rhel-7-server-extras-rpms\nelif [[ \"${OPERATING_SYSTEM}\" == \"RHEL8\" ]]; then\n\tsubscription-manager release --set=8\n\tsubscription-manager repos --disable='*eus*'\n\tsubscription-manager repos --enable rhel-8-for-x86_64-baseos-rpms \n\tsubscription-manager repos --enable rhel-8-for-x86_64-appstream-rpms;\nfi\nyum install container-selinux -y\n\n\nif [[ \"${OPERATING_SYSTEM}\" == \"RHEL7\" ]]; then\n\tyum install rh-python36 -y\n\t# shellcheck disable=SC1091\n\tsource /opt/rh/rh-python36/enable\nelif [[ \"${OPERATING_SYSTEM}\" == \"RHEL8\" ]]; then\n\tyum install python39 -y\nfi\n\nmkdir -p /etc/satellitemachineidgeneration\nif [[ ! -f /etc/satellitemachineidgeneration/machineidgenerated ]]; then\n    rm -f /etc/machine-id\n    systemd-machine-id-setup\n    if openssl rand -hex 16; then\n      openssl rand -hex 16 \u003e /etc/machine-id\n    fi\n    touch /etc/satellitemachineidgeneration/machineidgenerated\nfi\n#STEP 1: GATHER INFORMATION THAT WILL BE USED TO REGISTER THE HOST\nHOSTNAME=$(hostname -s)\nHOSTNAME=${HOSTNAME,,}\nMACHINE_ID=$(cat /etc/machine-id)\nCPUS=$(nproc)\nMEMORY=$(grep MemTotal /proc/meminfo | awk '{print $2}')\nexport CPUS\nexport MEMORY\n\nif [[ \"${OPERATING_SYSTEM}\" != \"RHEL7\" \u0026\u0026 \"${OPERATING_SYSTEM}\" != \"RHEL8\" ]]; then\n  echo \"This script is only intended to run with a RHEL7 or RHEL8 operating system. Current operating system ${OPERATING_SYSTEM}. Going to continue on for backwards compatibility\"\nfi\n\nSELECTOR_LABELS=$(echo \"${SELECTOR_LABELS}\" | python3 -c \"import sys, json, os; z = json.load(sys.stdin); y = {\\\"cpu\\\": os.getenv('CPUS'), \\\"memory\\\": os.getenv('MEMORY'), \\\"os\\\": os.getenv('OPERATING_SYSTEM')}; z.update(y); print(json.dumps(z))\")\n\nset +e\nexport ZONE=\"\"\nexport PROVIDER=\"\"\nexport TOKEN=\"\"\necho \"Probing for AWS metadata\"\ngather_aws_token() {\n\tHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 -X PUT \"http://169.254.169.254/latest/api/token\" -H \"X-aws-ec2-metadata-token-ttl-seconds: 21600\")\n\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\techo \"bad return code\"\n\t\treturn 1\n\tfi\n\tif [[ -z \"$HTTP_BODY\" ]]; then\n\t\techo \"no token found\"\n\t\treturn 1\n\tfi\n\techo \"found aws access token\"\n\tTOKEN=\"$HTTP_BODY\"\n}\ngather_zone_info() {\n\tHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 -H \"X-aws-ec2-metadata-token: $TOKEN\" http://169.254.169.254/latest/meta-data/placement/availability-zone)\n\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\t# if a 401 retry without auth\n\tif [[ \"$HTTP_STATUS\" -eq 401 ]]; then\n\t\techo \"unable to get aws metadata with v2 metadata service, trying v1...\"\n\t\tHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 http://169.254.169.254/latest/meta-data/placement/availability-zone)\n\t\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\t\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\tfi\n\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\techo \"bad return code\"\n\t\treturn 1\n\tfi\n\tif [[ \"$HTTP_BODY\" =~ [^a-zA-Z0-9-] ]]; then\n\t\techo \"invalid zone format\"\n\t\treturn 1\n\tfi\n\tZONE=\"$HTTP_BODY\"\n}\ngather_aws_info() {\n    if ! gather_aws_token; then\n        return 1\n    fi\n    if ! gather_zone_info; then\n        return 1\n    fi\n}\nif gather_aws_info; then\n\techo \"aws metadata detected\"\n\tPROVIDER=\"aws\"\nfi\nif [[ -z \"$ZONE\" ]]; then\n\techo \"echo Probing for Azure Metadata\"\n\texport LOCATION_INFO=\"\"\n\texport AZURE_ZONE_NUMBER_INFO=\"\"\n\tgather_location_info() {\n\t\tHTTP_RESPONSE=$(curl -H Metadata:true --noproxy \"*\" --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 \"http://169.254.169.254/metadata/instance/compute/location?api-version=2021-01-01\u0026format=text\")\n\t\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\t\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\t\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\t\techo \"bad return code\"\n\t\t\treturn 1\n\t\tfi\n\t\tif [[ \"$HTTP_BODY\" =~ [^a-zA-Z0-9-] ]]; then\n\t\t\techo \"invalid format\"\n\t\t\treturn 1\n\t\tfi\n\t\tLOCATION_INFO=\"$HTTP_BODY\"\n\t}\n\tgather_azure_zone_number_info() {\n\t\tHTTP_RESPONSE=$(curl -H Metadata:true --noproxy \"*\" --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 \"http://169.254.169.254/metadata/instance/compute/zone?api-version=2021-01-01\u0026format=text\")\n\t\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\t\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\t\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\t\techo \"bad return code\"\n\t\t\treturn 1\n\t\tfi\n\t\tif [[ \"$HTTP_BODY\" =~ [^a-zA-Z0-9-] ]]; then\n\t\t\techo \"invalid format\"\n\t\t\treturn 1\n\t\tfi\n\t\tAZURE_ZONE_NUMBER_INFO=\"$HTTP_BODY\"\n\t}\n\tgather_zone_info() {\n\t\tif ! gather_location_info; then\n\t\t\treturn 1\n\t\tfi\n\t\tif ! gather_azure_zone_number_info; then\n\t\t\treturn 1\n\t\tfi\n\t\tif [[ -n \"$AZURE_ZONE_NUMBER_INFO\" ]]; then\n\t\t  ZONE=\"${LOCATION_INFO}-${AZURE_ZONE_NUMBER_INFO}\"\n\t\telse\n\t\t  ZONE=\"${LOCATION_INFO}\"\n\t\tfi\n\t}\n\tif gather_zone_info; then\n\t\techo \"azure metadata detected\"\n\t\tPROVIDER=\"azure\"\n\tfi\nfi\nif [[ -z \"$ZONE\" ]]; then\n\techo \"echo Probing for GCP Metadata\"\n\tgather_zone_info() {\n\t\tHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 \"http://metadata.google.internal/computeMetadata/v1/instance/zone\" -H \"Metadata-Flavor: Google\")\n\t\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\t\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\t\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\t\techo \"bad return code\"\n\t\t\treturn 1\n\t\tfi\n\t\tPOTENTIAL_ZONE_RESPONSE=$(echo \"$HTTP_BODY\" | awk -F '/' '{print $NF}')\n\t\tif [[ \"$POTENTIAL_ZONE_RESPONSE\" =~ [^a-zA-Z0-9-] ]]; then\n\t\t\techo \"invalid zone format\"\n\t\t\treturn 1\n\t\tfi\n\t\tZONE=\"$POTENTIAL_ZONE_RESPONSE\"\n\t}\n\tif gather_zone_info; then\n\t\techo \"gcp metadata detected\"\n\t\tPROVIDER=\"google\"\n\tfi\nfi\nset -e\nif [[ -n \"$ZONE\" ]]; then\n\tSELECTOR_LABELS=$(echo \"${SELECTOR_LABELS}\" | python3 -c \"import sys, json, os; z = json.load(sys.stdin); y = {\\\"zone\\\": os.getenv('ZONE')}; z.update(y); print(json.dumps(z))\")\nfi\nif [[ -n \"$PROVIDER\" ]]; then\n\tSELECTOR_LABELS=$(echo \"${SELECTOR_LABELS}\" | python3 -c \"import sys, json, os; z = json.load(sys.stdin); y = {\\\"provider\\\": os.getenv('PROVIDER')}; z.update(y); print(json.dumps(z))\")\nfi\n#Step 2: SETUP METADATA\ncat \u003c\u003cEOF \u003eregister.json\n{\n\"controller\": \"$CONTROLLER_ID\",\n\"name\": \"$HOSTNAME\",\n\"identifier\": \"$MACHINE_ID\",\n\"labels\": $SELECTOR_LABELS\n}\nEOF\n\nset +e\n#try to download and run host health check script\nset +x\n#first try to the satellite-health service is enabled\nHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --retry 5 --retry-delay 10 --retry-max-time 60 \\\n        \"${API_URL}satellite-health/api/v1/hello\")\nset -x\nHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\nHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\necho \"$HTTP_STATUS\"\nif [[ \"$HTTP_STATUS\" -eq 200 ]]; then\n        set +x\n        HTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --retry 20 --retry-delay 10 --retry-max-time 360 \\\n                \"${API_URL}satellite-health/sat-host-check\" -o /usr/local/bin/sat-host-check)\n        set -x\n        HTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n        HTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n        echo \"$HTTP_BODY\"\n        echo \"$HTTP_STATUS\"\n        if [[ \"$HTTP_STATUS\" -eq 200 ]]; then\n                chmod +x /usr/local/bin/sat-host-check\n                set +x\n                timeout 5m /usr/local/bin/sat-host-check --region $REGION  --endpoint $API_URL\n                set -x\n        else\n                echo \"Error downloading host health check script [HTTP status: $HTTP_STATUS]\"\n        fi\nelse\n        echo \"Skipping downloading host health check script [HTTP status: $HTTP_STATUS]\"\nfi\nset -e\n\nset +x\n#STEP 3: REGISTER HOST TO THE HOSTQUEUE. NEED TO EVALUATE HTTP STATUS 409 EXISTS, 201 created. ALL OTHERS FAIL.\nHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --retry 100 --retry-delay 10 --retry-max-time 1800 -X POST \\\n\t-H \"X-Auth-Hostqueue-APIKey: $HOST_QUEUE_TOKEN\" \\\n\t-H \"X-Auth-Hostqueue-Account: $ACCOUNT_ID\" \\\n\t-H \"Content-Type: application/json\" \\\n\t-d @register.json \\\n\t\"${API_URL}v2/multishift/hostqueue/host/register\")\nset -x\nHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\nHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\necho \"$HTTP_BODY\"\necho \"$HTTP_STATUS\"\nif [[ \"$HTTP_STATUS\" -ne 201 ]]; then\n\techo \"Error [HTTP status: $HTTP_STATUS]\"\n\texit 1\nfi\n\nHOST_ID=$(echo \"$HTTP_BODY\" | python3 -c \"import sys, json; print(json.load(sys.stdin)['id'])\")\n\n#STEP 4: WAIT FOR MEMBERSHIP TO BE ASSIGNED\nwhile true; do\n\tset +ex\n\tASSIGNMENT=$(curl --retry 100 --retry-delay 10 --retry-max-time 1800 -G -X GET \\\n\t\t-H \"X-Auth-Hostqueue-APIKey: $HOST_QUEUE_TOKEN\" \\\n\t\t-H \"X-Auth-Hostqueue-Account: $ACCOUNT_ID\" \\\n\t\t-d controllerID=\"$CONTROLLER_ID\" \\\n\t\t-d hostID=\"$HOST_ID\" \\\n\t\t\"${API_URL}v2/multishift/hostqueue/host/getAssignment\")\n\tset -ex\n\tisAssigned=$(echo \"$ASSIGNMENT\" | python3 -c \"import sys, json; print(json.load(sys.stdin)['isAssigned'])\" | awk '{print tolower($0)}')\n\tif [[ \"$isAssigned\" == \"true\" ]]; then\n\t\tbreak\n\tfi\n\tif [[ \"$isAssigned\" != \"false\" ]]; then\n\t\techo \"unexpected value for assign retrying\"\n\tfi\n\tsleep 10\ndone\n\n#STEP 5: ASSIGNMENT HAS BEEN MADE. SAVE SCRIPT AND RUN\necho \"$ASSIGNMENT\" | python3 -c \"import sys, json; print(json.load(sys.stdin)['script'])\" \u003e/usr/local/bin/ibm-host-agent.sh\nexport HOST_ID\nASSIGNMENT_ID=$(echo \"$ASSIGNMENT\" | python3 -c \"import sys, json; print(json.load(sys.stdin)['id'])\")\ncat \u003c\u003cEOF \u003e/etc/satelliteflags/ibm-host-agent-vars\nexport HOST_ID=${HOST_ID}\nexport ASSIGNMENT_ID=${ASSIGNMENT_ID}\nEOF\nchmod 0600 /etc/satelliteflags/ibm-host-agent-vars\nchmod 0700 /usr/local/bin/ibm-host-agent.sh\ncat \u003c\u003cEOF \u003e/etc/systemd/system/ibm-host-agent.service\n[Unit]\nDescription=IBM Host Agent Service\nAfter=network.target\n\n[Service]\nEnvironment=\"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"\nExecStart=/usr/local/bin/ibm-host-agent.sh\nRestart=on-failure\nRestartSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\nchmod 0644 /etc/systemd/system/ibm-host-agent.service\nsystemctl daemon-reload\nsystemctl start ibm-host-agent.service\ntouch \"$HOST_ASSIGN_FLAG\"\nHERE\n\nchmod 0700 /usr/local/bin/ibm-host-attach.sh\ncat \u003c\u003c 'EOF' \u003e/etc/systemd/system/ibm-host-attach.service\n[Unit]\nDescription=IBM Host Attach Service\nAfter=network.target\n\n[Service]\nEnvironment=\"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"\nExecStart=/usr/local/bin/ibm-host-attach.sh\nRestart=on-failure\nRestartSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\nchmod 0644 /etc/systemd/system/ibm-host-attach.service\nsystemctl daemon-reload\nsystemctl enable ibm-host-attach.service\nsystemctl start ibm-host-attach.service\n\nSTOPP\n\nsudo nohup bash /tmp/attachHost.sh \u0026\n\n",
            "vcpu": [
              {
                "architecture": "amd64",
                "count": 32
              }
            ],
            "volume_attachments": [
              {
                "id": "0767-db251e23-9992-4531-92d0-66dd1b685229",
                "name": "decorator-headsman-filing-breeze",
                "volume_crn": "crn:v1:bluemix:public:is:us-east-2:a/b77832f89c084e1d994ec9ae8e1bce0e::volume:r014-2b1b5692-cbe1-42fb-88bd-9a22a6c84f79",
                "volume_id": "r014-2b1b5692-cbe1-42fb-88bd-9a22a6c84f79",
                "volume_name": "amperage-elixir-thrift-slate"
              }
            ],
            "volumes": null,
            "vpc": "r014-3b20e91d-b51d-47bf-8fd9-9c26cb716073",
            "wait_before_delete": true,
            "zone": "us-east-2"
          },
          "sensitive_attributes": [],
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjoxODAwMDAwMDAwMDAwLCJkZWxldGUiOjE4MDAwMDAwMDAwMDAsInVwZGF0ZSI6MTgwMDAwMDAwMDAwMH19",
          "dependencies": [
            "module.customer.data.ibm_is_image.host",
            "module.customer.data.ibm_is_ssh_key.existing",
            "module.location.data.ibm_satellite_attach_host_script.script",
            "module.location.data.ibm_satellite_location.location",
            "module.location.ibm_is_security_group.location_security_group",
            "module.location.ibm_is_subnet.location_subnet_zone",
            "module.location.ibm_is_vpc.location_vpc",
            "module.location.ibm_satellite_location.create_location"
          ]
        }
      ]
    },
    {
      "module": "module.internal",
      "mode": "data",
      "type": "ibm_is_image",
      "name": "host",
      "provider": "provider[\"registry.terraform.io/ibm-cloud/ibm\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "access_tags": [],
            "architecture": "amd64",
            "catalog_offering": [
              {
                "managed": false,
                "version": []
              }
            ],
            "checksum": "0cbcc7e6b9b50ca388ed8c1aace8caaf3d12c99d7a4275dc28e3e623cbcaa8c9",
            "crn": "crn:v1:bluemix:public:is:us-east:a/811f8abfbd32425597dc7ba40da98fa6::image:r014-f0e1d733-f981-445a-ae66-de7a59f11e25",
            "encryption": "none",
            "encryption_key": null,
            "id": "r014-f0e1d733-f981-445a-ae66-de7a59f11e25",
            "identifier": null,
            "name": "ibm-redhat-8-6-minimal-amd64-3",
            "os": "red-8-amd64",
            "source_volume": null,
            "status": "deprecated",
            "visibility": "public"
          },
          "sensitive_attributes": []
        }
      ]
    },
    {
      "module": "module.internal",
      "mode": "data",
      "type": "ibm_is_ssh_key",
      "name": "existing",
      "provider": "provider[\"registry.terraform.io/ibm-cloud/ibm\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "access_tags": [],
            "crn": "crn:v1:bluemix:public:is:us-east:a/b77832f89c084e1d994ec9ae8e1bce0e::key:r014-c0c9915b-a1e6-4fd4-9e0c-6ad37eaab759",
            "fingerprint": "SHA256:EWU+xb5ueLAR0Nvh556gaFeiUYNAa34SHe1+BKL/t2M",
            "id": "r014-c0c9915b-a1e6-4fd4-9e0c-6ad37eaab759",
            "length": 4096,
            "name": "gs-satellite-ibm-east1",
            "public_key": "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCSekyIYOJR39CXTQBsfQrwDmUaTIBP7WdWPifQ7wOc56SZm8MsVRZgtsBfOQ3AEMf31XOtuyenFC3oWdn5qEXt/YOAUTYKlmtsY+wY8pMgZ77opd0Fl7WzjUbAedkzvnLHRWhCyFCtsITo4jl8WGN/pEVDoeySv9LxNTJ9hafsfg8hwc3GB90xNRcFzCtm6GSp6y9FSsyTu9w0FRbkIF1FZT3Z7eoAfR4jblsUuy2OgtNlpcRcrTBuvY2sKSx+TLOVhO8Hp4bCWH4eNPVkEFoE+yFnowIYHVDMsm2Vvu0pYQ8n/skyPcXRwEKzWv4r20p5UVCT1BRtdxUsda+SgnECTVyOXyFBeGgkIY1zLYPttPfaonEOCmTP5SMS5ed9bz7fpowzRmuZ0MY2LcMXKeZW6GVyCycAnnq9ffBd/LLvq11sS82MI1+WQehJe2g22cqsZURDycrBYmav9UG4Kr00q0VzYb9JEYZTNKG5+MDzO7BLpyBD039tu7plQJpbT4z4KUWX3zuzUiR3Sgni7E28k5zqd77+Txcz36vqvnppCUtahGQf2Llz/4AiJUyZdpjNPzFob+6u+GvYAXFzuJGPiRAy3H9GJk56WWsTFyBlSNh1YnjRaQa3iIxjAuWPgO06EXXN+9bYqJqy4oo5MnsEor864bSMB+ZdmMw86sdeGQ==",
            "resource_controller_url": "https://cloud.ibm.com/vpc/compute/sshKeys",
            "resource_crn": "crn:v1:bluemix:public:is:us-east:a/b77832f89c084e1d994ec9ae8e1bce0e::key:r014-c0c9915b-a1e6-4fd4-9e0c-6ad37eaab759",
            "resource_group": null,
            "resource_group_name": "ea72d012571e4c3dabd4d52df09331bf",
            "resource_name": "gs-satellite-ibm-east1",
            "type": "rsa"
          },
          "sensitive_attributes": []
        }
      ]
    },
    {
      "module": "module.internal",
      "mode": "managed",
      "type": "ibm_is_floating_ip",
      "name": "location_hosts",
      "provider": "provider[\"registry.terraform.io/ibm-cloud/ibm\"]",
      "instances": [
        {
          "index_key": 0,
          "schema_version": 0,
          "attributes": {
            "access_tags": [],
            "address": "150.239.110.229",
            "crn": "crn:v1:bluemix:public:is:us-east-1:a/b77832f89c084e1d994ec9ae8e1bce0e::floating-ip:r014-8144b689-ac3b-48fc-affc-b872118d10a3",
            "id": "r014-8144b689-ac3b-48fc-affc-b872118d10a3",
            "name": "gs-satellite-ibm1-internal-01",
            "resource_controller_url": "https://cloud.ibm.com/vpc-ext/network/floatingIPs",
            "resource_crn": "crn:v1:bluemix:public:is:us-east-1:a/b77832f89c084e1d994ec9ae8e1bce0e::floating-ip:r014-8144b689-ac3b-48fc-affc-b872118d10a3",
            "resource_group": "5b9d354ad44b4698aca47651741f47d3",
            "resource_group_name": "Default",
            "resource_name": "gs-satellite-ibm1-internal-01",
            "resource_status": "available",
            "status": "available",
            "tags": [],
            "target": "0757-76aeebc7-65c6-45b0-abda-1092273c6fa3",
            "target_list": [
              {
                "crn": "",
                "deleted": [],
                "href": "https://us-east.iaas.cloud.ibm.com/v1/instances/0757_30962f46-dec3-45c9-bc01-3e625d6b5fa1/network_interfaces/0757-76aeebc7-65c6-45b0-abda-1092273c6fa3",
                "id": "0757-76aeebc7-65c6-45b0-abda-1092273c6fa3",
                "name": "eth0",
                "primary_ip": [
                  {
                    "address": "10.241.0.5",
                    "href": "https://us-east.iaas.cloud.ibm.com/v1/subnets/0757-b3302169-9838-4498-9580-dc9898fcb19b/reserved_ips/0757-ec39abe4-0194-465b-95ac-7925ab00de90",
                    "name": "division-mop-props-swirl",
                    "reserved_ip": "0757-ec39abe4-0194-465b-95ac-7925ab00de90",
                    "resource_type": "subnet_reserved_ip"
                  }
                ],
                "resource_type": "network_interface"
              }
            ],
            "timeouts": null,
            "zone": "us-east-1"
          },
          "sensitive_attributes": [],
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjo2MDAwMDAwMDAwMDAsImRlbGV0ZSI6NjAwMDAwMDAwMDAwfX0=",
          "dependencies": [
            "module.internal.data.ibm_is_image.host",
            "module.internal.data.ibm_is_ssh_key.existing",
            "module.internal.ibm_is_instance.location_hosts",
            "module.location.data.ibm_satellite_attach_host_script.script",
            "module.location.data.ibm_satellite_location.location",
            "module.location.ibm_is_security_group.location_security_group",
            "module.location.ibm_is_subnet.location_subnet_zone",
            "module.location.ibm_is_vpc.location_vpc",
            "module.location.ibm_satellite_location.create_location"
          ]
        },
        {
          "index_key": 1,
          "schema_version": 0,
          "attributes": {
            "access_tags": [],
            "address": "169.59.164.33",
            "crn": "crn:v1:bluemix:public:is:us-east-2:a/b77832f89c084e1d994ec9ae8e1bce0e::floating-ip:r014-60975d65-b9eb-42eb-91fe-b5d4529e443f",
            "id": "r014-60975d65-b9eb-42eb-91fe-b5d4529e443f",
            "name": "gs-satellite-ibm1-internal-02",
            "resource_controller_url": "https://cloud.ibm.com/vpc-ext/network/floatingIPs",
            "resource_crn": "crn:v1:bluemix:public:is:us-east-2:a/b77832f89c084e1d994ec9ae8e1bce0e::floating-ip:r014-60975d65-b9eb-42eb-91fe-b5d4529e443f",
            "resource_group": "5b9d354ad44b4698aca47651741f47d3",
            "resource_group_name": "Default",
            "resource_name": "gs-satellite-ibm1-internal-02",
            "resource_status": "available",
            "status": "available",
            "tags": [],
            "target": "0767-3b2f168c-7ebb-4dd6-bc85-3eb46d5aaab4",
            "target_list": [
              {
                "crn": "",
                "deleted": [],
                "href": "https://us-east.iaas.cloud.ibm.com/v1/instances/0767_40c13ac7-50ee-49b0-aa00-8745f881a8e7/network_interfaces/0767-3b2f168c-7ebb-4dd6-bc85-3eb46d5aaab4",
                "id": "0767-3b2f168c-7ebb-4dd6-bc85-3eb46d5aaab4",
                "name": "eth0",
                "primary_ip": [
                  {
                    "address": "10.241.64.4",
                    "href": "https://us-east.iaas.cloud.ibm.com/v1/subnets/0767-a0afd690-b8d6-4bbb-ae5a-a8621eb21155/reserved_ips/0767-a995b88e-b519-485f-b859-07d9d7446f3d",
                    "name": "hyperlink-unscathed-unluckily-moonrise",
                    "reserved_ip": "0767-a995b88e-b519-485f-b859-07d9d7446f3d",
                    "resource_type": "subnet_reserved_ip"
                  }
                ],
                "resource_type": "network_interface"
              }
            ],
            "timeouts": null,
            "zone": "us-east-2"
          },
          "sensitive_attributes": [],
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjo2MDAwMDAwMDAwMDAsImRlbGV0ZSI6NjAwMDAwMDAwMDAwfX0=",
          "dependencies": [
            "module.internal.data.ibm_is_image.host",
            "module.internal.data.ibm_is_ssh_key.existing",
            "module.internal.ibm_is_instance.location_hosts",
            "module.location.data.ibm_satellite_attach_host_script.script",
            "module.location.data.ibm_satellite_location.location",
            "module.location.ibm_is_security_group.location_security_group",
            "module.location.ibm_is_subnet.location_subnet_zone",
            "module.location.ibm_is_vpc.location_vpc",
            "module.location.ibm_satellite_location.create_location"
          ]
        },
        {
          "index_key": 2,
          "schema_version": 0,
          "attributes": {
            "access_tags": [],
            "address": "169.62.16.80",
            "crn": "crn:v1:bluemix:public:is:us-east-3:a/b77832f89c084e1d994ec9ae8e1bce0e::floating-ip:r014-bb7c716c-a47a-43f3-8d88-610260b58046",
            "id": "r014-bb7c716c-a47a-43f3-8d88-610260b58046",
            "name": "gs-satellite-ibm1-internal-03",
            "resource_controller_url": "https://cloud.ibm.com/vpc-ext/network/floatingIPs",
            "resource_crn": "crn:v1:bluemix:public:is:us-east-3:a/b77832f89c084e1d994ec9ae8e1bce0e::floating-ip:r014-bb7c716c-a47a-43f3-8d88-610260b58046",
            "resource_group": "5b9d354ad44b4698aca47651741f47d3",
            "resource_group_name": "Default",
            "resource_name": "gs-satellite-ibm1-internal-03",
            "resource_status": "available",
            "status": "available",
            "tags": [],
            "target": "0777-f51c1534-e1a4-440c-8f89-c3d69379e227",
            "target_list": [
              {
                "crn": "",
                "deleted": [],
                "href": "https://us-east.iaas.cloud.ibm.com/v1/instances/0777_3bca185d-0555-4f22-97d2-cfe2597c4386/network_interfaces/0777-f51c1534-e1a4-440c-8f89-c3d69379e227",
                "id": "0777-f51c1534-e1a4-440c-8f89-c3d69379e227",
                "name": "eth0",
                "primary_ip": [
                  {
                    "address": "10.241.128.5",
                    "href": "https://us-east.iaas.cloud.ibm.com/v1/subnets/0777-aa5ce777-4fda-4ff5-9fa0-1b872e35ef2e/reserved_ips/0777-5fd47d4a-d33d-4e5e-af25-0c054cf6df46",
                    "name": "entree-transpose-mobilize-efficient",
                    "reserved_ip": "0777-5fd47d4a-d33d-4e5e-af25-0c054cf6df46",
                    "resource_type": "subnet_reserved_ip"
                  }
                ],
                "resource_type": "network_interface"
              }
            ],
            "timeouts": null,
            "zone": "us-east-3"
          },
          "sensitive_attributes": [],
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjo2MDAwMDAwMDAwMDAsImRlbGV0ZSI6NjAwMDAwMDAwMDAwfX0=",
          "dependencies": [
            "module.internal.data.ibm_is_image.host",
            "module.internal.data.ibm_is_ssh_key.existing",
            "module.internal.ibm_is_instance.location_hosts",
            "module.location.data.ibm_satellite_attach_host_script.script",
            "module.location.data.ibm_satellite_location.location",
            "module.location.ibm_is_security_group.location_security_group",
            "module.location.ibm_is_subnet.location_subnet_zone",
            "module.location.ibm_is_vpc.location_vpc",
            "module.location.ibm_satellite_location.create_location"
          ]
        }
      ]
    },
    {
      "module": "module.internal",
      "mode": "managed",
      "type": "ibm_is_instance",
      "name": "location_hosts",
      "provider": "provider[\"registry.terraform.io/ibm-cloud/ibm\"]",
      "instances": [
        {
          "index_key": 0,
          "schema_version": 0,
          "attributes": {
            "access_tags": [],
            "action": null,
            "auto_delete_volume": null,
            "availability_policy_host_failure": "restart",
            "bandwidth": 16000,
            "boot_volume": [
              {
                "auto_delete_volume": true,
                "encryption": "",
                "iops": 3000,
                "name": "squatter-carrot-flicked-hardy",
                "profile": "general-purpose",
                "size": 100,
                "snapshot": "",
                "tags": [],
                "volume_id": "r014-7b516af5-69e8-40da-be49-b58f3e129740"
              }
            ],
            "catalog_offering": [],
            "crn": "crn:v1:bluemix:public:is:us-east-1:a/b77832f89c084e1d994ec9ae8e1bce0e::instance:0757_30962f46-dec3-45c9-bc01-3e625d6b5fa1",
            "dedicated_host": null,
            "dedicated_host_group": null,
            "default_trusted_profile_auto_link": null,
            "default_trusted_profile_target": null,
            "disks": [],
            "force_action": false,
            "force_recovery_time": null,
            "gpu": [],
            "id": "0757_30962f46-dec3-45c9-bc01-3e625d6b5fa1",
            "image": "r014-f0e1d733-f981-445a-ae66-de7a59f11e25",
            "instance_template": null,
            "keys": [
              "r014-c0c9915b-a1e6-4fd4-9e0c-6ad37eaab759"
            ],
            "lifecycle_reasons": [],
            "lifecycle_state": "stable",
            "memory": 32,
            "metadata_service_enabled": false,
            "name": "gs-satellite-ibm1-internal-01",
            "network_interfaces": [],
            "placement_group": null,
            "placement_target": [],
            "primary_network_interface": [
              {
                "allow_ip_spoofing": false,
                "id": "0757-76aeebc7-65c6-45b0-abda-1092273c6fa3",
                "name": "eth0",
                "port_speed": 12000,
                "primary_ip": [
                  {
                    "address": "10.241.0.5",
                    "auto_delete": true,
                    "href": "https://us-east.iaas.cloud.ibm.com/v1/subnets/0757-b3302169-9838-4498-9580-dc9898fcb19b/reserved_ips/0757-ec39abe4-0194-465b-95ac-7925ab00de90",
                    "name": "division-mop-props-swirl",
                    "reserved_ip": "0757-ec39abe4-0194-465b-95ac-7925ab00de90",
                    "resource_type": "subnet_reserved_ip"
                  }
                ],
                "primary_ipv4_address": "10.241.0.5",
                "security_groups": [
                  "r014-736bc133-3b71-4d7f-b3c1-c52ef26e626a"
                ],
                "subnet": "0757-b3302169-9838-4498-9580-dc9898fcb19b"
              }
            ],
            "profile": "bx2-8x32",
            "resource_controller_url": "https://cloud.ibm.com/vpc-ext/compute/vs",
            "resource_crn": "crn:v1:bluemix:public:is:us-east-1:a/b77832f89c084e1d994ec9ae8e1bce0e::instance:0757_30962f46-dec3-45c9-bc01-3e625d6b5fa1",
            "resource_group": "5b9d354ad44b4698aca47651741f47d3",
            "resource_group_name": "Default",
            "resource_name": "gs-satellite-ibm1-internal-01",
            "resource_status": "running",
            "status": "running",
            "status_reasons": [],
            "tags": [],
            "timeouts": null,
            "total_network_bandwidth": 12000,
            "total_volume_bandwidth": 4000,
            "user_data": "#!/bin/bash\n\nsubscription-manager release --set=8\nsubscription-manager repos --disable='*eus*'\n\ncat \u003c\u003c'STOPP' | tee /tmp/attachHost.sh\n#!/usr/bin/env bash\ncat \u003c\u003c 'HERE' \u003e\u003e/usr/local/bin/ibm-host-attach.sh\n#!/usr/bin/env bash\nset -ex\nmkdir -p /etc/satelliteflags\nHOST_ASSIGN_FLAG=\"/etc/satelliteflags/hostattachflag\"\nif [[ -f \"$HOST_ASSIGN_FLAG\" ]]; then\n\techo \"host has already been assigned. need to reload before you try the attach again\"\n\texit 0\nfi\nset +x\nHOST_QUEUE_TOKEN=\"9f75cd5f618da970de4d6ba7b1eec08bc74ed3dc317881ce8af00c3e34429bec2a3d324dcbd6be3b129fe9e510fd348b7ab95c805b442944db7006c81d170a5a49d20c52bdabc6b6eb2acfe6b79ad6cdb50d8587cec843f2f94c5a57a2f95e089bcfecb0d681af4dede4143b29a64a91d014e6453a5af30e92a48e809d628f001008a8695381ba204f444211e9c6c925218bb97f64c03dea3588f7721114db4f8d2834508b12b1eb9691fd19e4d2412ec52a2e7955e538c7d8c6077d46b9c11fbad7eef398475825ce8b611439c3b1d71eebc6db619fe8951d26a5a6c66bce183c0c729e1cfea9c46f690a6e0c18096eb375c2812418b7c23cacb2c7365e8e8a\"\nset -x\nACCOUNT_ID=\"b77832f89c084e1d994ec9ae8e1bce0e\"\nCONTROLLER_ID=\"cjjme7lw0k8v5b0qob9g\"\nSELECTOR_LABELS='{}'\nAPI_URL=\"https://origin.us-east.containers.cloud.ibm.com/\"\nREGION=\"us-east\"\n\nexport HOST_QUEUE_TOKEN\nexport ACCOUNT_ID\nexport CONTROLLER_ID\nexport REGION\n\n#shutdown known blacklisted services for Satellite (these will break kube)\nset +e\nsystemctl stop -f iptables.service\nsystemctl disable iptables.service\nsystemctl mask iptables.service\nsystemctl stop -f firewalld.service\nsystemctl disable firewalld.service\nsystemctl mask firewalld.service\nset -e\n\n# ensure you can successfully communicate with redhat mirrors (this is a prereq to the rest of the automation working)\nif [[ $(grep -ic \"maipo\" \u003c /etc/redhat-release) -ne 0 ]]; then\n\t#RHEL 7\n\tOPERATING_SYSTEM=\"RHEL7\"\nelif [[ $(grep -ic \"ootpa\" \u003c /etc/redhat-release) -ne 0 ]]; then\n\t#RHEL 8\n\tOPERATING_SYSTEM=\"RHEL8\"\nelif grep -qi \"coreos\" \u003c /etc/redhat-release; then\n\tOPERATING_SYSTEM=\"RHCOS\"\nelse\n\tOPERATING_SYSTEM=\"UNKNOWN\"\nfi\n\nif [[ \"${OPERATING_SYSTEM}\" != \"RHEL7\" \u0026\u0026 \"${OPERATING_SYSTEM}\" != \"RHEL8\" ]]; then\n\techo \"This script is only intended to run with a RHEL7 or RHEL8 operating system. Current operating system ${OPERATING_SYSTEM}.\"\n\texit 1\nfi\nexport OPERATING_SYSTEM\n\nsubscription-manager refresh\nif [[ \"${OPERATING_SYSTEM}\" == \"RHEL7\" ]]; then\n\tsubscription-manager repos --enable rhel-server-rhscl-7-rpms\n\tsubscription-manager repos --enable rhel-7-server-optional-rpms\n\tsubscription-manager repos --enable rhel-7-server-rh-common-rpms\n\tsubscription-manager repos --enable rhel-7-server-supplementary-rpms\n\tsubscription-manager repos --enable rhel-7-server-extras-rpms\nelif [[ \"${OPERATING_SYSTEM}\" == \"RHEL8\" ]]; then\n\tsubscription-manager release --set=8\n\tsubscription-manager repos --disable='*eus*'\n\tsubscription-manager repos --enable rhel-8-for-x86_64-baseos-rpms \n\tsubscription-manager repos --enable rhel-8-for-x86_64-appstream-rpms;\nfi\nyum install container-selinux -y\n\n\nif [[ \"${OPERATING_SYSTEM}\" == \"RHEL7\" ]]; then\n\tyum install rh-python36 -y\n\t# shellcheck disable=SC1091\n\tsource /opt/rh/rh-python36/enable\nelif [[ \"${OPERATING_SYSTEM}\" == \"RHEL8\" ]]; then\n\tyum install python39 -y\nfi\n\nmkdir -p /etc/satellitemachineidgeneration\nif [[ ! -f /etc/satellitemachineidgeneration/machineidgenerated ]]; then\n    rm -f /etc/machine-id\n    systemd-machine-id-setup\n    if openssl rand -hex 16; then\n      openssl rand -hex 16 \u003e /etc/machine-id\n    fi\n    touch /etc/satellitemachineidgeneration/machineidgenerated\nfi\n#STEP 1: GATHER INFORMATION THAT WILL BE USED TO REGISTER THE HOST\nHOSTNAME=$(hostname -s)\nHOSTNAME=${HOSTNAME,,}\nMACHINE_ID=$(cat /etc/machine-id)\nCPUS=$(nproc)\nMEMORY=$(grep MemTotal /proc/meminfo | awk '{print $2}')\nexport CPUS\nexport MEMORY\n\nif [[ \"${OPERATING_SYSTEM}\" != \"RHEL7\" \u0026\u0026 \"${OPERATING_SYSTEM}\" != \"RHEL8\" ]]; then\n  echo \"This script is only intended to run with a RHEL7 or RHEL8 operating system. Current operating system ${OPERATING_SYSTEM}. Going to continue on for backwards compatibility\"\nfi\n\nSELECTOR_LABELS=$(echo \"${SELECTOR_LABELS}\" | python3 -c \"import sys, json, os; z = json.load(sys.stdin); y = {\\\"cpu\\\": os.getenv('CPUS'), \\\"memory\\\": os.getenv('MEMORY'), \\\"os\\\": os.getenv('OPERATING_SYSTEM')}; z.update(y); print(json.dumps(z))\")\n\nset +e\nexport ZONE=\"\"\nexport PROVIDER=\"\"\nexport TOKEN=\"\"\necho \"Probing for AWS metadata\"\ngather_aws_token() {\n\tHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 -X PUT \"http://169.254.169.254/latest/api/token\" -H \"X-aws-ec2-metadata-token-ttl-seconds: 21600\")\n\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\techo \"bad return code\"\n\t\treturn 1\n\tfi\n\tif [[ -z \"$HTTP_BODY\" ]]; then\n\t\techo \"no token found\"\n\t\treturn 1\n\tfi\n\techo \"found aws access token\"\n\tTOKEN=\"$HTTP_BODY\"\n}\ngather_zone_info() {\n\tHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 -H \"X-aws-ec2-metadata-token: $TOKEN\" http://169.254.169.254/latest/meta-data/placement/availability-zone)\n\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\t# if a 401 retry without auth\n\tif [[ \"$HTTP_STATUS\" -eq 401 ]]; then\n\t\techo \"unable to get aws metadata with v2 metadata service, trying v1...\"\n\t\tHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 http://169.254.169.254/latest/meta-data/placement/availability-zone)\n\t\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\t\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\tfi\n\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\techo \"bad return code\"\n\t\treturn 1\n\tfi\n\tif [[ \"$HTTP_BODY\" =~ [^a-zA-Z0-9-] ]]; then\n\t\techo \"invalid zone format\"\n\t\treturn 1\n\tfi\n\tZONE=\"$HTTP_BODY\"\n}\ngather_aws_info() {\n    if ! gather_aws_token; then\n        return 1\n    fi\n    if ! gather_zone_info; then\n        return 1\n    fi\n}\nif gather_aws_info; then\n\techo \"aws metadata detected\"\n\tPROVIDER=\"aws\"\nfi\nif [[ -z \"$ZONE\" ]]; then\n\techo \"echo Probing for Azure Metadata\"\n\texport LOCATION_INFO=\"\"\n\texport AZURE_ZONE_NUMBER_INFO=\"\"\n\tgather_location_info() {\n\t\tHTTP_RESPONSE=$(curl -H Metadata:true --noproxy \"*\" --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 \"http://169.254.169.254/metadata/instance/compute/location?api-version=2021-01-01\u0026format=text\")\n\t\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\t\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\t\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\t\techo \"bad return code\"\n\t\t\treturn 1\n\t\tfi\n\t\tif [[ \"$HTTP_BODY\" =~ [^a-zA-Z0-9-] ]]; then\n\t\t\techo \"invalid format\"\n\t\t\treturn 1\n\t\tfi\n\t\tLOCATION_INFO=\"$HTTP_BODY\"\n\t}\n\tgather_azure_zone_number_info() {\n\t\tHTTP_RESPONSE=$(curl -H Metadata:true --noproxy \"*\" --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 \"http://169.254.169.254/metadata/instance/compute/zone?api-version=2021-01-01\u0026format=text\")\n\t\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\t\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\t\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\t\techo \"bad return code\"\n\t\t\treturn 1\n\t\tfi\n\t\tif [[ \"$HTTP_BODY\" =~ [^a-zA-Z0-9-] ]]; then\n\t\t\techo \"invalid format\"\n\t\t\treturn 1\n\t\tfi\n\t\tAZURE_ZONE_NUMBER_INFO=\"$HTTP_BODY\"\n\t}\n\tgather_zone_info() {\n\t\tif ! gather_location_info; then\n\t\t\treturn 1\n\t\tfi\n\t\tif ! gather_azure_zone_number_info; then\n\t\t\treturn 1\n\t\tfi\n\t\tif [[ -n \"$AZURE_ZONE_NUMBER_INFO\" ]]; then\n\t\t  ZONE=\"${LOCATION_INFO}-${AZURE_ZONE_NUMBER_INFO}\"\n\t\telse\n\t\t  ZONE=\"${LOCATION_INFO}\"\n\t\tfi\n\t}\n\tif gather_zone_info; then\n\t\techo \"azure metadata detected\"\n\t\tPROVIDER=\"azure\"\n\tfi\nfi\nif [[ -z \"$ZONE\" ]]; then\n\techo \"echo Probing for GCP Metadata\"\n\tgather_zone_info() {\n\t\tHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 \"http://metadata.google.internal/computeMetadata/v1/instance/zone\" -H \"Metadata-Flavor: Google\")\n\t\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\t\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\t\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\t\techo \"bad return code\"\n\t\t\treturn 1\n\t\tfi\n\t\tPOTENTIAL_ZONE_RESPONSE=$(echo \"$HTTP_BODY\" | awk -F '/' '{print $NF}')\n\t\tif [[ \"$POTENTIAL_ZONE_RESPONSE\" =~ [^a-zA-Z0-9-] ]]; then\n\t\t\techo \"invalid zone format\"\n\t\t\treturn 1\n\t\tfi\n\t\tZONE=\"$POTENTIAL_ZONE_RESPONSE\"\n\t}\n\tif gather_zone_info; then\n\t\techo \"gcp metadata detected\"\n\t\tPROVIDER=\"google\"\n\tfi\nfi\nset -e\nif [[ -n \"$ZONE\" ]]; then\n\tSELECTOR_LABELS=$(echo \"${SELECTOR_LABELS}\" | python3 -c \"import sys, json, os; z = json.load(sys.stdin); y = {\\\"zone\\\": os.getenv('ZONE')}; z.update(y); print(json.dumps(z))\")\nfi\nif [[ -n \"$PROVIDER\" ]]; then\n\tSELECTOR_LABELS=$(echo \"${SELECTOR_LABELS}\" | python3 -c \"import sys, json, os; z = json.load(sys.stdin); y = {\\\"provider\\\": os.getenv('PROVIDER')}; z.update(y); print(json.dumps(z))\")\nfi\n#Step 2: SETUP METADATA\ncat \u003c\u003cEOF \u003eregister.json\n{\n\"controller\": \"$CONTROLLER_ID\",\n\"name\": \"$HOSTNAME\",\n\"identifier\": \"$MACHINE_ID\",\n\"labels\": $SELECTOR_LABELS\n}\nEOF\n\nset +e\n#try to download and run host health check script\nset +x\n#first try to the satellite-health service is enabled\nHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --retry 5 --retry-delay 10 --retry-max-time 60 \\\n        \"${API_URL}satellite-health/api/v1/hello\")\nset -x\nHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\nHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\necho \"$HTTP_STATUS\"\nif [[ \"$HTTP_STATUS\" -eq 200 ]]; then\n        set +x\n        HTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --retry 20 --retry-delay 10 --retry-max-time 360 \\\n                \"${API_URL}satellite-health/sat-host-check\" -o /usr/local/bin/sat-host-check)\n        set -x\n        HTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n        HTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n        echo \"$HTTP_BODY\"\n        echo \"$HTTP_STATUS\"\n        if [[ \"$HTTP_STATUS\" -eq 200 ]]; then\n                chmod +x /usr/local/bin/sat-host-check\n                set +x\n                timeout 5m /usr/local/bin/sat-host-check --region $REGION  --endpoint $API_URL\n                set -x\n        else\n                echo \"Error downloading host health check script [HTTP status: $HTTP_STATUS]\"\n        fi\nelse\n        echo \"Skipping downloading host health check script [HTTP status: $HTTP_STATUS]\"\nfi\nset -e\n\nset +x\n#STEP 3: REGISTER HOST TO THE HOSTQUEUE. NEED TO EVALUATE HTTP STATUS 409 EXISTS, 201 created. ALL OTHERS FAIL.\nHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --retry 100 --retry-delay 10 --retry-max-time 1800 -X POST \\\n\t-H \"X-Auth-Hostqueue-APIKey: $HOST_QUEUE_TOKEN\" \\\n\t-H \"X-Auth-Hostqueue-Account: $ACCOUNT_ID\" \\\n\t-H \"Content-Type: application/json\" \\\n\t-d @register.json \\\n\t\"${API_URL}v2/multishift/hostqueue/host/register\")\nset -x\nHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\nHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\necho \"$HTTP_BODY\"\necho \"$HTTP_STATUS\"\nif [[ \"$HTTP_STATUS\" -ne 201 ]]; then\n\techo \"Error [HTTP status: $HTTP_STATUS]\"\n\texit 1\nfi\n\nHOST_ID=$(echo \"$HTTP_BODY\" | python3 -c \"import sys, json; print(json.load(sys.stdin)['id'])\")\n\n#STEP 4: WAIT FOR MEMBERSHIP TO BE ASSIGNED\nwhile true; do\n\tset +ex\n\tASSIGNMENT=$(curl --retry 100 --retry-delay 10 --retry-max-time 1800 -G -X GET \\\n\t\t-H \"X-Auth-Hostqueue-APIKey: $HOST_QUEUE_TOKEN\" \\\n\t\t-H \"X-Auth-Hostqueue-Account: $ACCOUNT_ID\" \\\n\t\t-d controllerID=\"$CONTROLLER_ID\" \\\n\t\t-d hostID=\"$HOST_ID\" \\\n\t\t\"${API_URL}v2/multishift/hostqueue/host/getAssignment\")\n\tset -ex\n\tisAssigned=$(echo \"$ASSIGNMENT\" | python3 -c \"import sys, json; print(json.load(sys.stdin)['isAssigned'])\" | awk '{print tolower($0)}')\n\tif [[ \"$isAssigned\" == \"true\" ]]; then\n\t\tbreak\n\tfi\n\tif [[ \"$isAssigned\" != \"false\" ]]; then\n\t\techo \"unexpected value for assign retrying\"\n\tfi\n\tsleep 10\ndone\n\n#STEP 5: ASSIGNMENT HAS BEEN MADE. SAVE SCRIPT AND RUN\necho \"$ASSIGNMENT\" | python3 -c \"import sys, json; print(json.load(sys.stdin)['script'])\" \u003e/usr/local/bin/ibm-host-agent.sh\nexport HOST_ID\nASSIGNMENT_ID=$(echo \"$ASSIGNMENT\" | python3 -c \"import sys, json; print(json.load(sys.stdin)['id'])\")\ncat \u003c\u003cEOF \u003e/etc/satelliteflags/ibm-host-agent-vars\nexport HOST_ID=${HOST_ID}\nexport ASSIGNMENT_ID=${ASSIGNMENT_ID}\nEOF\nchmod 0600 /etc/satelliteflags/ibm-host-agent-vars\nchmod 0700 /usr/local/bin/ibm-host-agent.sh\ncat \u003c\u003cEOF \u003e/etc/systemd/system/ibm-host-agent.service\n[Unit]\nDescription=IBM Host Agent Service\nAfter=network.target\n\n[Service]\nEnvironment=\"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"\nExecStart=/usr/local/bin/ibm-host-agent.sh\nRestart=on-failure\nRestartSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\nchmod 0644 /etc/systemd/system/ibm-host-agent.service\nsystemctl daemon-reload\nsystemctl start ibm-host-agent.service\ntouch \"$HOST_ASSIGN_FLAG\"\nHERE\n\nchmod 0700 /usr/local/bin/ibm-host-attach.sh\ncat \u003c\u003c 'EOF' \u003e/etc/systemd/system/ibm-host-attach.service\n[Unit]\nDescription=IBM Host Attach Service\nAfter=network.target\n\n[Service]\nEnvironment=\"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"\nExecStart=/usr/local/bin/ibm-host-attach.sh\nRestart=on-failure\nRestartSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\nchmod 0644 /etc/systemd/system/ibm-host-attach.service\nsystemctl daemon-reload\nsystemctl enable ibm-host-attach.service\nsystemctl start ibm-host-attach.service\n\nSTOPP\n\nsudo nohup bash /tmp/attachHost.sh \u0026\n\n",
            "vcpu": [
              {
                "architecture": "amd64",
                "count": 8
              }
            ],
            "volume_attachments": [
              {
                "id": "0757-a66bf067-2eb8-4f66-a2c4-46226ed77237",
                "name": "oppose-safehouse-washtub-extrude",
                "volume_crn": "crn:v1:bluemix:public:is:us-east-1:a/b77832f89c084e1d994ec9ae8e1bce0e::volume:r014-7b516af5-69e8-40da-be49-b58f3e129740",
                "volume_id": "r014-7b516af5-69e8-40da-be49-b58f3e129740",
                "volume_name": "squatter-carrot-flicked-hardy"
              }
            ],
            "volumes": null,
            "vpc": "r014-3b20e91d-b51d-47bf-8fd9-9c26cb716073",
            "wait_before_delete": true,
            "zone": "us-east-1"
          },
          "sensitive_attributes": [],
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjoxODAwMDAwMDAwMDAwLCJkZWxldGUiOjE4MDAwMDAwMDAwMDAsInVwZGF0ZSI6MTgwMDAwMDAwMDAwMH19",
          "dependencies": [
            "module.internal.data.ibm_is_image.host",
            "module.internal.data.ibm_is_ssh_key.existing",
            "module.location.data.ibm_satellite_attach_host_script.script",
            "module.location.data.ibm_satellite_location.location",
            "module.location.ibm_is_security_group.location_security_group",
            "module.location.ibm_is_subnet.location_subnet_zone",
            "module.location.ibm_is_vpc.location_vpc",
            "module.location.ibm_satellite_location.create_location"
          ]
        },
        {
          "index_key": 1,
          "schema_version": 0,
          "attributes": {
            "access_tags": [],
            "action": null,
            "auto_delete_volume": null,
            "availability_policy_host_failure": "restart",
            "bandwidth": 16000,
            "boot_volume": [
              {
                "auto_delete_volume": true,
                "encryption": "",
                "iops": 3000,
                "name": "dollarwise-devalue-mushroom-unnamed",
                "profile": "general-purpose",
                "size": 100,
                "snapshot": "",
                "tags": [],
                "volume_id": "r014-abb7d980-07b6-49fe-9333-3c2be44edb9c"
              }
            ],
            "catalog_offering": [],
            "crn": "crn:v1:bluemix:public:is:us-east-2:a/b77832f89c084e1d994ec9ae8e1bce0e::instance:0767_40c13ac7-50ee-49b0-aa00-8745f881a8e7",
            "dedicated_host": null,
            "dedicated_host_group": null,
            "default_trusted_profile_auto_link": null,
            "default_trusted_profile_target": null,
            "disks": [],
            "force_action": false,
            "force_recovery_time": null,
            "gpu": [],
            "id": "0767_40c13ac7-50ee-49b0-aa00-8745f881a8e7",
            "image": "r014-f0e1d733-f981-445a-ae66-de7a59f11e25",
            "instance_template": null,
            "keys": [
              "r014-c0c9915b-a1e6-4fd4-9e0c-6ad37eaab759"
            ],
            "lifecycle_reasons": [],
            "lifecycle_state": "stable",
            "memory": 32,
            "metadata_service_enabled": false,
            "name": "gs-satellite-ibm1-internal-02",
            "network_interfaces": [],
            "placement_group": null,
            "placement_target": [],
            "primary_network_interface": [
              {
                "allow_ip_spoofing": false,
                "id": "0767-3b2f168c-7ebb-4dd6-bc85-3eb46d5aaab4",
                "name": "eth0",
                "port_speed": 12000,
                "primary_ip": [
                  {
                    "address": "10.241.64.4",
                    "auto_delete": true,
                    "href": "https://us-east.iaas.cloud.ibm.com/v1/subnets/0767-a0afd690-b8d6-4bbb-ae5a-a8621eb21155/reserved_ips/0767-a995b88e-b519-485f-b859-07d9d7446f3d",
                    "name": "hyperlink-unscathed-unluckily-moonrise",
                    "reserved_ip": "0767-a995b88e-b519-485f-b859-07d9d7446f3d",
                    "resource_type": "subnet_reserved_ip"
                  }
                ],
                "primary_ipv4_address": "10.241.64.4",
                "security_groups": [
                  "r014-736bc133-3b71-4d7f-b3c1-c52ef26e626a"
                ],
                "subnet": "0767-a0afd690-b8d6-4bbb-ae5a-a8621eb21155"
              }
            ],
            "profile": "bx2-8x32",
            "resource_controller_url": "https://cloud.ibm.com/vpc-ext/compute/vs",
            "resource_crn": "crn:v1:bluemix:public:is:us-east-2:a/b77832f89c084e1d994ec9ae8e1bce0e::instance:0767_40c13ac7-50ee-49b0-aa00-8745f881a8e7",
            "resource_group": "5b9d354ad44b4698aca47651741f47d3",
            "resource_group_name": "Default",
            "resource_name": "gs-satellite-ibm1-internal-02",
            "resource_status": "running",
            "status": "running",
            "status_reasons": [],
            "tags": [],
            "timeouts": null,
            "total_network_bandwidth": 12000,
            "total_volume_bandwidth": 4000,
            "user_data": "#!/bin/bash\n\nsubscription-manager release --set=8\nsubscription-manager repos --disable='*eus*'\n\ncat \u003c\u003c'STOPP' | tee /tmp/attachHost.sh\n#!/usr/bin/env bash\ncat \u003c\u003c 'HERE' \u003e\u003e/usr/local/bin/ibm-host-attach.sh\n#!/usr/bin/env bash\nset -ex\nmkdir -p /etc/satelliteflags\nHOST_ASSIGN_FLAG=\"/etc/satelliteflags/hostattachflag\"\nif [[ -f \"$HOST_ASSIGN_FLAG\" ]]; then\n\techo \"host has already been assigned. need to reload before you try the attach again\"\n\texit 0\nfi\nset +x\nHOST_QUEUE_TOKEN=\"9f75cd5f618da970de4d6ba7b1eec08bc74ed3dc317881ce8af00c3e34429bec2a3d324dcbd6be3b129fe9e510fd348b7ab95c805b442944db7006c81d170a5a49d20c52bdabc6b6eb2acfe6b79ad6cdb50d8587cec843f2f94c5a57a2f95e089bcfecb0d681af4dede4143b29a64a91d014e6453a5af30e92a48e809d628f001008a8695381ba204f444211e9c6c925218bb97f64c03dea3588f7721114db4f8d2834508b12b1eb9691fd19e4d2412ec52a2e7955e538c7d8c6077d46b9c11fbad7eef398475825ce8b611439c3b1d71eebc6db619fe8951d26a5a6c66bce183c0c729e1cfea9c46f690a6e0c18096eb375c2812418b7c23cacb2c7365e8e8a\"\nset -x\nACCOUNT_ID=\"b77832f89c084e1d994ec9ae8e1bce0e\"\nCONTROLLER_ID=\"cjjme7lw0k8v5b0qob9g\"\nSELECTOR_LABELS='{}'\nAPI_URL=\"https://origin.us-east.containers.cloud.ibm.com/\"\nREGION=\"us-east\"\n\nexport HOST_QUEUE_TOKEN\nexport ACCOUNT_ID\nexport CONTROLLER_ID\nexport REGION\n\n#shutdown known blacklisted services for Satellite (these will break kube)\nset +e\nsystemctl stop -f iptables.service\nsystemctl disable iptables.service\nsystemctl mask iptables.service\nsystemctl stop -f firewalld.service\nsystemctl disable firewalld.service\nsystemctl mask firewalld.service\nset -e\n\n# ensure you can successfully communicate with redhat mirrors (this is a prereq to the rest of the automation working)\nif [[ $(grep -ic \"maipo\" \u003c /etc/redhat-release) -ne 0 ]]; then\n\t#RHEL 7\n\tOPERATING_SYSTEM=\"RHEL7\"\nelif [[ $(grep -ic \"ootpa\" \u003c /etc/redhat-release) -ne 0 ]]; then\n\t#RHEL 8\n\tOPERATING_SYSTEM=\"RHEL8\"\nelif grep -qi \"coreos\" \u003c /etc/redhat-release; then\n\tOPERATING_SYSTEM=\"RHCOS\"\nelse\n\tOPERATING_SYSTEM=\"UNKNOWN\"\nfi\n\nif [[ \"${OPERATING_SYSTEM}\" != \"RHEL7\" \u0026\u0026 \"${OPERATING_SYSTEM}\" != \"RHEL8\" ]]; then\n\techo \"This script is only intended to run with a RHEL7 or RHEL8 operating system. Current operating system ${OPERATING_SYSTEM}.\"\n\texit 1\nfi\nexport OPERATING_SYSTEM\n\nsubscription-manager refresh\nif [[ \"${OPERATING_SYSTEM}\" == \"RHEL7\" ]]; then\n\tsubscription-manager repos --enable rhel-server-rhscl-7-rpms\n\tsubscription-manager repos --enable rhel-7-server-optional-rpms\n\tsubscription-manager repos --enable rhel-7-server-rh-common-rpms\n\tsubscription-manager repos --enable rhel-7-server-supplementary-rpms\n\tsubscription-manager repos --enable rhel-7-server-extras-rpms\nelif [[ \"${OPERATING_SYSTEM}\" == \"RHEL8\" ]]; then\n\tsubscription-manager release --set=8\n\tsubscription-manager repos --disable='*eus*'\n\tsubscription-manager repos --enable rhel-8-for-x86_64-baseos-rpms \n\tsubscription-manager repos --enable rhel-8-for-x86_64-appstream-rpms;\nfi\nyum install container-selinux -y\n\n\nif [[ \"${OPERATING_SYSTEM}\" == \"RHEL7\" ]]; then\n\tyum install rh-python36 -y\n\t# shellcheck disable=SC1091\n\tsource /opt/rh/rh-python36/enable\nelif [[ \"${OPERATING_SYSTEM}\" == \"RHEL8\" ]]; then\n\tyum install python39 -y\nfi\n\nmkdir -p /etc/satellitemachineidgeneration\nif [[ ! -f /etc/satellitemachineidgeneration/machineidgenerated ]]; then\n    rm -f /etc/machine-id\n    systemd-machine-id-setup\n    if openssl rand -hex 16; then\n      openssl rand -hex 16 \u003e /etc/machine-id\n    fi\n    touch /etc/satellitemachineidgeneration/machineidgenerated\nfi\n#STEP 1: GATHER INFORMATION THAT WILL BE USED TO REGISTER THE HOST\nHOSTNAME=$(hostname -s)\nHOSTNAME=${HOSTNAME,,}\nMACHINE_ID=$(cat /etc/machine-id)\nCPUS=$(nproc)\nMEMORY=$(grep MemTotal /proc/meminfo | awk '{print $2}')\nexport CPUS\nexport MEMORY\n\nif [[ \"${OPERATING_SYSTEM}\" != \"RHEL7\" \u0026\u0026 \"${OPERATING_SYSTEM}\" != \"RHEL8\" ]]; then\n  echo \"This script is only intended to run with a RHEL7 or RHEL8 operating system. Current operating system ${OPERATING_SYSTEM}. Going to continue on for backwards compatibility\"\nfi\n\nSELECTOR_LABELS=$(echo \"${SELECTOR_LABELS}\" | python3 -c \"import sys, json, os; z = json.load(sys.stdin); y = {\\\"cpu\\\": os.getenv('CPUS'), \\\"memory\\\": os.getenv('MEMORY'), \\\"os\\\": os.getenv('OPERATING_SYSTEM')}; z.update(y); print(json.dumps(z))\")\n\nset +e\nexport ZONE=\"\"\nexport PROVIDER=\"\"\nexport TOKEN=\"\"\necho \"Probing for AWS metadata\"\ngather_aws_token() {\n\tHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 -X PUT \"http://169.254.169.254/latest/api/token\" -H \"X-aws-ec2-metadata-token-ttl-seconds: 21600\")\n\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\techo \"bad return code\"\n\t\treturn 1\n\tfi\n\tif [[ -z \"$HTTP_BODY\" ]]; then\n\t\techo \"no token found\"\n\t\treturn 1\n\tfi\n\techo \"found aws access token\"\n\tTOKEN=\"$HTTP_BODY\"\n}\ngather_zone_info() {\n\tHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 -H \"X-aws-ec2-metadata-token: $TOKEN\" http://169.254.169.254/latest/meta-data/placement/availability-zone)\n\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\t# if a 401 retry without auth\n\tif [[ \"$HTTP_STATUS\" -eq 401 ]]; then\n\t\techo \"unable to get aws metadata with v2 metadata service, trying v1...\"\n\t\tHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 http://169.254.169.254/latest/meta-data/placement/availability-zone)\n\t\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\t\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\tfi\n\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\techo \"bad return code\"\n\t\treturn 1\n\tfi\n\tif [[ \"$HTTP_BODY\" =~ [^a-zA-Z0-9-] ]]; then\n\t\techo \"invalid zone format\"\n\t\treturn 1\n\tfi\n\tZONE=\"$HTTP_BODY\"\n}\ngather_aws_info() {\n    if ! gather_aws_token; then\n        return 1\n    fi\n    if ! gather_zone_info; then\n        return 1\n    fi\n}\nif gather_aws_info; then\n\techo \"aws metadata detected\"\n\tPROVIDER=\"aws\"\nfi\nif [[ -z \"$ZONE\" ]]; then\n\techo \"echo Probing for Azure Metadata\"\n\texport LOCATION_INFO=\"\"\n\texport AZURE_ZONE_NUMBER_INFO=\"\"\n\tgather_location_info() {\n\t\tHTTP_RESPONSE=$(curl -H Metadata:true --noproxy \"*\" --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 \"http://169.254.169.254/metadata/instance/compute/location?api-version=2021-01-01\u0026format=text\")\n\t\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\t\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\t\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\t\techo \"bad return code\"\n\t\t\treturn 1\n\t\tfi\n\t\tif [[ \"$HTTP_BODY\" =~ [^a-zA-Z0-9-] ]]; then\n\t\t\techo \"invalid format\"\n\t\t\treturn 1\n\t\tfi\n\t\tLOCATION_INFO=\"$HTTP_BODY\"\n\t}\n\tgather_azure_zone_number_info() {\n\t\tHTTP_RESPONSE=$(curl -H Metadata:true --noproxy \"*\" --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 \"http://169.254.169.254/metadata/instance/compute/zone?api-version=2021-01-01\u0026format=text\")\n\t\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\t\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\t\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\t\techo \"bad return code\"\n\t\t\treturn 1\n\t\tfi\n\t\tif [[ \"$HTTP_BODY\" =~ [^a-zA-Z0-9-] ]]; then\n\t\t\techo \"invalid format\"\n\t\t\treturn 1\n\t\tfi\n\t\tAZURE_ZONE_NUMBER_INFO=\"$HTTP_BODY\"\n\t}\n\tgather_zone_info() {\n\t\tif ! gather_location_info; then\n\t\t\treturn 1\n\t\tfi\n\t\tif ! gather_azure_zone_number_info; then\n\t\t\treturn 1\n\t\tfi\n\t\tif [[ -n \"$AZURE_ZONE_NUMBER_INFO\" ]]; then\n\t\t  ZONE=\"${LOCATION_INFO}-${AZURE_ZONE_NUMBER_INFO}\"\n\t\telse\n\t\t  ZONE=\"${LOCATION_INFO}\"\n\t\tfi\n\t}\n\tif gather_zone_info; then\n\t\techo \"azure metadata detected\"\n\t\tPROVIDER=\"azure\"\n\tfi\nfi\nif [[ -z \"$ZONE\" ]]; then\n\techo \"echo Probing for GCP Metadata\"\n\tgather_zone_info() {\n\t\tHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 \"http://metadata.google.internal/computeMetadata/v1/instance/zone\" -H \"Metadata-Flavor: Google\")\n\t\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\t\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\t\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\t\techo \"bad return code\"\n\t\t\treturn 1\n\t\tfi\n\t\tPOTENTIAL_ZONE_RESPONSE=$(echo \"$HTTP_BODY\" | awk -F '/' '{print $NF}')\n\t\tif [[ \"$POTENTIAL_ZONE_RESPONSE\" =~ [^a-zA-Z0-9-] ]]; then\n\t\t\techo \"invalid zone format\"\n\t\t\treturn 1\n\t\tfi\n\t\tZONE=\"$POTENTIAL_ZONE_RESPONSE\"\n\t}\n\tif gather_zone_info; then\n\t\techo \"gcp metadata detected\"\n\t\tPROVIDER=\"google\"\n\tfi\nfi\nset -e\nif [[ -n \"$ZONE\" ]]; then\n\tSELECTOR_LABELS=$(echo \"${SELECTOR_LABELS}\" | python3 -c \"import sys, json, os; z = json.load(sys.stdin); y = {\\\"zone\\\": os.getenv('ZONE')}; z.update(y); print(json.dumps(z))\")\nfi\nif [[ -n \"$PROVIDER\" ]]; then\n\tSELECTOR_LABELS=$(echo \"${SELECTOR_LABELS}\" | python3 -c \"import sys, json, os; z = json.load(sys.stdin); y = {\\\"provider\\\": os.getenv('PROVIDER')}; z.update(y); print(json.dumps(z))\")\nfi\n#Step 2: SETUP METADATA\ncat \u003c\u003cEOF \u003eregister.json\n{\n\"controller\": \"$CONTROLLER_ID\",\n\"name\": \"$HOSTNAME\",\n\"identifier\": \"$MACHINE_ID\",\n\"labels\": $SELECTOR_LABELS\n}\nEOF\n\nset +e\n#try to download and run host health check script\nset +x\n#first try to the satellite-health service is enabled\nHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --retry 5 --retry-delay 10 --retry-max-time 60 \\\n        \"${API_URL}satellite-health/api/v1/hello\")\nset -x\nHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\nHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\necho \"$HTTP_STATUS\"\nif [[ \"$HTTP_STATUS\" -eq 200 ]]; then\n        set +x\n        HTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --retry 20 --retry-delay 10 --retry-max-time 360 \\\n                \"${API_URL}satellite-health/sat-host-check\" -o /usr/local/bin/sat-host-check)\n        set -x\n        HTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n        HTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n        echo \"$HTTP_BODY\"\n        echo \"$HTTP_STATUS\"\n        if [[ \"$HTTP_STATUS\" -eq 200 ]]; then\n                chmod +x /usr/local/bin/sat-host-check\n                set +x\n                timeout 5m /usr/local/bin/sat-host-check --region $REGION  --endpoint $API_URL\n                set -x\n        else\n                echo \"Error downloading host health check script [HTTP status: $HTTP_STATUS]\"\n        fi\nelse\n        echo \"Skipping downloading host health check script [HTTP status: $HTTP_STATUS]\"\nfi\nset -e\n\nset +x\n#STEP 3: REGISTER HOST TO THE HOSTQUEUE. NEED TO EVALUATE HTTP STATUS 409 EXISTS, 201 created. ALL OTHERS FAIL.\nHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --retry 100 --retry-delay 10 --retry-max-time 1800 -X POST \\\n\t-H \"X-Auth-Hostqueue-APIKey: $HOST_QUEUE_TOKEN\" \\\n\t-H \"X-Auth-Hostqueue-Account: $ACCOUNT_ID\" \\\n\t-H \"Content-Type: application/json\" \\\n\t-d @register.json \\\n\t\"${API_URL}v2/multishift/hostqueue/host/register\")\nset -x\nHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\nHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\necho \"$HTTP_BODY\"\necho \"$HTTP_STATUS\"\nif [[ \"$HTTP_STATUS\" -ne 201 ]]; then\n\techo \"Error [HTTP status: $HTTP_STATUS]\"\n\texit 1\nfi\n\nHOST_ID=$(echo \"$HTTP_BODY\" | python3 -c \"import sys, json; print(json.load(sys.stdin)['id'])\")\n\n#STEP 4: WAIT FOR MEMBERSHIP TO BE ASSIGNED\nwhile true; do\n\tset +ex\n\tASSIGNMENT=$(curl --retry 100 --retry-delay 10 --retry-max-time 1800 -G -X GET \\\n\t\t-H \"X-Auth-Hostqueue-APIKey: $HOST_QUEUE_TOKEN\" \\\n\t\t-H \"X-Auth-Hostqueue-Account: $ACCOUNT_ID\" \\\n\t\t-d controllerID=\"$CONTROLLER_ID\" \\\n\t\t-d hostID=\"$HOST_ID\" \\\n\t\t\"${API_URL}v2/multishift/hostqueue/host/getAssignment\")\n\tset -ex\n\tisAssigned=$(echo \"$ASSIGNMENT\" | python3 -c \"import sys, json; print(json.load(sys.stdin)['isAssigned'])\" | awk '{print tolower($0)}')\n\tif [[ \"$isAssigned\" == \"true\" ]]; then\n\t\tbreak\n\tfi\n\tif [[ \"$isAssigned\" != \"false\" ]]; then\n\t\techo \"unexpected value for assign retrying\"\n\tfi\n\tsleep 10\ndone\n\n#STEP 5: ASSIGNMENT HAS BEEN MADE. SAVE SCRIPT AND RUN\necho \"$ASSIGNMENT\" | python3 -c \"import sys, json; print(json.load(sys.stdin)['script'])\" \u003e/usr/local/bin/ibm-host-agent.sh\nexport HOST_ID\nASSIGNMENT_ID=$(echo \"$ASSIGNMENT\" | python3 -c \"import sys, json; print(json.load(sys.stdin)['id'])\")\ncat \u003c\u003cEOF \u003e/etc/satelliteflags/ibm-host-agent-vars\nexport HOST_ID=${HOST_ID}\nexport ASSIGNMENT_ID=${ASSIGNMENT_ID}\nEOF\nchmod 0600 /etc/satelliteflags/ibm-host-agent-vars\nchmod 0700 /usr/local/bin/ibm-host-agent.sh\ncat \u003c\u003cEOF \u003e/etc/systemd/system/ibm-host-agent.service\n[Unit]\nDescription=IBM Host Agent Service\nAfter=network.target\n\n[Service]\nEnvironment=\"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"\nExecStart=/usr/local/bin/ibm-host-agent.sh\nRestart=on-failure\nRestartSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\nchmod 0644 /etc/systemd/system/ibm-host-agent.service\nsystemctl daemon-reload\nsystemctl start ibm-host-agent.service\ntouch \"$HOST_ASSIGN_FLAG\"\nHERE\n\nchmod 0700 /usr/local/bin/ibm-host-attach.sh\ncat \u003c\u003c 'EOF' \u003e/etc/systemd/system/ibm-host-attach.service\n[Unit]\nDescription=IBM Host Attach Service\nAfter=network.target\n\n[Service]\nEnvironment=\"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"\nExecStart=/usr/local/bin/ibm-host-attach.sh\nRestart=on-failure\nRestartSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\nchmod 0644 /etc/systemd/system/ibm-host-attach.service\nsystemctl daemon-reload\nsystemctl enable ibm-host-attach.service\nsystemctl start ibm-host-attach.service\n\nSTOPP\n\nsudo nohup bash /tmp/attachHost.sh \u0026\n\n",
            "vcpu": [
              {
                "architecture": "amd64",
                "count": 8
              }
            ],
            "volume_attachments": [
              {
                "id": "0767-d06cfefa-3d7b-4318-a512-a13a79beaf9d",
                "name": "germproof-cilantro-lullaby-fabricable",
                "volume_crn": "crn:v1:bluemix:public:is:us-east-2:a/b77832f89c084e1d994ec9ae8e1bce0e::volume:r014-abb7d980-07b6-49fe-9333-3c2be44edb9c",
                "volume_id": "r014-abb7d980-07b6-49fe-9333-3c2be44edb9c",
                "volume_name": "dollarwise-devalue-mushroom-unnamed"
              }
            ],
            "volumes": null,
            "vpc": "r014-3b20e91d-b51d-47bf-8fd9-9c26cb716073",
            "wait_before_delete": true,
            "zone": "us-east-2"
          },
          "sensitive_attributes": [],
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjoxODAwMDAwMDAwMDAwLCJkZWxldGUiOjE4MDAwMDAwMDAwMDAsInVwZGF0ZSI6MTgwMDAwMDAwMDAwMH19",
          "dependencies": [
            "module.internal.data.ibm_is_image.host",
            "module.internal.data.ibm_is_ssh_key.existing",
            "module.location.data.ibm_satellite_attach_host_script.script",
            "module.location.data.ibm_satellite_location.location",
            "module.location.ibm_is_security_group.location_security_group",
            "module.location.ibm_is_subnet.location_subnet_zone",
            "module.location.ibm_is_vpc.location_vpc",
            "module.location.ibm_satellite_location.create_location"
          ]
        },
        {
          "index_key": 2,
          "schema_version": 0,
          "attributes": {
            "access_tags": [],
            "action": null,
            "auto_delete_volume": null,
            "availability_policy_host_failure": "restart",
            "bandwidth": 16000,
            "boot_volume": [
              {
                "auto_delete_volume": true,
                "encryption": "",
                "iops": 3000,
                "name": "foe-entitle-paternity-symphony",
                "profile": "general-purpose",
                "size": 100,
                "snapshot": "",
                "tags": [],
                "volume_id": "r014-71cd9e33-90f5-4901-a5f6-2d7798e017d3"
              }
            ],
            "catalog_offering": [],
            "crn": "crn:v1:bluemix:public:is:us-east-3:a/b77832f89c084e1d994ec9ae8e1bce0e::instance:0777_3bca185d-0555-4f22-97d2-cfe2597c4386",
            "dedicated_host": null,
            "dedicated_host_group": null,
            "default_trusted_profile_auto_link": null,
            "default_trusted_profile_target": null,
            "disks": [],
            "force_action": false,
            "force_recovery_time": null,
            "gpu": [],
            "id": "0777_3bca185d-0555-4f22-97d2-cfe2597c4386",
            "image": "r014-f0e1d733-f981-445a-ae66-de7a59f11e25",
            "instance_template": null,
            "keys": [
              "r014-c0c9915b-a1e6-4fd4-9e0c-6ad37eaab759"
            ],
            "lifecycle_reasons": [],
            "lifecycle_state": "stable",
            "memory": 32,
            "metadata_service_enabled": false,
            "name": "gs-satellite-ibm1-internal-03",
            "network_interfaces": [],
            "placement_group": null,
            "placement_target": [],
            "primary_network_interface": [
              {
                "allow_ip_spoofing": false,
                "id": "0777-f51c1534-e1a4-440c-8f89-c3d69379e227",
                "name": "eth0",
                "port_speed": 12000,
                "primary_ip": [
                  {
                    "address": "10.241.128.5",
                    "auto_delete": true,
                    "href": "https://us-east.iaas.cloud.ibm.com/v1/subnets/0777-aa5ce777-4fda-4ff5-9fa0-1b872e35ef2e/reserved_ips/0777-5fd47d4a-d33d-4e5e-af25-0c054cf6df46",
                    "name": "entree-transpose-mobilize-efficient",
                    "reserved_ip": "0777-5fd47d4a-d33d-4e5e-af25-0c054cf6df46",
                    "resource_type": "subnet_reserved_ip"
                  }
                ],
                "primary_ipv4_address": "10.241.128.5",
                "security_groups": [
                  "r014-736bc133-3b71-4d7f-b3c1-c52ef26e626a"
                ],
                "subnet": "0777-aa5ce777-4fda-4ff5-9fa0-1b872e35ef2e"
              }
            ],
            "profile": "bx2-8x32",
            "resource_controller_url": "https://cloud.ibm.com/vpc-ext/compute/vs",
            "resource_crn": "crn:v1:bluemix:public:is:us-east-3:a/b77832f89c084e1d994ec9ae8e1bce0e::instance:0777_3bca185d-0555-4f22-97d2-cfe2597c4386",
            "resource_group": "5b9d354ad44b4698aca47651741f47d3",
            "resource_group_name": "Default",
            "resource_name": "gs-satellite-ibm1-internal-03",
            "resource_status": "running",
            "status": "running",
            "status_reasons": [],
            "tags": [],
            "timeouts": null,
            "total_network_bandwidth": 12000,
            "total_volume_bandwidth": 4000,
            "user_data": "#!/bin/bash\n\nsubscription-manager release --set=8\nsubscription-manager repos --disable='*eus*'\n\ncat \u003c\u003c'STOPP' | tee /tmp/attachHost.sh\n#!/usr/bin/env bash\ncat \u003c\u003c 'HERE' \u003e\u003e/usr/local/bin/ibm-host-attach.sh\n#!/usr/bin/env bash\nset -ex\nmkdir -p /etc/satelliteflags\nHOST_ASSIGN_FLAG=\"/etc/satelliteflags/hostattachflag\"\nif [[ -f \"$HOST_ASSIGN_FLAG\" ]]; then\n\techo \"host has already been assigned. need to reload before you try the attach again\"\n\texit 0\nfi\nset +x\nHOST_QUEUE_TOKEN=\"9f75cd5f618da970de4d6ba7b1eec08bc74ed3dc317881ce8af00c3e34429bec2a3d324dcbd6be3b129fe9e510fd348b7ab95c805b442944db7006c81d170a5a49d20c52bdabc6b6eb2acfe6b79ad6cdb50d8587cec843f2f94c5a57a2f95e089bcfecb0d681af4dede4143b29a64a91d014e6453a5af30e92a48e809d628f001008a8695381ba204f444211e9c6c925218bb97f64c03dea3588f7721114db4f8d2834508b12b1eb9691fd19e4d2412ec52a2e7955e538c7d8c6077d46b9c11fbad7eef398475825ce8b611439c3b1d71eebc6db619fe8951d26a5a6c66bce183c0c729e1cfea9c46f690a6e0c18096eb375c2812418b7c23cacb2c7365e8e8a\"\nset -x\nACCOUNT_ID=\"b77832f89c084e1d994ec9ae8e1bce0e\"\nCONTROLLER_ID=\"cjjme7lw0k8v5b0qob9g\"\nSELECTOR_LABELS='{}'\nAPI_URL=\"https://origin.us-east.containers.cloud.ibm.com/\"\nREGION=\"us-east\"\n\nexport HOST_QUEUE_TOKEN\nexport ACCOUNT_ID\nexport CONTROLLER_ID\nexport REGION\n\n#shutdown known blacklisted services for Satellite (these will break kube)\nset +e\nsystemctl stop -f iptables.service\nsystemctl disable iptables.service\nsystemctl mask iptables.service\nsystemctl stop -f firewalld.service\nsystemctl disable firewalld.service\nsystemctl mask firewalld.service\nset -e\n\n# ensure you can successfully communicate with redhat mirrors (this is a prereq to the rest of the automation working)\nif [[ $(grep -ic \"maipo\" \u003c /etc/redhat-release) -ne 0 ]]; then\n\t#RHEL 7\n\tOPERATING_SYSTEM=\"RHEL7\"\nelif [[ $(grep -ic \"ootpa\" \u003c /etc/redhat-release) -ne 0 ]]; then\n\t#RHEL 8\n\tOPERATING_SYSTEM=\"RHEL8\"\nelif grep -qi \"coreos\" \u003c /etc/redhat-release; then\n\tOPERATING_SYSTEM=\"RHCOS\"\nelse\n\tOPERATING_SYSTEM=\"UNKNOWN\"\nfi\n\nif [[ \"${OPERATING_SYSTEM}\" != \"RHEL7\" \u0026\u0026 \"${OPERATING_SYSTEM}\" != \"RHEL8\" ]]; then\n\techo \"This script is only intended to run with a RHEL7 or RHEL8 operating system. Current operating system ${OPERATING_SYSTEM}.\"\n\texit 1\nfi\nexport OPERATING_SYSTEM\n\nsubscription-manager refresh\nif [[ \"${OPERATING_SYSTEM}\" == \"RHEL7\" ]]; then\n\tsubscription-manager repos --enable rhel-server-rhscl-7-rpms\n\tsubscription-manager repos --enable rhel-7-server-optional-rpms\n\tsubscription-manager repos --enable rhel-7-server-rh-common-rpms\n\tsubscription-manager repos --enable rhel-7-server-supplementary-rpms\n\tsubscription-manager repos --enable rhel-7-server-extras-rpms\nelif [[ \"${OPERATING_SYSTEM}\" == \"RHEL8\" ]]; then\n\tsubscription-manager release --set=8\n\tsubscription-manager repos --disable='*eus*'\n\tsubscription-manager repos --enable rhel-8-for-x86_64-baseos-rpms \n\tsubscription-manager repos --enable rhel-8-for-x86_64-appstream-rpms;\nfi\nyum install container-selinux -y\n\n\nif [[ \"${OPERATING_SYSTEM}\" == \"RHEL7\" ]]; then\n\tyum install rh-python36 -y\n\t# shellcheck disable=SC1091\n\tsource /opt/rh/rh-python36/enable\nelif [[ \"${OPERATING_SYSTEM}\" == \"RHEL8\" ]]; then\n\tyum install python39 -y\nfi\n\nmkdir -p /etc/satellitemachineidgeneration\nif [[ ! -f /etc/satellitemachineidgeneration/machineidgenerated ]]; then\n    rm -f /etc/machine-id\n    systemd-machine-id-setup\n    if openssl rand -hex 16; then\n      openssl rand -hex 16 \u003e /etc/machine-id\n    fi\n    touch /etc/satellitemachineidgeneration/machineidgenerated\nfi\n#STEP 1: GATHER INFORMATION THAT WILL BE USED TO REGISTER THE HOST\nHOSTNAME=$(hostname -s)\nHOSTNAME=${HOSTNAME,,}\nMACHINE_ID=$(cat /etc/machine-id)\nCPUS=$(nproc)\nMEMORY=$(grep MemTotal /proc/meminfo | awk '{print $2}')\nexport CPUS\nexport MEMORY\n\nif [[ \"${OPERATING_SYSTEM}\" != \"RHEL7\" \u0026\u0026 \"${OPERATING_SYSTEM}\" != \"RHEL8\" ]]; then\n  echo \"This script is only intended to run with a RHEL7 or RHEL8 operating system. Current operating system ${OPERATING_SYSTEM}. Going to continue on for backwards compatibility\"\nfi\n\nSELECTOR_LABELS=$(echo \"${SELECTOR_LABELS}\" | python3 -c \"import sys, json, os; z = json.load(sys.stdin); y = {\\\"cpu\\\": os.getenv('CPUS'), \\\"memory\\\": os.getenv('MEMORY'), \\\"os\\\": os.getenv('OPERATING_SYSTEM')}; z.update(y); print(json.dumps(z))\")\n\nset +e\nexport ZONE=\"\"\nexport PROVIDER=\"\"\nexport TOKEN=\"\"\necho \"Probing for AWS metadata\"\ngather_aws_token() {\n\tHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 -X PUT \"http://169.254.169.254/latest/api/token\" -H \"X-aws-ec2-metadata-token-ttl-seconds: 21600\")\n\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\techo \"bad return code\"\n\t\treturn 1\n\tfi\n\tif [[ -z \"$HTTP_BODY\" ]]; then\n\t\techo \"no token found\"\n\t\treturn 1\n\tfi\n\techo \"found aws access token\"\n\tTOKEN=\"$HTTP_BODY\"\n}\ngather_zone_info() {\n\tHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 -H \"X-aws-ec2-metadata-token: $TOKEN\" http://169.254.169.254/latest/meta-data/placement/availability-zone)\n\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\t# if a 401 retry without auth\n\tif [[ \"$HTTP_STATUS\" -eq 401 ]]; then\n\t\techo \"unable to get aws metadata with v2 metadata service, trying v1...\"\n\t\tHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 http://169.254.169.254/latest/meta-data/placement/availability-zone)\n\t\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\t\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\tfi\n\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\techo \"bad return code\"\n\t\treturn 1\n\tfi\n\tif [[ \"$HTTP_BODY\" =~ [^a-zA-Z0-9-] ]]; then\n\t\techo \"invalid zone format\"\n\t\treturn 1\n\tfi\n\tZONE=\"$HTTP_BODY\"\n}\ngather_aws_info() {\n    if ! gather_aws_token; then\n        return 1\n    fi\n    if ! gather_zone_info; then\n        return 1\n    fi\n}\nif gather_aws_info; then\n\techo \"aws metadata detected\"\n\tPROVIDER=\"aws\"\nfi\nif [[ -z \"$ZONE\" ]]; then\n\techo \"echo Probing for Azure Metadata\"\n\texport LOCATION_INFO=\"\"\n\texport AZURE_ZONE_NUMBER_INFO=\"\"\n\tgather_location_info() {\n\t\tHTTP_RESPONSE=$(curl -H Metadata:true --noproxy \"*\" --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 \"http://169.254.169.254/metadata/instance/compute/location?api-version=2021-01-01\u0026format=text\")\n\t\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\t\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\t\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\t\techo \"bad return code\"\n\t\t\treturn 1\n\t\tfi\n\t\tif [[ \"$HTTP_BODY\" =~ [^a-zA-Z0-9-] ]]; then\n\t\t\techo \"invalid format\"\n\t\t\treturn 1\n\t\tfi\n\t\tLOCATION_INFO=\"$HTTP_BODY\"\n\t}\n\tgather_azure_zone_number_info() {\n\t\tHTTP_RESPONSE=$(curl -H Metadata:true --noproxy \"*\" --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 \"http://169.254.169.254/metadata/instance/compute/zone?api-version=2021-01-01\u0026format=text\")\n\t\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\t\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\t\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\t\techo \"bad return code\"\n\t\t\treturn 1\n\t\tfi\n\t\tif [[ \"$HTTP_BODY\" =~ [^a-zA-Z0-9-] ]]; then\n\t\t\techo \"invalid format\"\n\t\t\treturn 1\n\t\tfi\n\t\tAZURE_ZONE_NUMBER_INFO=\"$HTTP_BODY\"\n\t}\n\tgather_zone_info() {\n\t\tif ! gather_location_info; then\n\t\t\treturn 1\n\t\tfi\n\t\tif ! gather_azure_zone_number_info; then\n\t\t\treturn 1\n\t\tfi\n\t\tif [[ -n \"$AZURE_ZONE_NUMBER_INFO\" ]]; then\n\t\t  ZONE=\"${LOCATION_INFO}-${AZURE_ZONE_NUMBER_INFO}\"\n\t\telse\n\t\t  ZONE=\"${LOCATION_INFO}\"\n\t\tfi\n\t}\n\tif gather_zone_info; then\n\t\techo \"azure metadata detected\"\n\t\tPROVIDER=\"azure\"\n\tfi\nfi\nif [[ -z \"$ZONE\" ]]; then\n\techo \"echo Probing for GCP Metadata\"\n\tgather_zone_info() {\n\t\tHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 \"http://metadata.google.internal/computeMetadata/v1/instance/zone\" -H \"Metadata-Flavor: Google\")\n\t\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\t\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\t\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\t\techo \"bad return code\"\n\t\t\treturn 1\n\t\tfi\n\t\tPOTENTIAL_ZONE_RESPONSE=$(echo \"$HTTP_BODY\" | awk -F '/' '{print $NF}')\n\t\tif [[ \"$POTENTIAL_ZONE_RESPONSE\" =~ [^a-zA-Z0-9-] ]]; then\n\t\t\techo \"invalid zone format\"\n\t\t\treturn 1\n\t\tfi\n\t\tZONE=\"$POTENTIAL_ZONE_RESPONSE\"\n\t}\n\tif gather_zone_info; then\n\t\techo \"gcp metadata detected\"\n\t\tPROVIDER=\"google\"\n\tfi\nfi\nset -e\nif [[ -n \"$ZONE\" ]]; then\n\tSELECTOR_LABELS=$(echo \"${SELECTOR_LABELS}\" | python3 -c \"import sys, json, os; z = json.load(sys.stdin); y = {\\\"zone\\\": os.getenv('ZONE')}; z.update(y); print(json.dumps(z))\")\nfi\nif [[ -n \"$PROVIDER\" ]]; then\n\tSELECTOR_LABELS=$(echo \"${SELECTOR_LABELS}\" | python3 -c \"import sys, json, os; z = json.load(sys.stdin); y = {\\\"provider\\\": os.getenv('PROVIDER')}; z.update(y); print(json.dumps(z))\")\nfi\n#Step 2: SETUP METADATA\ncat \u003c\u003cEOF \u003eregister.json\n{\n\"controller\": \"$CONTROLLER_ID\",\n\"name\": \"$HOSTNAME\",\n\"identifier\": \"$MACHINE_ID\",\n\"labels\": $SELECTOR_LABELS\n}\nEOF\n\nset +e\n#try to download and run host health check script\nset +x\n#first try to the satellite-health service is enabled\nHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --retry 5 --retry-delay 10 --retry-max-time 60 \\\n        \"${API_URL}satellite-health/api/v1/hello\")\nset -x\nHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\nHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\necho \"$HTTP_STATUS\"\nif [[ \"$HTTP_STATUS\" -eq 200 ]]; then\n        set +x\n        HTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --retry 20 --retry-delay 10 --retry-max-time 360 \\\n                \"${API_URL}satellite-health/sat-host-check\" -o /usr/local/bin/sat-host-check)\n        set -x\n        HTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n        HTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n        echo \"$HTTP_BODY\"\n        echo \"$HTTP_STATUS\"\n        if [[ \"$HTTP_STATUS\" -eq 200 ]]; then\n                chmod +x /usr/local/bin/sat-host-check\n                set +x\n                timeout 5m /usr/local/bin/sat-host-check --region $REGION  --endpoint $API_URL\n                set -x\n        else\n                echo \"Error downloading host health check script [HTTP status: $HTTP_STATUS]\"\n        fi\nelse\n        echo \"Skipping downloading host health check script [HTTP status: $HTTP_STATUS]\"\nfi\nset -e\n\nset +x\n#STEP 3: REGISTER HOST TO THE HOSTQUEUE. NEED TO EVALUATE HTTP STATUS 409 EXISTS, 201 created. ALL OTHERS FAIL.\nHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --retry 100 --retry-delay 10 --retry-max-time 1800 -X POST \\\n\t-H \"X-Auth-Hostqueue-APIKey: $HOST_QUEUE_TOKEN\" \\\n\t-H \"X-Auth-Hostqueue-Account: $ACCOUNT_ID\" \\\n\t-H \"Content-Type: application/json\" \\\n\t-d @register.json \\\n\t\"${API_URL}v2/multishift/hostqueue/host/register\")\nset -x\nHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\nHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\necho \"$HTTP_BODY\"\necho \"$HTTP_STATUS\"\nif [[ \"$HTTP_STATUS\" -ne 201 ]]; then\n\techo \"Error [HTTP status: $HTTP_STATUS]\"\n\texit 1\nfi\n\nHOST_ID=$(echo \"$HTTP_BODY\" | python3 -c \"import sys, json; print(json.load(sys.stdin)['id'])\")\n\n#STEP 4: WAIT FOR MEMBERSHIP TO BE ASSIGNED\nwhile true; do\n\tset +ex\n\tASSIGNMENT=$(curl --retry 100 --retry-delay 10 --retry-max-time 1800 -G -X GET \\\n\t\t-H \"X-Auth-Hostqueue-APIKey: $HOST_QUEUE_TOKEN\" \\\n\t\t-H \"X-Auth-Hostqueue-Account: $ACCOUNT_ID\" \\\n\t\t-d controllerID=\"$CONTROLLER_ID\" \\\n\t\t-d hostID=\"$HOST_ID\" \\\n\t\t\"${API_URL}v2/multishift/hostqueue/host/getAssignment\")\n\tset -ex\n\tisAssigned=$(echo \"$ASSIGNMENT\" | python3 -c \"import sys, json; print(json.load(sys.stdin)['isAssigned'])\" | awk '{print tolower($0)}')\n\tif [[ \"$isAssigned\" == \"true\" ]]; then\n\t\tbreak\n\tfi\n\tif [[ \"$isAssigned\" != \"false\" ]]; then\n\t\techo \"unexpected value for assign retrying\"\n\tfi\n\tsleep 10\ndone\n\n#STEP 5: ASSIGNMENT HAS BEEN MADE. SAVE SCRIPT AND RUN\necho \"$ASSIGNMENT\" | python3 -c \"import sys, json; print(json.load(sys.stdin)['script'])\" \u003e/usr/local/bin/ibm-host-agent.sh\nexport HOST_ID\nASSIGNMENT_ID=$(echo \"$ASSIGNMENT\" | python3 -c \"import sys, json; print(json.load(sys.stdin)['id'])\")\ncat \u003c\u003cEOF \u003e/etc/satelliteflags/ibm-host-agent-vars\nexport HOST_ID=${HOST_ID}\nexport ASSIGNMENT_ID=${ASSIGNMENT_ID}\nEOF\nchmod 0600 /etc/satelliteflags/ibm-host-agent-vars\nchmod 0700 /usr/local/bin/ibm-host-agent.sh\ncat \u003c\u003cEOF \u003e/etc/systemd/system/ibm-host-agent.service\n[Unit]\nDescription=IBM Host Agent Service\nAfter=network.target\n\n[Service]\nEnvironment=\"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"\nExecStart=/usr/local/bin/ibm-host-agent.sh\nRestart=on-failure\nRestartSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\nchmod 0644 /etc/systemd/system/ibm-host-agent.service\nsystemctl daemon-reload\nsystemctl start ibm-host-agent.service\ntouch \"$HOST_ASSIGN_FLAG\"\nHERE\n\nchmod 0700 /usr/local/bin/ibm-host-attach.sh\ncat \u003c\u003c 'EOF' \u003e/etc/systemd/system/ibm-host-attach.service\n[Unit]\nDescription=IBM Host Attach Service\nAfter=network.target\n\n[Service]\nEnvironment=\"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"\nExecStart=/usr/local/bin/ibm-host-attach.sh\nRestart=on-failure\nRestartSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\nchmod 0644 /etc/systemd/system/ibm-host-attach.service\nsystemctl daemon-reload\nsystemctl enable ibm-host-attach.service\nsystemctl start ibm-host-attach.service\n\nSTOPP\n\nsudo nohup bash /tmp/attachHost.sh \u0026\n\n",
            "vcpu": [
              {
                "architecture": "amd64",
                "count": 8
              }
            ],
            "volume_attachments": [
              {
                "id": "0777-f027d071-2f0b-4b33-81fb-3b70399202eb",
                "name": "strife-scouts-catfish-recycling",
                "volume_crn": "crn:v1:bluemix:public:is:us-east-3:a/b77832f89c084e1d994ec9ae8e1bce0e::volume:r014-71cd9e33-90f5-4901-a5f6-2d7798e017d3",
                "volume_id": "r014-71cd9e33-90f5-4901-a5f6-2d7798e017d3",
                "volume_name": "foe-entitle-paternity-symphony"
              }
            ],
            "volumes": null,
            "vpc": "r014-3b20e91d-b51d-47bf-8fd9-9c26cb716073",
            "wait_before_delete": true,
            "zone": "us-east-3"
          },
          "sensitive_attributes": [],
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjoxODAwMDAwMDAwMDAwLCJkZWxldGUiOjE4MDAwMDAwMDAwMDAsInVwZGF0ZSI6MTgwMDAwMDAwMDAwMH19",
          "dependencies": [
            "module.internal.data.ibm_is_image.host",
            "module.internal.data.ibm_is_ssh_key.existing",
            "module.location.data.ibm_satellite_attach_host_script.script",
            "module.location.data.ibm_satellite_location.location",
            "module.location.ibm_is_security_group.location_security_group",
            "module.location.ibm_is_subnet.location_subnet_zone",
            "module.location.ibm_is_vpc.location_vpc",
            "module.location.ibm_satellite_location.create_location"
          ]
        }
      ]
    },
    {
      "module": "module.location",
      "mode": "data",
      "type": "ibm_satellite_attach_host_script",
      "name": "script",
      "provider": "provider[\"registry.terraform.io/ibm-cloud/ibm\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "coreos_host": null,
            "custom_script": null,
            "description": null,
            "host_provider": "ibm",
            "host_script": "#!/usr/bin/env bash\ncat \u003c\u003c 'HERE' \u003e\u003e/usr/local/bin/ibm-host-attach.sh\n#!/usr/bin/env bash\nset -ex\nmkdir -p /etc/satelliteflags\nHOST_ASSIGN_FLAG=\"/etc/satelliteflags/hostattachflag\"\nif [[ -f \"$HOST_ASSIGN_FLAG\" ]]; then\n\techo \"host has already been assigned. need to reload before you try the attach again\"\n\texit 0\nfi\nset +x\nHOST_QUEUE_TOKEN=\"9f75cd5f618da970de4d6ba7b1eec08bc74ed3dc317881ce8af00c3e34429bec2a3d324dcbd6be3b129fe9e510fd348b7ab95c805b442944db7006c81d170a5a49d20c52bdabc6b6eb2acfe6b79ad6cdb50d8587cec843f2f94c5a57a2f95e089bcfecb0d681af4dede4143b29a64a91d014e6453a5af30e92a48e809d628f001008a8695381ba204f444211e9c6c925218bb97f64c03dea3588f7721114db4f8d2834508b12b1eb9691fd19e4d2412ec52a2e7955e538c7d8c6077d46b9c11fbad7eef398475825ce8b611439c3b1d71eebc6db619fe8951d26a5a6c66bce183c0c729e1cfea9c46f690a6e0c18096eb375c2812418b7c23cacb2c7365e8e8a\"\nset -x\nACCOUNT_ID=\"b77832f89c084e1d994ec9ae8e1bce0e\"\nCONTROLLER_ID=\"cjjme7lw0k8v5b0qob9g\"\nSELECTOR_LABELS='{}'\nAPI_URL=\"https://origin.us-east.containers.cloud.ibm.com/\"\nREGION=\"us-east\"\n\nexport HOST_QUEUE_TOKEN\nexport ACCOUNT_ID\nexport CONTROLLER_ID\nexport REGION\n\n#shutdown known blacklisted services for Satellite (these will break kube)\nset +e\nsystemctl stop -f iptables.service\nsystemctl disable iptables.service\nsystemctl mask iptables.service\nsystemctl stop -f firewalld.service\nsystemctl disable firewalld.service\nsystemctl mask firewalld.service\nset -e\n\n# ensure you can successfully communicate with redhat mirrors (this is a prereq to the rest of the automation working)\nif [[ $(grep -ic \"maipo\" \u003c /etc/redhat-release) -ne 0 ]]; then\n\t#RHEL 7\n\tOPERATING_SYSTEM=\"RHEL7\"\nelif [[ $(grep -ic \"ootpa\" \u003c /etc/redhat-release) -ne 0 ]]; then\n\t#RHEL 8\n\tOPERATING_SYSTEM=\"RHEL8\"\nelif grep -qi \"coreos\" \u003c /etc/redhat-release; then\n\tOPERATING_SYSTEM=\"RHCOS\"\nelse\n\tOPERATING_SYSTEM=\"UNKNOWN\"\nfi\n\nif [[ \"${OPERATING_SYSTEM}\" != \"RHEL7\" \u0026\u0026 \"${OPERATING_SYSTEM}\" != \"RHEL8\" ]]; then\n\techo \"This script is only intended to run with a RHEL7 or RHEL8 operating system. Current operating system ${OPERATING_SYSTEM}.\"\n\texit 1\nfi\nexport OPERATING_SYSTEM\n\nsubscription-manager refresh\nif [[ \"${OPERATING_SYSTEM}\" == \"RHEL7\" ]]; then\n\tsubscription-manager repos --enable rhel-server-rhscl-7-rpms\n\tsubscription-manager repos --enable rhel-7-server-optional-rpms\n\tsubscription-manager repos --enable rhel-7-server-rh-common-rpms\n\tsubscription-manager repos --enable rhel-7-server-supplementary-rpms\n\tsubscription-manager repos --enable rhel-7-server-extras-rpms\nelif [[ \"${OPERATING_SYSTEM}\" == \"RHEL8\" ]]; then\n\tsubscription-manager release --set=8\n\tsubscription-manager repos --disable='*eus*'\n\tsubscription-manager repos --enable rhel-8-for-x86_64-baseos-rpms \n\tsubscription-manager repos --enable rhel-8-for-x86_64-appstream-rpms;\nfi\nyum install container-selinux -y\n\n\nif [[ \"${OPERATING_SYSTEM}\" == \"RHEL7\" ]]; then\n\tyum install rh-python36 -y\n\t# shellcheck disable=SC1091\n\tsource /opt/rh/rh-python36/enable\nelif [[ \"${OPERATING_SYSTEM}\" == \"RHEL8\" ]]; then\n\tyum install python39 -y\nfi\n\nmkdir -p /etc/satellitemachineidgeneration\nif [[ ! -f /etc/satellitemachineidgeneration/machineidgenerated ]]; then\n    rm -f /etc/machine-id\n    systemd-machine-id-setup\n    if openssl rand -hex 16; then\n      openssl rand -hex 16 \u003e /etc/machine-id\n    fi\n    touch /etc/satellitemachineidgeneration/machineidgenerated\nfi\n#STEP 1: GATHER INFORMATION THAT WILL BE USED TO REGISTER THE HOST\nHOSTNAME=$(hostname -s)\nHOSTNAME=${HOSTNAME,,}\nMACHINE_ID=$(cat /etc/machine-id)\nCPUS=$(nproc)\nMEMORY=$(grep MemTotal /proc/meminfo | awk '{print $2}')\nexport CPUS\nexport MEMORY\n\nif [[ \"${OPERATING_SYSTEM}\" != \"RHEL7\" \u0026\u0026 \"${OPERATING_SYSTEM}\" != \"RHEL8\" ]]; then\n  echo \"This script is only intended to run with a RHEL7 or RHEL8 operating system. Current operating system ${OPERATING_SYSTEM}. Going to continue on for backwards compatibility\"\nfi\n\nSELECTOR_LABELS=$(echo \"${SELECTOR_LABELS}\" | python3 -c \"import sys, json, os; z = json.load(sys.stdin); y = {\\\"cpu\\\": os.getenv('CPUS'), \\\"memory\\\": os.getenv('MEMORY'), \\\"os\\\": os.getenv('OPERATING_SYSTEM')}; z.update(y); print(json.dumps(z))\")\n\nset +e\nexport ZONE=\"\"\nexport PROVIDER=\"\"\nexport TOKEN=\"\"\necho \"Probing for AWS metadata\"\ngather_aws_token() {\n\tHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 -X PUT \"http://169.254.169.254/latest/api/token\" -H \"X-aws-ec2-metadata-token-ttl-seconds: 21600\")\n\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\techo \"bad return code\"\n\t\treturn 1\n\tfi\n\tif [[ -z \"$HTTP_BODY\" ]]; then\n\t\techo \"no token found\"\n\t\treturn 1\n\tfi\n\techo \"found aws access token\"\n\tTOKEN=\"$HTTP_BODY\"\n}\ngather_zone_info() {\n\tHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 -H \"X-aws-ec2-metadata-token: $TOKEN\" http://169.254.169.254/latest/meta-data/placement/availability-zone)\n\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\t# if a 401 retry without auth\n\tif [[ \"$HTTP_STATUS\" -eq 401 ]]; then\n\t\techo \"unable to get aws metadata with v2 metadata service, trying v1...\"\n\t\tHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 http://169.254.169.254/latest/meta-data/placement/availability-zone)\n\t\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\t\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\tfi\n\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\techo \"bad return code\"\n\t\treturn 1\n\tfi\n\tif [[ \"$HTTP_BODY\" =~ [^a-zA-Z0-9-] ]]; then\n\t\techo \"invalid zone format\"\n\t\treturn 1\n\tfi\n\tZONE=\"$HTTP_BODY\"\n}\ngather_aws_info() {\n    if ! gather_aws_token; then\n        return 1\n    fi\n    if ! gather_zone_info; then\n        return 1\n    fi\n}\nif gather_aws_info; then\n\techo \"aws metadata detected\"\n\tPROVIDER=\"aws\"\nfi\nif [[ -z \"$ZONE\" ]]; then\n\techo \"echo Probing for Azure Metadata\"\n\texport LOCATION_INFO=\"\"\n\texport AZURE_ZONE_NUMBER_INFO=\"\"\n\tgather_location_info() {\n\t\tHTTP_RESPONSE=$(curl -H Metadata:true --noproxy \"*\" --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 \"http://169.254.169.254/metadata/instance/compute/location?api-version=2021-01-01\u0026format=text\")\n\t\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\t\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\t\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\t\techo \"bad return code\"\n\t\t\treturn 1\n\t\tfi\n\t\tif [[ \"$HTTP_BODY\" =~ [^a-zA-Z0-9-] ]]; then\n\t\t\techo \"invalid format\"\n\t\t\treturn 1\n\t\tfi\n\t\tLOCATION_INFO=\"$HTTP_BODY\"\n\t}\n\tgather_azure_zone_number_info() {\n\t\tHTTP_RESPONSE=$(curl -H Metadata:true --noproxy \"*\" --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 \"http://169.254.169.254/metadata/instance/compute/zone?api-version=2021-01-01\u0026format=text\")\n\t\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\t\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\t\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\t\techo \"bad return code\"\n\t\t\treturn 1\n\t\tfi\n\t\tif [[ \"$HTTP_BODY\" =~ [^a-zA-Z0-9-] ]]; then\n\t\t\techo \"invalid format\"\n\t\t\treturn 1\n\t\tfi\n\t\tAZURE_ZONE_NUMBER_INFO=\"$HTTP_BODY\"\n\t}\n\tgather_zone_info() {\n\t\tif ! gather_location_info; then\n\t\t\treturn 1\n\t\tfi\n\t\tif ! gather_azure_zone_number_info; then\n\t\t\treturn 1\n\t\tfi\n\t\tif [[ -n \"$AZURE_ZONE_NUMBER_INFO\" ]]; then\n\t\t  ZONE=\"${LOCATION_INFO}-${AZURE_ZONE_NUMBER_INFO}\"\n\t\telse\n\t\t  ZONE=\"${LOCATION_INFO}\"\n\t\tfi\n\t}\n\tif gather_zone_info; then\n\t\techo \"azure metadata detected\"\n\t\tPROVIDER=\"azure\"\n\tfi\nfi\nif [[ -z \"$ZONE\" ]]; then\n\techo \"echo Probing for GCP Metadata\"\n\tgather_zone_info() {\n\t\tHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 \"http://metadata.google.internal/computeMetadata/v1/instance/zone\" -H \"Metadata-Flavor: Google\")\n\t\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\t\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\t\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\t\techo \"bad return code\"\n\t\t\treturn 1\n\t\tfi\n\t\tPOTENTIAL_ZONE_RESPONSE=$(echo \"$HTTP_BODY\" | awk -F '/' '{print $NF}')\n\t\tif [[ \"$POTENTIAL_ZONE_RESPONSE\" =~ [^a-zA-Z0-9-] ]]; then\n\t\t\techo \"invalid zone format\"\n\t\t\treturn 1\n\t\tfi\n\t\tZONE=\"$POTENTIAL_ZONE_RESPONSE\"\n\t}\n\tif gather_zone_info; then\n\t\techo \"gcp metadata detected\"\n\t\tPROVIDER=\"google\"\n\tfi\nfi\nset -e\nif [[ -n \"$ZONE\" ]]; then\n\tSELECTOR_LABELS=$(echo \"${SELECTOR_LABELS}\" | python3 -c \"import sys, json, os; z = json.load(sys.stdin); y = {\\\"zone\\\": os.getenv('ZONE')}; z.update(y); print(json.dumps(z))\")\nfi\nif [[ -n \"$PROVIDER\" ]]; then\n\tSELECTOR_LABELS=$(echo \"${SELECTOR_LABELS}\" | python3 -c \"import sys, json, os; z = json.load(sys.stdin); y = {\\\"provider\\\": os.getenv('PROVIDER')}; z.update(y); print(json.dumps(z))\")\nfi\n#Step 2: SETUP METADATA\ncat \u003c\u003cEOF \u003eregister.json\n{\n\"controller\": \"$CONTROLLER_ID\",\n\"name\": \"$HOSTNAME\",\n\"identifier\": \"$MACHINE_ID\",\n\"labels\": $SELECTOR_LABELS\n}\nEOF\n\nset +e\n#try to download and run host health check script\nset +x\n#first try to the satellite-health service is enabled\nHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --retry 5 --retry-delay 10 --retry-max-time 60 \\\n        \"${API_URL}satellite-health/api/v1/hello\")\nset -x\nHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\nHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\necho \"$HTTP_STATUS\"\nif [[ \"$HTTP_STATUS\" -eq 200 ]]; then\n        set +x\n        HTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --retry 20 --retry-delay 10 --retry-max-time 360 \\\n                \"${API_URL}satellite-health/sat-host-check\" -o /usr/local/bin/sat-host-check)\n        set -x\n        HTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n        HTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n        echo \"$HTTP_BODY\"\n        echo \"$HTTP_STATUS\"\n        if [[ \"$HTTP_STATUS\" -eq 200 ]]; then\n                chmod +x /usr/local/bin/sat-host-check\n                set +x\n                timeout 5m /usr/local/bin/sat-host-check --region $REGION  --endpoint $API_URL\n                set -x\n        else\n                echo \"Error downloading host health check script [HTTP status: $HTTP_STATUS]\"\n        fi\nelse\n        echo \"Skipping downloading host health check script [HTTP status: $HTTP_STATUS]\"\nfi\nset -e\n\nset +x\n#STEP 3: REGISTER HOST TO THE HOSTQUEUE. NEED TO EVALUATE HTTP STATUS 409 EXISTS, 201 created. ALL OTHERS FAIL.\nHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --retry 100 --retry-delay 10 --retry-max-time 1800 -X POST \\\n\t-H \"X-Auth-Hostqueue-APIKey: $HOST_QUEUE_TOKEN\" \\\n\t-H \"X-Auth-Hostqueue-Account: $ACCOUNT_ID\" \\\n\t-H \"Content-Type: application/json\" \\\n\t-d @register.json \\\n\t\"${API_URL}v2/multishift/hostqueue/host/register\")\nset -x\nHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\nHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\necho \"$HTTP_BODY\"\necho \"$HTTP_STATUS\"\nif [[ \"$HTTP_STATUS\" -ne 201 ]]; then\n\techo \"Error [HTTP status: $HTTP_STATUS]\"\n\texit 1\nfi\n\nHOST_ID=$(echo \"$HTTP_BODY\" | python3 -c \"import sys, json; print(json.load(sys.stdin)['id'])\")\n\n#STEP 4: WAIT FOR MEMBERSHIP TO BE ASSIGNED\nwhile true; do\n\tset +ex\n\tASSIGNMENT=$(curl --retry 100 --retry-delay 10 --retry-max-time 1800 -G -X GET \\\n\t\t-H \"X-Auth-Hostqueue-APIKey: $HOST_QUEUE_TOKEN\" \\\n\t\t-H \"X-Auth-Hostqueue-Account: $ACCOUNT_ID\" \\\n\t\t-d controllerID=\"$CONTROLLER_ID\" \\\n\t\t-d hostID=\"$HOST_ID\" \\\n\t\t\"${API_URL}v2/multishift/hostqueue/host/getAssignment\")\n\tset -ex\n\tisAssigned=$(echo \"$ASSIGNMENT\" | python3 -c \"import sys, json; print(json.load(sys.stdin)['isAssigned'])\" | awk '{print tolower($0)}')\n\tif [[ \"$isAssigned\" == \"true\" ]]; then\n\t\tbreak\n\tfi\n\tif [[ \"$isAssigned\" != \"false\" ]]; then\n\t\techo \"unexpected value for assign retrying\"\n\tfi\n\tsleep 10\ndone\n\n#STEP 5: ASSIGNMENT HAS BEEN MADE. SAVE SCRIPT AND RUN\necho \"$ASSIGNMENT\" | python3 -c \"import sys, json; print(json.load(sys.stdin)['script'])\" \u003e/usr/local/bin/ibm-host-agent.sh\nexport HOST_ID\nASSIGNMENT_ID=$(echo \"$ASSIGNMENT\" | python3 -c \"import sys, json; print(json.load(sys.stdin)['id'])\")\ncat \u003c\u003cEOF \u003e/etc/satelliteflags/ibm-host-agent-vars\nexport HOST_ID=${HOST_ID}\nexport ASSIGNMENT_ID=${ASSIGNMENT_ID}\nEOF\nchmod 0600 /etc/satelliteflags/ibm-host-agent-vars\nchmod 0700 /usr/local/bin/ibm-host-agent.sh\ncat \u003c\u003cEOF \u003e/etc/systemd/system/ibm-host-agent.service\n[Unit]\nDescription=IBM Host Agent Service\nAfter=network.target\n\n[Service]\nEnvironment=\"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"\nExecStart=/usr/local/bin/ibm-host-agent.sh\nRestart=on-failure\nRestartSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\nchmod 0644 /etc/systemd/system/ibm-host-agent.service\nsystemctl daemon-reload\nsystemctl start ibm-host-agent.service\ntouch \"$HOST_ASSIGN_FLAG\"\nHERE\n\nchmod 0700 /usr/local/bin/ibm-host-attach.sh\ncat \u003c\u003c 'EOF' \u003e/etc/systemd/system/ibm-host-attach.service\n[Unit]\nDescription=IBM Host Attach Service\nAfter=network.target\n\n[Service]\nEnvironment=\"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"\nExecStart=/usr/local/bin/ibm-host-attach.sh\nRestart=on-failure\nRestartSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\nchmod 0644 /etc/systemd/system/ibm-host-attach.service\nsystemctl daemon-reload\nsystemctl enable ibm-host-attach.service\nsystemctl start ibm-host-attach.service\n",
            "id": "cjjme7lw0k8v5b0qob9g",
            "labels": null,
            "location": "cjjme7lw0k8v5b0qob9g",
            "script_dir": "/Users/eashanthakuria",
            "script_path": "/Users/eashanthakuria/addHost.sh"
          },
          "sensitive_attributes": []
        }
      ]
    },
    {
      "module": "module.location",
      "mode": "data",
      "type": "ibm_satellite_location",
      "name": "location",
      "provider": "provider[\"registry.terraform.io/ibm-cloud/ibm\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "coreos_enabled": null,
            "created_on": "2023-08-24T14:20:14+0000",
            "crn": "crn:v1:bluemix:public:satellite:us-east:a/b77832f89c084e1d994ec9ae8e1bce0e:cjjme7lw0k8v5b0qob9g::",
            "description": "",
            "host_attached_count": 0,
            "host_available_count": 0,
            "hosts": [],
            "id": "cjjme7lw0k8v5b0qob9g",
            "ingress_hostname": "g31ee075c74f43e34a24e-6b64a6ccc9c596bf59a86625d8fa2202-c000.us-east.satellite.appdomain.cloud",
            "ingress_secret": "g31ee075c74f43e34a24e-6b64a6ccc9c596bf59a86625d8fa2202-c000",
            "location": "gs-satellite-ibm1",
            "logging_account_id": null,
            "managed_from": "wdc04",
            "resource_group_id": "5b9d354ad44b4698aca47651741f47d3",
            "resource_group_name": "Default",
            "tags": [],
            "zones": [
              "us-east-1",
              "us-east-2",
              "us-east-3"
            ]
          },
          "sensitive_attributes": []
        }
      ]
    },
    {
      "module": "module.location",
      "mode": "managed",
      "type": "ibm_is_security_group",
      "name": "location_security_group",
      "provider": "provider[\"registry.terraform.io/ibm-cloud/ibm\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "access_tags": [],
            "crn": "crn:v1:bluemix:public:is:us-east:a/b77832f89c084e1d994ec9ae8e1bce0e::security-group:r014-736bc133-3b71-4d7f-b3c1-c52ef26e626a",
            "id": "r014-736bc133-3b71-4d7f-b3c1-c52ef26e626a",
            "name": "gs-satellite-ibm1",
            "resource_controller_url": "https://cloud.ibm.com/vpc-ext/network/securityGroups",
            "resource_crn": "crn:v1:bluemix:public:is:us-east:a/b77832f89c084e1d994ec9ae8e1bce0e::security-group:r014-736bc133-3b71-4d7f-b3c1-c52ef26e626a",
            "resource_group": "5b9d354ad44b4698aca47651741f47d3",
            "resource_group_name": "Default",
            "resource_name": "gs-satellite-ibm1",
            "rules": [],
            "tags": [],
            "timeouts": null,
            "vpc": "r014-3b20e91d-b51d-47bf-8fd9-9c26cb716073"
          },
          "sensitive_attributes": [],
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjo2MDAwMDAwMDAwMDAsImRlbGV0ZSI6NjAwMDAwMDAwMDAwfX0=",
          "dependencies": [
            "module.location.ibm_is_vpc.location_vpc"
          ]
        }
      ]
    },
    {
      "module": "module.location",
      "mode": "managed",
      "type": "ibm_is_security_group_rule",
      "name": "location_security_rule_inbound",
      "provider": "provider[\"registry.terraform.io/ibm-cloud/ibm\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "direction": "inbound",
            "group": "r014-736bc133-3b71-4d7f-b3c1-c52ef26e626a",
            "icmp": [],
            "id": "r014-736bc133-3b71-4d7f-b3c1-c52ef26e626a.r014-0a799a50-2537-4b3a-8117-23b1461e06fd",
            "ip_version": "ipv4",
            "protocol": "all",
            "related_crn": "crn:v1:bluemix:public:is:us-east:a/b77832f89c084e1d994ec9ae8e1bce0e::security-group:r014-736bc133-3b71-4d7f-b3c1-c52ef26e626a",
            "remote": "0.0.0.0/0",
            "rule_id": "r014-0a799a50-2537-4b3a-8117-23b1461e06fd",
            "tcp": [],
            "udp": []
          },
          "sensitive_attributes": [],
          "private": "bnVsbA==",
          "dependencies": [
            "module.location.ibm_is_security_group.location_security_group",
            "module.location.ibm_is_vpc.location_vpc"
          ]
        }
      ]
    },
    {
      "module": "module.location",
      "mode": "managed",
      "type": "ibm_is_security_group_rule",
      "name": "location_security_rule_outbound",
      "provider": "provider[\"registry.terraform.io/ibm-cloud/ibm\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "direction": "outbound",
            "group": "r014-736bc133-3b71-4d7f-b3c1-c52ef26e626a",
            "icmp": [],
            "id": "r014-736bc133-3b71-4d7f-b3c1-c52ef26e626a.r014-e5c728fe-e01c-4346-b247-7b5ec4182291",
            "ip_version": "ipv4",
            "protocol": "all",
            "related_crn": "crn:v1:bluemix:public:is:us-east:a/b77832f89c084e1d994ec9ae8e1bce0e::security-group:r014-736bc133-3b71-4d7f-b3c1-c52ef26e626a",
            "remote": "0.0.0.0/0",
            "rule_id": "r014-e5c728fe-e01c-4346-b247-7b5ec4182291",
            "tcp": [],
            "udp": []
          },
          "sensitive_attributes": [],
          "private": "bnVsbA==",
          "dependencies": [
            "module.location.ibm_is_security_group.location_security_group",
            "module.location.ibm_is_vpc.location_vpc"
          ]
        }
      ]
    },
    {
      "module": "module.location",
      "mode": "managed",
      "type": "ibm_is_subnet",
      "name": "location_subnet_zone",
      "provider": "provider[\"registry.terraform.io/ibm-cloud/ibm\"]",
      "instances": [
        {
          "index_key": 0,
          "schema_version": 0,
          "attributes": {
            "access_tags": [],
            "available_ipv4_address_count": 251,
            "crn": "crn:v1:bluemix:public:is:us-east-1:a/b77832f89c084e1d994ec9ae8e1bce0e::subnet:0757-b3302169-9838-4498-9580-dc9898fcb19b",
            "id": "0757-b3302169-9838-4498-9580-dc9898fcb19b",
            "ip_version": "ipv4",
            "ipv4_cidr_block": "10.241.0.0/24",
            "name": "gs-satellite-ibm1-us-east-1",
            "network_acl": "r014-044a3192-2a91-4d32-a3d4-f3ff241652cd",
            "public_gateway": "",
            "resource_controller_url": "https://cloud.ibm.com/vpc-ext/network/subnets",
            "resource_crn": "crn:v1:bluemix:public:is:us-east-1:a/b77832f89c084e1d994ec9ae8e1bce0e::subnet:0757-b3302169-9838-4498-9580-dc9898fcb19b",
            "resource_group": "5b9d354ad44b4698aca47651741f47d3",
            "resource_group_name": "Default",
            "resource_name": "gs-satellite-ibm1-us-east-1",
            "resource_status": "available",
            "routing_table": "r014-6ed3710c-9d6e-4d23-a365-c55d7d0d0b92",
            "status": "available",
            "tags": [],
            "timeouts": null,
            "total_ipv4_address_count": 256,
            "vpc": "r014-3b20e91d-b51d-47bf-8fd9-9c26cb716073",
            "zone": "us-east-1"
          },
          "sensitive_attributes": [],
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjo2MDAwMDAwMDAwMDAsImRlbGV0ZSI6NjAwMDAwMDAwMDAwLCJ1cGRhdGUiOjYwMDAwMDAwMDAwMH19",
          "dependencies": [
            "module.location.ibm_is_vpc.location_vpc"
          ]
        },
        {
          "index_key": 1,
          "schema_version": 0,
          "attributes": {
            "access_tags": [],
            "available_ipv4_address_count": 251,
            "crn": "crn:v1:bluemix:public:is:us-east-2:a/b77832f89c084e1d994ec9ae8e1bce0e::subnet:0767-a0afd690-b8d6-4bbb-ae5a-a8621eb21155",
            "id": "0767-a0afd690-b8d6-4bbb-ae5a-a8621eb21155",
            "ip_version": "ipv4",
            "ipv4_cidr_block": "10.241.64.0/24",
            "name": "gs-satellite-ibm1-us-east-2",
            "network_acl": "r014-044a3192-2a91-4d32-a3d4-f3ff241652cd",
            "public_gateway": "",
            "resource_controller_url": "https://cloud.ibm.com/vpc-ext/network/subnets",
            "resource_crn": "crn:v1:bluemix:public:is:us-east-2:a/b77832f89c084e1d994ec9ae8e1bce0e::subnet:0767-a0afd690-b8d6-4bbb-ae5a-a8621eb21155",
            "resource_group": "5b9d354ad44b4698aca47651741f47d3",
            "resource_group_name": "Default",
            "resource_name": "gs-satellite-ibm1-us-east-2",
            "resource_status": "available",
            "routing_table": "r014-6ed3710c-9d6e-4d23-a365-c55d7d0d0b92",
            "status": "available",
            "tags": [],
            "timeouts": null,
            "total_ipv4_address_count": 256,
            "vpc": "r014-3b20e91d-b51d-47bf-8fd9-9c26cb716073",
            "zone": "us-east-2"
          },
          "sensitive_attributes": [],
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjo2MDAwMDAwMDAwMDAsImRlbGV0ZSI6NjAwMDAwMDAwMDAwLCJ1cGRhdGUiOjYwMDAwMDAwMDAwMH19",
          "dependencies": [
            "module.location.ibm_is_vpc.location_vpc"
          ]
        },
        {
          "index_key": 2,
          "schema_version": 0,
          "attributes": {
            "access_tags": [],
            "available_ipv4_address_count": 251,
            "crn": "crn:v1:bluemix:public:is:us-east-3:a/b77832f89c084e1d994ec9ae8e1bce0e::subnet:0777-aa5ce777-4fda-4ff5-9fa0-1b872e35ef2e",
            "id": "0777-aa5ce777-4fda-4ff5-9fa0-1b872e35ef2e",
            "ip_version": "ipv4",
            "ipv4_cidr_block": "10.241.128.0/24",
            "name": "gs-satellite-ibm1-us-east-3",
            "network_acl": "r014-044a3192-2a91-4d32-a3d4-f3ff241652cd",
            "public_gateway": "",
            "resource_controller_url": "https://cloud.ibm.com/vpc-ext/network/subnets",
            "resource_crn": "crn:v1:bluemix:public:is:us-east-3:a/b77832f89c084e1d994ec9ae8e1bce0e::subnet:0777-aa5ce777-4fda-4ff5-9fa0-1b872e35ef2e",
            "resource_group": "5b9d354ad44b4698aca47651741f47d3",
            "resource_group_name": "Default",
            "resource_name": "gs-satellite-ibm1-us-east-3",
            "resource_status": "available",
            "routing_table": "r014-6ed3710c-9d6e-4d23-a365-c55d7d0d0b92",
            "status": "available",
            "tags": [],
            "timeouts": null,
            "total_ipv4_address_count": 256,
            "vpc": "r014-3b20e91d-b51d-47bf-8fd9-9c26cb716073",
            "zone": "us-east-3"
          },
          "sensitive_attributes": [],
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjo2MDAwMDAwMDAwMDAsImRlbGV0ZSI6NjAwMDAwMDAwMDAwLCJ1cGRhdGUiOjYwMDAwMDAwMDAwMH19",
          "dependencies": [
            "module.location.ibm_is_vpc.location_vpc"
          ]
        }
      ]
    },
    {
      "module": "module.location",
      "mode": "managed",
      "type": "ibm_is_vpc",
      "name": "location_vpc",
      "provider": "provider[\"registry.terraform.io/ibm-cloud/ibm\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "access_tags": [],
            "address_prefix_management": "auto",
            "classic_access": false,
            "crn": "crn:v1:bluemix:public:is:us-east:a/b77832f89c084e1d994ec9ae8e1bce0e::vpc:r014-3b20e91d-b51d-47bf-8fd9-9c26cb716073",
            "cse_source_addresses": [
              {
                "address": "10.22.46.251",
                "zone_name": "us-east-1"
              },
              {
                "address": "10.249.92.225",
                "zone_name": "us-east-2"
              },
              {
                "address": "10.22.62.227",
                "zone_name": "us-east-3"
              }
            ],
            "default_network_acl": "r014-044a3192-2a91-4d32-a3d4-f3ff241652cd",
            "default_network_acl_crn": "crn:v1:bluemix:public:is:us-east:a/b77832f89c084e1d994ec9ae8e1bce0e::network-acl:r014-044a3192-2a91-4d32-a3d4-f3ff241652cd",
            "default_network_acl_name": "legible-imperfect-doormat-strength",
            "default_routing_table": "r014-6ed3710c-9d6e-4d23-a365-c55d7d0d0b92",
            "default_routing_table_name": "blooper-resonate-donator-groove",
            "default_security_group": "r014-5489847e-966e-4eb1-8d5a-c0ab2694d266",
            "default_security_group_crn": "crn:v1:bluemix:public:is:us-east:a/b77832f89c084e1d994ec9ae8e1bce0e::security-group:r014-5489847e-966e-4eb1-8d5a-c0ab2694d266",
            "default_security_group_name": "fiddling-runny-browse-audible",
            "id": "r014-3b20e91d-b51d-47bf-8fd9-9c26cb716073",
            "name": "gs-satellite-ibm1",
            "resource_controller_url": "https://cloud.ibm.com/vpc-ext/network/vpcs",
            "resource_crn": "crn:v1:bluemix:public:is:us-east:a/b77832f89c084e1d994ec9ae8e1bce0e::vpc:r014-3b20e91d-b51d-47bf-8fd9-9c26cb716073",
            "resource_group": "5b9d354ad44b4698aca47651741f47d3",
            "resource_group_name": "Default",
            "resource_name": "gs-satellite-ibm1",
            "resource_status": "available",
            "security_group": [
              {
                "group_id": "r014-5489847e-966e-4eb1-8d5a-c0ab2694d266",
                "group_name": "fiddling-runny-browse-audible",
                "rules": [
                  {
                    "code": 0,
                    "direction": "outbound",
                    "ip_version": "ipv4",
                    "port_max": 0,
                    "port_min": 0,
                    "protocol": "all",
                    "remote": "0.0.0.0/0",
                    "rule_id": "r014-6327b593-aa45-4d01-8486-def98b8b37ca",
                    "type": 0
                  },
                  {
                    "code": 0,
                    "direction": "inbound",
                    "ip_version": "ipv4",
                    "port_max": 0,
                    "port_min": 0,
                    "protocol": "all",
                    "remote": "r014-5489847e-966e-4eb1-8d5a-c0ab2694d266",
                    "rule_id": "r014-410bc1ea-53d0-4a33-9c5a-7fb83ccee85e",
                    "type": 0
                  }
                ]
              }
            ],
            "status": "available",
            "subnets": [],
            "tags": [],
            "timeouts": null
          },
          "sensitive_attributes": [],
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjo2MDAwMDAwMDAwMDAsImRlbGV0ZSI6NjAwMDAwMDAwMDAwfX0="
        }
      ]
    },
    {
      "module": "module.location",
      "mode": "managed",
      "type": "ibm_satellite_location",
      "name": "create_location",
      "provider": "provider[\"registry.terraform.io/ibm-cloud/ibm\"]",
      "instances": [
        {
          "index_key": 0,
          "schema_version": 0,
          "attributes": {
            "coreos_enabled": null,
            "cos_config": [],
            "cos_credentials": [],
            "created_on": "2023-08-24T14:20:14+0000",
            "crn": "crn:v1:bluemix:public:satellite:us-east:a/b77832f89c084e1d994ec9ae8e1bce0e:cjjme7lw0k8v5b0qob9g::",
            "description": "",
            "host_attached_count": 0,
            "host_available_count": 0,
            "id": "cjjme7lw0k8v5b0qob9g",
            "ingress_hostname": "g31ee075c74f43e34a24e-6b64a6ccc9c596bf59a86625d8fa2202-c000.us-east.satellite.appdomain.cloud",
            "ingress_secret": "g31ee075c74f43e34a24e-6b64a6ccc9c596bf59a86625d8fa2202-c000",
            "location": "gs-satellite-ibm1",
            "logging_account_id": null,
            "managed_from": "wdc04",
            "resource_group_id": "5b9d354ad44b4698aca47651741f47d3",
            "resource_group_name": "Default",
            "tags": [],
            "timeouts": {
              "create": "60m",
              "delete": null,
              "update": null
            },
            "zones": [
              "us-east-1",
              "us-east-2",
              "us-east-3"
            ]
          },
          "sensitive_attributes": [],
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjozNjAwMDAwMDAwMDAwLCJkZWxldGUiOjM2MDAwMDAwMDAwMDAsInVwZGF0ZSI6NjAwMDAwMDAwMDAwfX0="
        }
      ]
    },
    {
      "module": "module.openshift",
      "mode": "data",
      "type": "ibm_is_image",
      "name": "host",
      "provider": "provider[\"registry.terraform.io/ibm-cloud/ibm\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "access_tags": [],
            "architecture": "amd64",
            "catalog_offering": [
              {
                "managed": false,
                "version": []
              }
            ],
            "checksum": "0cbcc7e6b9b50ca388ed8c1aace8caaf3d12c99d7a4275dc28e3e623cbcaa8c9",
            "crn": "crn:v1:bluemix:public:is:us-east:a/811f8abfbd32425597dc7ba40da98fa6::image:r014-f0e1d733-f981-445a-ae66-de7a59f11e25",
            "encryption": "none",
            "encryption_key": null,
            "id": "r014-f0e1d733-f981-445a-ae66-de7a59f11e25",
            "identifier": null,
            "name": "ibm-redhat-8-6-minimal-amd64-3",
            "os": "red-8-amd64",
            "source_volume": null,
            "status": "deprecated",
            "visibility": "public"
          },
          "sensitive_attributes": []
        }
      ]
    },
    {
      "module": "module.openshift",
      "mode": "data",
      "type": "ibm_is_ssh_key",
      "name": "existing",
      "provider": "provider[\"registry.terraform.io/ibm-cloud/ibm\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "access_tags": [],
            "crn": "crn:v1:bluemix:public:is:us-east:a/b77832f89c084e1d994ec9ae8e1bce0e::key:r014-c0c9915b-a1e6-4fd4-9e0c-6ad37eaab759",
            "fingerprint": "SHA256:EWU+xb5ueLAR0Nvh556gaFeiUYNAa34SHe1+BKL/t2M",
            "id": "r014-c0c9915b-a1e6-4fd4-9e0c-6ad37eaab759",
            "length": 4096,
            "name": "gs-satellite-ibm-east1",
            "public_key": "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCSekyIYOJR39CXTQBsfQrwDmUaTIBP7WdWPifQ7wOc56SZm8MsVRZgtsBfOQ3AEMf31XOtuyenFC3oWdn5qEXt/YOAUTYKlmtsY+wY8pMgZ77opd0Fl7WzjUbAedkzvnLHRWhCyFCtsITo4jl8WGN/pEVDoeySv9LxNTJ9hafsfg8hwc3GB90xNRcFzCtm6GSp6y9FSsyTu9w0FRbkIF1FZT3Z7eoAfR4jblsUuy2OgtNlpcRcrTBuvY2sKSx+TLOVhO8Hp4bCWH4eNPVkEFoE+yFnowIYHVDMsm2Vvu0pYQ8n/skyPcXRwEKzWv4r20p5UVCT1BRtdxUsda+SgnECTVyOXyFBeGgkIY1zLYPttPfaonEOCmTP5SMS5ed9bz7fpowzRmuZ0MY2LcMXKeZW6GVyCycAnnq9ffBd/LLvq11sS82MI1+WQehJe2g22cqsZURDycrBYmav9UG4Kr00q0VzYb9JEYZTNKG5+MDzO7BLpyBD039tu7plQJpbT4z4KUWX3zuzUiR3Sgni7E28k5zqd77+Txcz36vqvnppCUtahGQf2Llz/4AiJUyZdpjNPzFob+6u+GvYAXFzuJGPiRAy3H9GJk56WWsTFyBlSNh1YnjRaQa3iIxjAuWPgO06EXXN+9bYqJqy4oo5MnsEor864bSMB+ZdmMw86sdeGQ==",
            "resource_controller_url": "https://cloud.ibm.com/vpc/compute/sshKeys",
            "resource_crn": "crn:v1:bluemix:public:is:us-east:a/b77832f89c084e1d994ec9ae8e1bce0e::key:r014-c0c9915b-a1e6-4fd4-9e0c-6ad37eaab759",
            "resource_group": null,
            "resource_group_name": "ea72d012571e4c3dabd4d52df09331bf",
            "resource_name": "gs-satellite-ibm-east1",
            "type": "rsa"
          },
          "sensitive_attributes": []
        }
      ]
    },
    {
      "module": "module.openshift",
      "mode": "managed",
      "type": "ibm_is_floating_ip",
      "name": "location_hosts",
      "provider": "provider[\"registry.terraform.io/ibm-cloud/ibm\"]",
      "instances": [
        {
          "index_key": 0,
          "schema_version": 0,
          "attributes": {
            "access_tags": [],
            "address": "52.116.123.141",
            "crn": "crn:v1:bluemix:public:is:us-east-1:a/b77832f89c084e1d994ec9ae8e1bce0e::floating-ip:r014-820af66e-13f3-41d5-97c8-928b2ea15451",
            "id": "r014-820af66e-13f3-41d5-97c8-928b2ea15451",
            "name": "gs-satellite-ibm1-openshift-01",
            "resource_controller_url": "https://cloud.ibm.com/vpc-ext/network/floatingIPs",
            "resource_crn": "crn:v1:bluemix:public:is:us-east-1:a/b77832f89c084e1d994ec9ae8e1bce0e::floating-ip:r014-820af66e-13f3-41d5-97c8-928b2ea15451",
            "resource_group": "5b9d354ad44b4698aca47651741f47d3",
            "resource_group_name": "Default",
            "resource_name": "gs-satellite-ibm1-openshift-01",
            "resource_status": "available",
            "status": "available",
            "tags": [],
            "target": "0757-018ca779-da8b-43dc-84b0-2dd7f27e7b6e",
            "target_list": [
              {
                "crn": "",
                "deleted": [],
                "href": "https://us-east.iaas.cloud.ibm.com/v1/instances/0757_2090e42d-bb0b-4c44-a6c8-79734ced1c0b/network_interfaces/0757-018ca779-da8b-43dc-84b0-2dd7f27e7b6e",
                "id": "0757-018ca779-da8b-43dc-84b0-2dd7f27e7b6e",
                "name": "eth0",
                "primary_ip": [
                  {
                    "address": "10.241.0.4",
                    "href": "https://us-east.iaas.cloud.ibm.com/v1/subnets/0757-b3302169-9838-4498-9580-dc9898fcb19b/reserved_ips/0757-7bff2432-9a1e-4826-ac15-b44bb115f58f",
                    "name": "ultimatum-mantis-crisped-thwarting",
                    "reserved_ip": "0757-7bff2432-9a1e-4826-ac15-b44bb115f58f",
                    "resource_type": "subnet_reserved_ip"
                  }
                ],
                "resource_type": "network_interface"
              }
            ],
            "timeouts": null,
            "zone": "us-east-1"
          },
          "sensitive_attributes": [],
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjo2MDAwMDAwMDAwMDAsImRlbGV0ZSI6NjAwMDAwMDAwMDAwfX0=",
          "dependencies": [
            "module.location.data.ibm_satellite_attach_host_script.script",
            "module.location.data.ibm_satellite_location.location",
            "module.location.ibm_is_security_group.location_security_group",
            "module.location.ibm_is_subnet.location_subnet_zone",
            "module.location.ibm_is_vpc.location_vpc",
            "module.location.ibm_satellite_location.create_location",
            "module.openshift.data.ibm_is_image.host",
            "module.openshift.data.ibm_is_ssh_key.existing",
            "module.openshift.ibm_is_instance.location_hosts"
          ]
        },
        {
          "index_key": 1,
          "schema_version": 0,
          "attributes": {
            "access_tags": [],
            "address": "169.59.191.80",
            "crn": "crn:v1:bluemix:public:is:us-east-2:a/b77832f89c084e1d994ec9ae8e1bce0e::floating-ip:r014-3c3ab1f0-b58d-4615-a1f5-5331285f9a55",
            "id": "r014-3c3ab1f0-b58d-4615-a1f5-5331285f9a55",
            "name": "gs-satellite-ibm1-openshift-02",
            "resource_controller_url": "https://cloud.ibm.com/vpc-ext/network/floatingIPs",
            "resource_crn": "crn:v1:bluemix:public:is:us-east-2:a/b77832f89c084e1d994ec9ae8e1bce0e::floating-ip:r014-3c3ab1f0-b58d-4615-a1f5-5331285f9a55",
            "resource_group": "5b9d354ad44b4698aca47651741f47d3",
            "resource_group_name": "Default",
            "resource_name": "gs-satellite-ibm1-openshift-02",
            "resource_status": "available",
            "status": "available",
            "tags": [],
            "target": "0767-73fd50c9-f123-49f9-9d16-b25269836ce6",
            "target_list": [
              {
                "crn": "",
                "deleted": [],
                "href": "https://us-east.iaas.cloud.ibm.com/v1/instances/0767_282ba469-699d-4bc9-bd42-1c1a6ddcd508/network_interfaces/0767-73fd50c9-f123-49f9-9d16-b25269836ce6",
                "id": "0767-73fd50c9-f123-49f9-9d16-b25269836ce6",
                "name": "eth0",
                "primary_ip": [
                  {
                    "address": "10.241.64.5",
                    "href": "https://us-east.iaas.cloud.ibm.com/v1/subnets/0767-a0afd690-b8d6-4bbb-ae5a-a8621eb21155/reserved_ips/0767-d2abf478-8254-41cc-98a8-3672cd22ffaa",
                    "name": "satin-dilatometer-uncork-carving",
                    "reserved_ip": "0767-d2abf478-8254-41cc-98a8-3672cd22ffaa",
                    "resource_type": "subnet_reserved_ip"
                  }
                ],
                "resource_type": "network_interface"
              }
            ],
            "timeouts": null,
            "zone": "us-east-2"
          },
          "sensitive_attributes": [],
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjo2MDAwMDAwMDAwMDAsImRlbGV0ZSI6NjAwMDAwMDAwMDAwfX0=",
          "dependencies": [
            "module.location.data.ibm_satellite_attach_host_script.script",
            "module.location.data.ibm_satellite_location.location",
            "module.location.ibm_is_security_group.location_security_group",
            "module.location.ibm_is_subnet.location_subnet_zone",
            "module.location.ibm_is_vpc.location_vpc",
            "module.location.ibm_satellite_location.create_location",
            "module.openshift.data.ibm_is_image.host",
            "module.openshift.data.ibm_is_ssh_key.existing",
            "module.openshift.ibm_is_instance.location_hosts"
          ]
        },
        {
          "index_key": 2,
          "schema_version": 0,
          "attributes": {
            "access_tags": [],
            "address": "169.62.16.78",
            "crn": "crn:v1:bluemix:public:is:us-east-3:a/b77832f89c084e1d994ec9ae8e1bce0e::floating-ip:r014-120f2277-9510-48ac-beae-b59f875cfb6e",
            "id": "r014-120f2277-9510-48ac-beae-b59f875cfb6e",
            "name": "gs-satellite-ibm1-openshift-03",
            "resource_controller_url": "https://cloud.ibm.com/vpc-ext/network/floatingIPs",
            "resource_crn": "crn:v1:bluemix:public:is:us-east-3:a/b77832f89c084e1d994ec9ae8e1bce0e::floating-ip:r014-120f2277-9510-48ac-beae-b59f875cfb6e",
            "resource_group": "5b9d354ad44b4698aca47651741f47d3",
            "resource_group_name": "Default",
            "resource_name": "gs-satellite-ibm1-openshift-03",
            "resource_status": "available",
            "status": "available",
            "tags": [],
            "target": "0777-a6882b12-90ad-4f53-b2bf-455b2363ca97",
            "target_list": [
              {
                "crn": "",
                "deleted": [],
                "href": "https://us-east.iaas.cloud.ibm.com/v1/instances/0777_210b8255-999f-47dc-9fea-3658a9641b0c/network_interfaces/0777-a6882b12-90ad-4f53-b2bf-455b2363ca97",
                "id": "0777-a6882b12-90ad-4f53-b2bf-455b2363ca97",
                "name": "eth0",
                "primary_ip": [
                  {
                    "address": "10.241.128.6",
                    "href": "https://us-east.iaas.cloud.ibm.com/v1/subnets/0777-aa5ce777-4fda-4ff5-9fa0-1b872e35ef2e/reserved_ips/0777-44aaeed9-440f-4d81-bf69-f0b0eb62e3a8",
                    "name": "husked-sponge-handwrite-submitter",
                    "reserved_ip": "0777-44aaeed9-440f-4d81-bf69-f0b0eb62e3a8",
                    "resource_type": "subnet_reserved_ip"
                  }
                ],
                "resource_type": "network_interface"
              }
            ],
            "timeouts": null,
            "zone": "us-east-3"
          },
          "sensitive_attributes": [],
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjo2MDAwMDAwMDAwMDAsImRlbGV0ZSI6NjAwMDAwMDAwMDAwfX0=",
          "dependencies": [
            "module.location.data.ibm_satellite_attach_host_script.script",
            "module.location.data.ibm_satellite_location.location",
            "module.location.ibm_is_security_group.location_security_group",
            "module.location.ibm_is_subnet.location_subnet_zone",
            "module.location.ibm_is_vpc.location_vpc",
            "module.location.ibm_satellite_location.create_location",
            "module.openshift.data.ibm_is_image.host",
            "module.openshift.data.ibm_is_ssh_key.existing",
            "module.openshift.ibm_is_instance.location_hosts"
          ]
        }
      ]
    },
    {
      "module": "module.openshift",
      "mode": "managed",
      "type": "ibm_is_instance",
      "name": "location_hosts",
      "provider": "provider[\"registry.terraform.io/ibm-cloud/ibm\"]",
      "instances": [
        {
          "index_key": 0,
          "schema_version": 0,
          "attributes": {
            "access_tags": [],
            "action": null,
            "auto_delete_volume": null,
            "availability_policy_host_failure": "restart",
            "bandwidth": 32000,
            "boot_volume": [
              {
                "auto_delete_volume": true,
                "encryption": "",
                "iops": 3000,
                "name": "unsafe-nuclei-thirsty-vastness",
                "profile": "general-purpose",
                "size": 100,
                "snapshot": "",
                "tags": [],
                "volume_id": "r014-a196dd77-8eab-44ae-a032-50fb2dc2cb15"
              }
            ],
            "catalog_offering": [],
            "crn": "crn:v1:bluemix:public:is:us-east-1:a/b77832f89c084e1d994ec9ae8e1bce0e::instance:0757_2090e42d-bb0b-4c44-a6c8-79734ced1c0b",
            "dedicated_host": null,
            "dedicated_host_group": null,
            "default_trusted_profile_auto_link": null,
            "default_trusted_profile_target": null,
            "disks": [],
            "force_action": false,
            "force_recovery_time": null,
            "gpu": [],
            "id": "0757_2090e42d-bb0b-4c44-a6c8-79734ced1c0b",
            "image": "r014-f0e1d733-f981-445a-ae66-de7a59f11e25",
            "instance_template": null,
            "keys": [
              "r014-c0c9915b-a1e6-4fd4-9e0c-6ad37eaab759"
            ],
            "lifecycle_reasons": [],
            "lifecycle_state": "stable",
            "memory": 64,
            "metadata_service_enabled": false,
            "name": "gs-satellite-ibm1-openshift-01",
            "network_interfaces": [],
            "placement_group": null,
            "placement_target": [],
            "primary_network_interface": [
              {
                "allow_ip_spoofing": false,
                "id": "0757-018ca779-da8b-43dc-84b0-2dd7f27e7b6e",
                "name": "eth0",
                "port_speed": 24000,
                "primary_ip": [
                  {
                    "address": "10.241.0.4",
                    "auto_delete": true,
                    "href": "https://us-east.iaas.cloud.ibm.com/v1/subnets/0757-b3302169-9838-4498-9580-dc9898fcb19b/reserved_ips/0757-7bff2432-9a1e-4826-ac15-b44bb115f58f",
                    "name": "ultimatum-mantis-crisped-thwarting",
                    "reserved_ip": "0757-7bff2432-9a1e-4826-ac15-b44bb115f58f",
                    "resource_type": "subnet_reserved_ip"
                  }
                ],
                "primary_ipv4_address": "10.241.0.4",
                "security_groups": [
                  "r014-736bc133-3b71-4d7f-b3c1-c52ef26e626a"
                ],
                "subnet": "0757-b3302169-9838-4498-9580-dc9898fcb19b"
              }
            ],
            "profile": "bx2-16x64",
            "resource_controller_url": "https://cloud.ibm.com/vpc-ext/compute/vs",
            "resource_crn": "crn:v1:bluemix:public:is:us-east-1:a/b77832f89c084e1d994ec9ae8e1bce0e::instance:0757_2090e42d-bb0b-4c44-a6c8-79734ced1c0b",
            "resource_group": "5b9d354ad44b4698aca47651741f47d3",
            "resource_group_name": "Default",
            "resource_name": "gs-satellite-ibm1-openshift-01",
            "resource_status": "running",
            "status": "running",
            "status_reasons": [],
            "tags": [],
            "timeouts": null,
            "total_network_bandwidth": 24000,
            "total_volume_bandwidth": 8000,
            "user_data": "#!/bin/bash\n\nsubscription-manager release --set=8\nsubscription-manager repos --disable='*eus*'\n\ncat \u003c\u003c'STOPP' | tee /tmp/attachHost.sh\n#!/usr/bin/env bash\ncat \u003c\u003c 'HERE' \u003e\u003e/usr/local/bin/ibm-host-attach.sh\n#!/usr/bin/env bash\nset -ex\nmkdir -p /etc/satelliteflags\nHOST_ASSIGN_FLAG=\"/etc/satelliteflags/hostattachflag\"\nif [[ -f \"$HOST_ASSIGN_FLAG\" ]]; then\n\techo \"host has already been assigned. need to reload before you try the attach again\"\n\texit 0\nfi\nset +x\nHOST_QUEUE_TOKEN=\"9f75cd5f618da970de4d6ba7b1eec08bc74ed3dc317881ce8af00c3e34429bec2a3d324dcbd6be3b129fe9e510fd348b7ab95c805b442944db7006c81d170a5a49d20c52bdabc6b6eb2acfe6b79ad6cdb50d8587cec843f2f94c5a57a2f95e089bcfecb0d681af4dede4143b29a64a91d014e6453a5af30e92a48e809d628f001008a8695381ba204f444211e9c6c925218bb97f64c03dea3588f7721114db4f8d2834508b12b1eb9691fd19e4d2412ec52a2e7955e538c7d8c6077d46b9c11fbad7eef398475825ce8b611439c3b1d71eebc6db619fe8951d26a5a6c66bce183c0c729e1cfea9c46f690a6e0c18096eb375c2812418b7c23cacb2c7365e8e8a\"\nset -x\nACCOUNT_ID=\"b77832f89c084e1d994ec9ae8e1bce0e\"\nCONTROLLER_ID=\"cjjme7lw0k8v5b0qob9g\"\nSELECTOR_LABELS='{}'\nAPI_URL=\"https://origin.us-east.containers.cloud.ibm.com/\"\nREGION=\"us-east\"\n\nexport HOST_QUEUE_TOKEN\nexport ACCOUNT_ID\nexport CONTROLLER_ID\nexport REGION\n\n#shutdown known blacklisted services for Satellite (these will break kube)\nset +e\nsystemctl stop -f iptables.service\nsystemctl disable iptables.service\nsystemctl mask iptables.service\nsystemctl stop -f firewalld.service\nsystemctl disable firewalld.service\nsystemctl mask firewalld.service\nset -e\n\n# ensure you can successfully communicate with redhat mirrors (this is a prereq to the rest of the automation working)\nif [[ $(grep -ic \"maipo\" \u003c /etc/redhat-release) -ne 0 ]]; then\n\t#RHEL 7\n\tOPERATING_SYSTEM=\"RHEL7\"\nelif [[ $(grep -ic \"ootpa\" \u003c /etc/redhat-release) -ne 0 ]]; then\n\t#RHEL 8\n\tOPERATING_SYSTEM=\"RHEL8\"\nelif grep -qi \"coreos\" \u003c /etc/redhat-release; then\n\tOPERATING_SYSTEM=\"RHCOS\"\nelse\n\tOPERATING_SYSTEM=\"UNKNOWN\"\nfi\n\nif [[ \"${OPERATING_SYSTEM}\" != \"RHEL7\" \u0026\u0026 \"${OPERATING_SYSTEM}\" != \"RHEL8\" ]]; then\n\techo \"This script is only intended to run with a RHEL7 or RHEL8 operating system. Current operating system ${OPERATING_SYSTEM}.\"\n\texit 1\nfi\nexport OPERATING_SYSTEM\n\nsubscription-manager refresh\nif [[ \"${OPERATING_SYSTEM}\" == \"RHEL7\" ]]; then\n\tsubscription-manager repos --enable rhel-server-rhscl-7-rpms\n\tsubscription-manager repos --enable rhel-7-server-optional-rpms\n\tsubscription-manager repos --enable rhel-7-server-rh-common-rpms\n\tsubscription-manager repos --enable rhel-7-server-supplementary-rpms\n\tsubscription-manager repos --enable rhel-7-server-extras-rpms\nelif [[ \"${OPERATING_SYSTEM}\" == \"RHEL8\" ]]; then\n\tsubscription-manager release --set=8\n\tsubscription-manager repos --disable='*eus*'\n\tsubscription-manager repos --enable rhel-8-for-x86_64-baseos-rpms \n\tsubscription-manager repos --enable rhel-8-for-x86_64-appstream-rpms;\nfi\nyum install container-selinux -y\n\n\nif [[ \"${OPERATING_SYSTEM}\" == \"RHEL7\" ]]; then\n\tyum install rh-python36 -y\n\t# shellcheck disable=SC1091\n\tsource /opt/rh/rh-python36/enable\nelif [[ \"${OPERATING_SYSTEM}\" == \"RHEL8\" ]]; then\n\tyum install python39 -y\nfi\n\nmkdir -p /etc/satellitemachineidgeneration\nif [[ ! -f /etc/satellitemachineidgeneration/machineidgenerated ]]; then\n    rm -f /etc/machine-id\n    systemd-machine-id-setup\n    if openssl rand -hex 16; then\n      openssl rand -hex 16 \u003e /etc/machine-id\n    fi\n    touch /etc/satellitemachineidgeneration/machineidgenerated\nfi\n#STEP 1: GATHER INFORMATION THAT WILL BE USED TO REGISTER THE HOST\nHOSTNAME=$(hostname -s)\nHOSTNAME=${HOSTNAME,,}\nMACHINE_ID=$(cat /etc/machine-id)\nCPUS=$(nproc)\nMEMORY=$(grep MemTotal /proc/meminfo | awk '{print $2}')\nexport CPUS\nexport MEMORY\n\nif [[ \"${OPERATING_SYSTEM}\" != \"RHEL7\" \u0026\u0026 \"${OPERATING_SYSTEM}\" != \"RHEL8\" ]]; then\n  echo \"This script is only intended to run with a RHEL7 or RHEL8 operating system. Current operating system ${OPERATING_SYSTEM}. Going to continue on for backwards compatibility\"\nfi\n\nSELECTOR_LABELS=$(echo \"${SELECTOR_LABELS}\" | python3 -c \"import sys, json, os; z = json.load(sys.stdin); y = {\\\"cpu\\\": os.getenv('CPUS'), \\\"memory\\\": os.getenv('MEMORY'), \\\"os\\\": os.getenv('OPERATING_SYSTEM')}; z.update(y); print(json.dumps(z))\")\n\nset +e\nexport ZONE=\"\"\nexport PROVIDER=\"\"\nexport TOKEN=\"\"\necho \"Probing for AWS metadata\"\ngather_aws_token() {\n\tHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 -X PUT \"http://169.254.169.254/latest/api/token\" -H \"X-aws-ec2-metadata-token-ttl-seconds: 21600\")\n\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\techo \"bad return code\"\n\t\treturn 1\n\tfi\n\tif [[ -z \"$HTTP_BODY\" ]]; then\n\t\techo \"no token found\"\n\t\treturn 1\n\tfi\n\techo \"found aws access token\"\n\tTOKEN=\"$HTTP_BODY\"\n}\ngather_zone_info() {\n\tHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 -H \"X-aws-ec2-metadata-token: $TOKEN\" http://169.254.169.254/latest/meta-data/placement/availability-zone)\n\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\t# if a 401 retry without auth\n\tif [[ \"$HTTP_STATUS\" -eq 401 ]]; then\n\t\techo \"unable to get aws metadata with v2 metadata service, trying v1...\"\n\t\tHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 http://169.254.169.254/latest/meta-data/placement/availability-zone)\n\t\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\t\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\tfi\n\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\techo \"bad return code\"\n\t\treturn 1\n\tfi\n\tif [[ \"$HTTP_BODY\" =~ [^a-zA-Z0-9-] ]]; then\n\t\techo \"invalid zone format\"\n\t\treturn 1\n\tfi\n\tZONE=\"$HTTP_BODY\"\n}\ngather_aws_info() {\n    if ! gather_aws_token; then\n        return 1\n    fi\n    if ! gather_zone_info; then\n        return 1\n    fi\n}\nif gather_aws_info; then\n\techo \"aws metadata detected\"\n\tPROVIDER=\"aws\"\nfi\nif [[ -z \"$ZONE\" ]]; then\n\techo \"echo Probing for Azure Metadata\"\n\texport LOCATION_INFO=\"\"\n\texport AZURE_ZONE_NUMBER_INFO=\"\"\n\tgather_location_info() {\n\t\tHTTP_RESPONSE=$(curl -H Metadata:true --noproxy \"*\" --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 \"http://169.254.169.254/metadata/instance/compute/location?api-version=2021-01-01\u0026format=text\")\n\t\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\t\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\t\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\t\techo \"bad return code\"\n\t\t\treturn 1\n\t\tfi\n\t\tif [[ \"$HTTP_BODY\" =~ [^a-zA-Z0-9-] ]]; then\n\t\t\techo \"invalid format\"\n\t\t\treturn 1\n\t\tfi\n\t\tLOCATION_INFO=\"$HTTP_BODY\"\n\t}\n\tgather_azure_zone_number_info() {\n\t\tHTTP_RESPONSE=$(curl -H Metadata:true --noproxy \"*\" --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 \"http://169.254.169.254/metadata/instance/compute/zone?api-version=2021-01-01\u0026format=text\")\n\t\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\t\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\t\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\t\techo \"bad return code\"\n\t\t\treturn 1\n\t\tfi\n\t\tif [[ \"$HTTP_BODY\" =~ [^a-zA-Z0-9-] ]]; then\n\t\t\techo \"invalid format\"\n\t\t\treturn 1\n\t\tfi\n\t\tAZURE_ZONE_NUMBER_INFO=\"$HTTP_BODY\"\n\t}\n\tgather_zone_info() {\n\t\tif ! gather_location_info; then\n\t\t\treturn 1\n\t\tfi\n\t\tif ! gather_azure_zone_number_info; then\n\t\t\treturn 1\n\t\tfi\n\t\tif [[ -n \"$AZURE_ZONE_NUMBER_INFO\" ]]; then\n\t\t  ZONE=\"${LOCATION_INFO}-${AZURE_ZONE_NUMBER_INFO}\"\n\t\telse\n\t\t  ZONE=\"${LOCATION_INFO}\"\n\t\tfi\n\t}\n\tif gather_zone_info; then\n\t\techo \"azure metadata detected\"\n\t\tPROVIDER=\"azure\"\n\tfi\nfi\nif [[ -z \"$ZONE\" ]]; then\n\techo \"echo Probing for GCP Metadata\"\n\tgather_zone_info() {\n\t\tHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 \"http://metadata.google.internal/computeMetadata/v1/instance/zone\" -H \"Metadata-Flavor: Google\")\n\t\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\t\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\t\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\t\techo \"bad return code\"\n\t\t\treturn 1\n\t\tfi\n\t\tPOTENTIAL_ZONE_RESPONSE=$(echo \"$HTTP_BODY\" | awk -F '/' '{print $NF}')\n\t\tif [[ \"$POTENTIAL_ZONE_RESPONSE\" =~ [^a-zA-Z0-9-] ]]; then\n\t\t\techo \"invalid zone format\"\n\t\t\treturn 1\n\t\tfi\n\t\tZONE=\"$POTENTIAL_ZONE_RESPONSE\"\n\t}\n\tif gather_zone_info; then\n\t\techo \"gcp metadata detected\"\n\t\tPROVIDER=\"google\"\n\tfi\nfi\nset -e\nif [[ -n \"$ZONE\" ]]; then\n\tSELECTOR_LABELS=$(echo \"${SELECTOR_LABELS}\" | python3 -c \"import sys, json, os; z = json.load(sys.stdin); y = {\\\"zone\\\": os.getenv('ZONE')}; z.update(y); print(json.dumps(z))\")\nfi\nif [[ -n \"$PROVIDER\" ]]; then\n\tSELECTOR_LABELS=$(echo \"${SELECTOR_LABELS}\" | python3 -c \"import sys, json, os; z = json.load(sys.stdin); y = {\\\"provider\\\": os.getenv('PROVIDER')}; z.update(y); print(json.dumps(z))\")\nfi\n#Step 2: SETUP METADATA\ncat \u003c\u003cEOF \u003eregister.json\n{\n\"controller\": \"$CONTROLLER_ID\",\n\"name\": \"$HOSTNAME\",\n\"identifier\": \"$MACHINE_ID\",\n\"labels\": $SELECTOR_LABELS\n}\nEOF\n\nset +e\n#try to download and run host health check script\nset +x\n#first try to the satellite-health service is enabled\nHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --retry 5 --retry-delay 10 --retry-max-time 60 \\\n        \"${API_URL}satellite-health/api/v1/hello\")\nset -x\nHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\nHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\necho \"$HTTP_STATUS\"\nif [[ \"$HTTP_STATUS\" -eq 200 ]]; then\n        set +x\n        HTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --retry 20 --retry-delay 10 --retry-max-time 360 \\\n                \"${API_URL}satellite-health/sat-host-check\" -o /usr/local/bin/sat-host-check)\n        set -x\n        HTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n        HTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n        echo \"$HTTP_BODY\"\n        echo \"$HTTP_STATUS\"\n        if [[ \"$HTTP_STATUS\" -eq 200 ]]; then\n                chmod +x /usr/local/bin/sat-host-check\n                set +x\n                timeout 5m /usr/local/bin/sat-host-check --region $REGION  --endpoint $API_URL\n                set -x\n        else\n                echo \"Error downloading host health check script [HTTP status: $HTTP_STATUS]\"\n        fi\nelse\n        echo \"Skipping downloading host health check script [HTTP status: $HTTP_STATUS]\"\nfi\nset -e\n\nset +x\n#STEP 3: REGISTER HOST TO THE HOSTQUEUE. NEED TO EVALUATE HTTP STATUS 409 EXISTS, 201 created. ALL OTHERS FAIL.\nHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --retry 100 --retry-delay 10 --retry-max-time 1800 -X POST \\\n\t-H \"X-Auth-Hostqueue-APIKey: $HOST_QUEUE_TOKEN\" \\\n\t-H \"X-Auth-Hostqueue-Account: $ACCOUNT_ID\" \\\n\t-H \"Content-Type: application/json\" \\\n\t-d @register.json \\\n\t\"${API_URL}v2/multishift/hostqueue/host/register\")\nset -x\nHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\nHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\necho \"$HTTP_BODY\"\necho \"$HTTP_STATUS\"\nif [[ \"$HTTP_STATUS\" -ne 201 ]]; then\n\techo \"Error [HTTP status: $HTTP_STATUS]\"\n\texit 1\nfi\n\nHOST_ID=$(echo \"$HTTP_BODY\" | python3 -c \"import sys, json; print(json.load(sys.stdin)['id'])\")\n\n#STEP 4: WAIT FOR MEMBERSHIP TO BE ASSIGNED\nwhile true; do\n\tset +ex\n\tASSIGNMENT=$(curl --retry 100 --retry-delay 10 --retry-max-time 1800 -G -X GET \\\n\t\t-H \"X-Auth-Hostqueue-APIKey: $HOST_QUEUE_TOKEN\" \\\n\t\t-H \"X-Auth-Hostqueue-Account: $ACCOUNT_ID\" \\\n\t\t-d controllerID=\"$CONTROLLER_ID\" \\\n\t\t-d hostID=\"$HOST_ID\" \\\n\t\t\"${API_URL}v2/multishift/hostqueue/host/getAssignment\")\n\tset -ex\n\tisAssigned=$(echo \"$ASSIGNMENT\" | python3 -c \"import sys, json; print(json.load(sys.stdin)['isAssigned'])\" | awk '{print tolower($0)}')\n\tif [[ \"$isAssigned\" == \"true\" ]]; then\n\t\tbreak\n\tfi\n\tif [[ \"$isAssigned\" != \"false\" ]]; then\n\t\techo \"unexpected value for assign retrying\"\n\tfi\n\tsleep 10\ndone\n\n#STEP 5: ASSIGNMENT HAS BEEN MADE. SAVE SCRIPT AND RUN\necho \"$ASSIGNMENT\" | python3 -c \"import sys, json; print(json.load(sys.stdin)['script'])\" \u003e/usr/local/bin/ibm-host-agent.sh\nexport HOST_ID\nASSIGNMENT_ID=$(echo \"$ASSIGNMENT\" | python3 -c \"import sys, json; print(json.load(sys.stdin)['id'])\")\ncat \u003c\u003cEOF \u003e/etc/satelliteflags/ibm-host-agent-vars\nexport HOST_ID=${HOST_ID}\nexport ASSIGNMENT_ID=${ASSIGNMENT_ID}\nEOF\nchmod 0600 /etc/satelliteflags/ibm-host-agent-vars\nchmod 0700 /usr/local/bin/ibm-host-agent.sh\ncat \u003c\u003cEOF \u003e/etc/systemd/system/ibm-host-agent.service\n[Unit]\nDescription=IBM Host Agent Service\nAfter=network.target\n\n[Service]\nEnvironment=\"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"\nExecStart=/usr/local/bin/ibm-host-agent.sh\nRestart=on-failure\nRestartSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\nchmod 0644 /etc/systemd/system/ibm-host-agent.service\nsystemctl daemon-reload\nsystemctl start ibm-host-agent.service\ntouch \"$HOST_ASSIGN_FLAG\"\nHERE\n\nchmod 0700 /usr/local/bin/ibm-host-attach.sh\ncat \u003c\u003c 'EOF' \u003e/etc/systemd/system/ibm-host-attach.service\n[Unit]\nDescription=IBM Host Attach Service\nAfter=network.target\n\n[Service]\nEnvironment=\"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"\nExecStart=/usr/local/bin/ibm-host-attach.sh\nRestart=on-failure\nRestartSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\nchmod 0644 /etc/systemd/system/ibm-host-attach.service\nsystemctl daemon-reload\nsystemctl enable ibm-host-attach.service\nsystemctl start ibm-host-attach.service\n\nSTOPP\n\nsudo nohup bash /tmp/attachHost.sh \u0026\n\n",
            "vcpu": [
              {
                "architecture": "amd64",
                "count": 16
              }
            ],
            "volume_attachments": [
              {
                "id": "0757-11902ad3-0c7a-43e2-bb15-506b8ef9358d",
                "name": "exquisite-vast-semiskilled-service",
                "volume_crn": "crn:v1:bluemix:public:is:us-east-1:a/b77832f89c084e1d994ec9ae8e1bce0e::volume:r014-a196dd77-8eab-44ae-a032-50fb2dc2cb15",
                "volume_id": "r014-a196dd77-8eab-44ae-a032-50fb2dc2cb15",
                "volume_name": "unsafe-nuclei-thirsty-vastness"
              }
            ],
            "volumes": null,
            "vpc": "r014-3b20e91d-b51d-47bf-8fd9-9c26cb716073",
            "wait_before_delete": true,
            "zone": "us-east-1"
          },
          "sensitive_attributes": [],
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjoxODAwMDAwMDAwMDAwLCJkZWxldGUiOjE4MDAwMDAwMDAwMDAsInVwZGF0ZSI6MTgwMDAwMDAwMDAwMH19",
          "dependencies": [
            "module.location.data.ibm_satellite_attach_host_script.script",
            "module.location.data.ibm_satellite_location.location",
            "module.location.ibm_is_security_group.location_security_group",
            "module.location.ibm_is_subnet.location_subnet_zone",
            "module.location.ibm_is_vpc.location_vpc",
            "module.location.ibm_satellite_location.create_location",
            "module.openshift.data.ibm_is_image.host",
            "module.openshift.data.ibm_is_ssh_key.existing"
          ]
        },
        {
          "index_key": 1,
          "schema_version": 0,
          "attributes": {
            "access_tags": [],
            "action": null,
            "auto_delete_volume": null,
            "availability_policy_host_failure": "restart",
            "bandwidth": 32000,
            "boot_volume": [
              {
                "auto_delete_volume": true,
                "encryption": "",
                "iops": 3000,
                "name": "grandma-sinter-uncross-stash",
                "profile": "general-purpose",
                "size": 100,
                "snapshot": "",
                "tags": [],
                "volume_id": "r014-743cdeba-f060-4601-8a7f-e0fd808901f8"
              }
            ],
            "catalog_offering": [],
            "crn": "crn:v1:bluemix:public:is:us-east-2:a/b77832f89c084e1d994ec9ae8e1bce0e::instance:0767_282ba469-699d-4bc9-bd42-1c1a6ddcd508",
            "dedicated_host": null,
            "dedicated_host_group": null,
            "default_trusted_profile_auto_link": null,
            "default_trusted_profile_target": null,
            "disks": [],
            "force_action": false,
            "force_recovery_time": null,
            "gpu": [],
            "id": "0767_282ba469-699d-4bc9-bd42-1c1a6ddcd508",
            "image": "r014-f0e1d733-f981-445a-ae66-de7a59f11e25",
            "instance_template": null,
            "keys": [
              "r014-c0c9915b-a1e6-4fd4-9e0c-6ad37eaab759"
            ],
            "lifecycle_reasons": [],
            "lifecycle_state": "stable",
            "memory": 64,
            "metadata_service_enabled": false,
            "name": "gs-satellite-ibm1-openshift-02",
            "network_interfaces": [],
            "placement_group": null,
            "placement_target": [],
            "primary_network_interface": [
              {
                "allow_ip_spoofing": false,
                "id": "0767-73fd50c9-f123-49f9-9d16-b25269836ce6",
                "name": "eth0",
                "port_speed": 24000,
                "primary_ip": [
                  {
                    "address": "10.241.64.5",
                    "auto_delete": true,
                    "href": "https://us-east.iaas.cloud.ibm.com/v1/subnets/0767-a0afd690-b8d6-4bbb-ae5a-a8621eb21155/reserved_ips/0767-d2abf478-8254-41cc-98a8-3672cd22ffaa",
                    "name": "satin-dilatometer-uncork-carving",
                    "reserved_ip": "0767-d2abf478-8254-41cc-98a8-3672cd22ffaa",
                    "resource_type": "subnet_reserved_ip"
                  }
                ],
                "primary_ipv4_address": "10.241.64.5",
                "security_groups": [
                  "r014-736bc133-3b71-4d7f-b3c1-c52ef26e626a"
                ],
                "subnet": "0767-a0afd690-b8d6-4bbb-ae5a-a8621eb21155"
              }
            ],
            "profile": "bx2-16x64",
            "resource_controller_url": "https://cloud.ibm.com/vpc-ext/compute/vs",
            "resource_crn": "crn:v1:bluemix:public:is:us-east-2:a/b77832f89c084e1d994ec9ae8e1bce0e::instance:0767_282ba469-699d-4bc9-bd42-1c1a6ddcd508",
            "resource_group": "5b9d354ad44b4698aca47651741f47d3",
            "resource_group_name": "Default",
            "resource_name": "gs-satellite-ibm1-openshift-02",
            "resource_status": "running",
            "status": "running",
            "status_reasons": [],
            "tags": [],
            "timeouts": null,
            "total_network_bandwidth": 24000,
            "total_volume_bandwidth": 8000,
            "user_data": "#!/bin/bash\n\nsubscription-manager release --set=8\nsubscription-manager repos --disable='*eus*'\n\ncat \u003c\u003c'STOPP' | tee /tmp/attachHost.sh\n#!/usr/bin/env bash\ncat \u003c\u003c 'HERE' \u003e\u003e/usr/local/bin/ibm-host-attach.sh\n#!/usr/bin/env bash\nset -ex\nmkdir -p /etc/satelliteflags\nHOST_ASSIGN_FLAG=\"/etc/satelliteflags/hostattachflag\"\nif [[ -f \"$HOST_ASSIGN_FLAG\" ]]; then\n\techo \"host has already been assigned. need to reload before you try the attach again\"\n\texit 0\nfi\nset +x\nHOST_QUEUE_TOKEN=\"9f75cd5f618da970de4d6ba7b1eec08bc74ed3dc317881ce8af00c3e34429bec2a3d324dcbd6be3b129fe9e510fd348b7ab95c805b442944db7006c81d170a5a49d20c52bdabc6b6eb2acfe6b79ad6cdb50d8587cec843f2f94c5a57a2f95e089bcfecb0d681af4dede4143b29a64a91d014e6453a5af30e92a48e809d628f001008a8695381ba204f444211e9c6c925218bb97f64c03dea3588f7721114db4f8d2834508b12b1eb9691fd19e4d2412ec52a2e7955e538c7d8c6077d46b9c11fbad7eef398475825ce8b611439c3b1d71eebc6db619fe8951d26a5a6c66bce183c0c729e1cfea9c46f690a6e0c18096eb375c2812418b7c23cacb2c7365e8e8a\"\nset -x\nACCOUNT_ID=\"b77832f89c084e1d994ec9ae8e1bce0e\"\nCONTROLLER_ID=\"cjjme7lw0k8v5b0qob9g\"\nSELECTOR_LABELS='{}'\nAPI_URL=\"https://origin.us-east.containers.cloud.ibm.com/\"\nREGION=\"us-east\"\n\nexport HOST_QUEUE_TOKEN\nexport ACCOUNT_ID\nexport CONTROLLER_ID\nexport REGION\n\n#shutdown known blacklisted services for Satellite (these will break kube)\nset +e\nsystemctl stop -f iptables.service\nsystemctl disable iptables.service\nsystemctl mask iptables.service\nsystemctl stop -f firewalld.service\nsystemctl disable firewalld.service\nsystemctl mask firewalld.service\nset -e\n\n# ensure you can successfully communicate with redhat mirrors (this is a prereq to the rest of the automation working)\nif [[ $(grep -ic \"maipo\" \u003c /etc/redhat-release) -ne 0 ]]; then\n\t#RHEL 7\n\tOPERATING_SYSTEM=\"RHEL7\"\nelif [[ $(grep -ic \"ootpa\" \u003c /etc/redhat-release) -ne 0 ]]; then\n\t#RHEL 8\n\tOPERATING_SYSTEM=\"RHEL8\"\nelif grep -qi \"coreos\" \u003c /etc/redhat-release; then\n\tOPERATING_SYSTEM=\"RHCOS\"\nelse\n\tOPERATING_SYSTEM=\"UNKNOWN\"\nfi\n\nif [[ \"${OPERATING_SYSTEM}\" != \"RHEL7\" \u0026\u0026 \"${OPERATING_SYSTEM}\" != \"RHEL8\" ]]; then\n\techo \"This script is only intended to run with a RHEL7 or RHEL8 operating system. Current operating system ${OPERATING_SYSTEM}.\"\n\texit 1\nfi\nexport OPERATING_SYSTEM\n\nsubscription-manager refresh\nif [[ \"${OPERATING_SYSTEM}\" == \"RHEL7\" ]]; then\n\tsubscription-manager repos --enable rhel-server-rhscl-7-rpms\n\tsubscription-manager repos --enable rhel-7-server-optional-rpms\n\tsubscription-manager repos --enable rhel-7-server-rh-common-rpms\n\tsubscription-manager repos --enable rhel-7-server-supplementary-rpms\n\tsubscription-manager repos --enable rhel-7-server-extras-rpms\nelif [[ \"${OPERATING_SYSTEM}\" == \"RHEL8\" ]]; then\n\tsubscription-manager release --set=8\n\tsubscription-manager repos --disable='*eus*'\n\tsubscription-manager repos --enable rhel-8-for-x86_64-baseos-rpms \n\tsubscription-manager repos --enable rhel-8-for-x86_64-appstream-rpms;\nfi\nyum install container-selinux -y\n\n\nif [[ \"${OPERATING_SYSTEM}\" == \"RHEL7\" ]]; then\n\tyum install rh-python36 -y\n\t# shellcheck disable=SC1091\n\tsource /opt/rh/rh-python36/enable\nelif [[ \"${OPERATING_SYSTEM}\" == \"RHEL8\" ]]; then\n\tyum install python39 -y\nfi\n\nmkdir -p /etc/satellitemachineidgeneration\nif [[ ! -f /etc/satellitemachineidgeneration/machineidgenerated ]]; then\n    rm -f /etc/machine-id\n    systemd-machine-id-setup\n    if openssl rand -hex 16; then\n      openssl rand -hex 16 \u003e /etc/machine-id\n    fi\n    touch /etc/satellitemachineidgeneration/machineidgenerated\nfi\n#STEP 1: GATHER INFORMATION THAT WILL BE USED TO REGISTER THE HOST\nHOSTNAME=$(hostname -s)\nHOSTNAME=${HOSTNAME,,}\nMACHINE_ID=$(cat /etc/machine-id)\nCPUS=$(nproc)\nMEMORY=$(grep MemTotal /proc/meminfo | awk '{print $2}')\nexport CPUS\nexport MEMORY\n\nif [[ \"${OPERATING_SYSTEM}\" != \"RHEL7\" \u0026\u0026 \"${OPERATING_SYSTEM}\" != \"RHEL8\" ]]; then\n  echo \"This script is only intended to run with a RHEL7 or RHEL8 operating system. Current operating system ${OPERATING_SYSTEM}. Going to continue on for backwards compatibility\"\nfi\n\nSELECTOR_LABELS=$(echo \"${SELECTOR_LABELS}\" | python3 -c \"import sys, json, os; z = json.load(sys.stdin); y = {\\\"cpu\\\": os.getenv('CPUS'), \\\"memory\\\": os.getenv('MEMORY'), \\\"os\\\": os.getenv('OPERATING_SYSTEM')}; z.update(y); print(json.dumps(z))\")\n\nset +e\nexport ZONE=\"\"\nexport PROVIDER=\"\"\nexport TOKEN=\"\"\necho \"Probing for AWS metadata\"\ngather_aws_token() {\n\tHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 -X PUT \"http://169.254.169.254/latest/api/token\" -H \"X-aws-ec2-metadata-token-ttl-seconds: 21600\")\n\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\techo \"bad return code\"\n\t\treturn 1\n\tfi\n\tif [[ -z \"$HTTP_BODY\" ]]; then\n\t\techo \"no token found\"\n\t\treturn 1\n\tfi\n\techo \"found aws access token\"\n\tTOKEN=\"$HTTP_BODY\"\n}\ngather_zone_info() {\n\tHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 -H \"X-aws-ec2-metadata-token: $TOKEN\" http://169.254.169.254/latest/meta-data/placement/availability-zone)\n\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\t# if a 401 retry without auth\n\tif [[ \"$HTTP_STATUS\" -eq 401 ]]; then\n\t\techo \"unable to get aws metadata with v2 metadata service, trying v1...\"\n\t\tHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 http://169.254.169.254/latest/meta-data/placement/availability-zone)\n\t\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\t\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\tfi\n\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\techo \"bad return code\"\n\t\treturn 1\n\tfi\n\tif [[ \"$HTTP_BODY\" =~ [^a-zA-Z0-9-] ]]; then\n\t\techo \"invalid zone format\"\n\t\treturn 1\n\tfi\n\tZONE=\"$HTTP_BODY\"\n}\ngather_aws_info() {\n    if ! gather_aws_token; then\n        return 1\n    fi\n    if ! gather_zone_info; then\n        return 1\n    fi\n}\nif gather_aws_info; then\n\techo \"aws metadata detected\"\n\tPROVIDER=\"aws\"\nfi\nif [[ -z \"$ZONE\" ]]; then\n\techo \"echo Probing for Azure Metadata\"\n\texport LOCATION_INFO=\"\"\n\texport AZURE_ZONE_NUMBER_INFO=\"\"\n\tgather_location_info() {\n\t\tHTTP_RESPONSE=$(curl -H Metadata:true --noproxy \"*\" --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 \"http://169.254.169.254/metadata/instance/compute/location?api-version=2021-01-01\u0026format=text\")\n\t\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\t\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\t\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\t\techo \"bad return code\"\n\t\t\treturn 1\n\t\tfi\n\t\tif [[ \"$HTTP_BODY\" =~ [^a-zA-Z0-9-] ]]; then\n\t\t\techo \"invalid format\"\n\t\t\treturn 1\n\t\tfi\n\t\tLOCATION_INFO=\"$HTTP_BODY\"\n\t}\n\tgather_azure_zone_number_info() {\n\t\tHTTP_RESPONSE=$(curl -H Metadata:true --noproxy \"*\" --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 \"http://169.254.169.254/metadata/instance/compute/zone?api-version=2021-01-01\u0026format=text\")\n\t\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\t\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\t\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\t\techo \"bad return code\"\n\t\t\treturn 1\n\t\tfi\n\t\tif [[ \"$HTTP_BODY\" =~ [^a-zA-Z0-9-] ]]; then\n\t\t\techo \"invalid format\"\n\t\t\treturn 1\n\t\tfi\n\t\tAZURE_ZONE_NUMBER_INFO=\"$HTTP_BODY\"\n\t}\n\tgather_zone_info() {\n\t\tif ! gather_location_info; then\n\t\t\treturn 1\n\t\tfi\n\t\tif ! gather_azure_zone_number_info; then\n\t\t\treturn 1\n\t\tfi\n\t\tif [[ -n \"$AZURE_ZONE_NUMBER_INFO\" ]]; then\n\t\t  ZONE=\"${LOCATION_INFO}-${AZURE_ZONE_NUMBER_INFO}\"\n\t\telse\n\t\t  ZONE=\"${LOCATION_INFO}\"\n\t\tfi\n\t}\n\tif gather_zone_info; then\n\t\techo \"azure metadata detected\"\n\t\tPROVIDER=\"azure\"\n\tfi\nfi\nif [[ -z \"$ZONE\" ]]; then\n\techo \"echo Probing for GCP Metadata\"\n\tgather_zone_info() {\n\t\tHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 \"http://metadata.google.internal/computeMetadata/v1/instance/zone\" -H \"Metadata-Flavor: Google\")\n\t\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\t\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\t\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\t\techo \"bad return code\"\n\t\t\treturn 1\n\t\tfi\n\t\tPOTENTIAL_ZONE_RESPONSE=$(echo \"$HTTP_BODY\" | awk -F '/' '{print $NF}')\n\t\tif [[ \"$POTENTIAL_ZONE_RESPONSE\" =~ [^a-zA-Z0-9-] ]]; then\n\t\t\techo \"invalid zone format\"\n\t\t\treturn 1\n\t\tfi\n\t\tZONE=\"$POTENTIAL_ZONE_RESPONSE\"\n\t}\n\tif gather_zone_info; then\n\t\techo \"gcp metadata detected\"\n\t\tPROVIDER=\"google\"\n\tfi\nfi\nset -e\nif [[ -n \"$ZONE\" ]]; then\n\tSELECTOR_LABELS=$(echo \"${SELECTOR_LABELS}\" | python3 -c \"import sys, json, os; z = json.load(sys.stdin); y = {\\\"zone\\\": os.getenv('ZONE')}; z.update(y); print(json.dumps(z))\")\nfi\nif [[ -n \"$PROVIDER\" ]]; then\n\tSELECTOR_LABELS=$(echo \"${SELECTOR_LABELS}\" | python3 -c \"import sys, json, os; z = json.load(sys.stdin); y = {\\\"provider\\\": os.getenv('PROVIDER')}; z.update(y); print(json.dumps(z))\")\nfi\n#Step 2: SETUP METADATA\ncat \u003c\u003cEOF \u003eregister.json\n{\n\"controller\": \"$CONTROLLER_ID\",\n\"name\": \"$HOSTNAME\",\n\"identifier\": \"$MACHINE_ID\",\n\"labels\": $SELECTOR_LABELS\n}\nEOF\n\nset +e\n#try to download and run host health check script\nset +x\n#first try to the satellite-health service is enabled\nHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --retry 5 --retry-delay 10 --retry-max-time 60 \\\n        \"${API_URL}satellite-health/api/v1/hello\")\nset -x\nHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\nHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\necho \"$HTTP_STATUS\"\nif [[ \"$HTTP_STATUS\" -eq 200 ]]; then\n        set +x\n        HTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --retry 20 --retry-delay 10 --retry-max-time 360 \\\n                \"${API_URL}satellite-health/sat-host-check\" -o /usr/local/bin/sat-host-check)\n        set -x\n        HTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n        HTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n        echo \"$HTTP_BODY\"\n        echo \"$HTTP_STATUS\"\n        if [[ \"$HTTP_STATUS\" -eq 200 ]]; then\n                chmod +x /usr/local/bin/sat-host-check\n                set +x\n                timeout 5m /usr/local/bin/sat-host-check --region $REGION  --endpoint $API_URL\n                set -x\n        else\n                echo \"Error downloading host health check script [HTTP status: $HTTP_STATUS]\"\n        fi\nelse\n        echo \"Skipping downloading host health check script [HTTP status: $HTTP_STATUS]\"\nfi\nset -e\n\nset +x\n#STEP 3: REGISTER HOST TO THE HOSTQUEUE. NEED TO EVALUATE HTTP STATUS 409 EXISTS, 201 created. ALL OTHERS FAIL.\nHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --retry 100 --retry-delay 10 --retry-max-time 1800 -X POST \\\n\t-H \"X-Auth-Hostqueue-APIKey: $HOST_QUEUE_TOKEN\" \\\n\t-H \"X-Auth-Hostqueue-Account: $ACCOUNT_ID\" \\\n\t-H \"Content-Type: application/json\" \\\n\t-d @register.json \\\n\t\"${API_URL}v2/multishift/hostqueue/host/register\")\nset -x\nHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\nHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\necho \"$HTTP_BODY\"\necho \"$HTTP_STATUS\"\nif [[ \"$HTTP_STATUS\" -ne 201 ]]; then\n\techo \"Error [HTTP status: $HTTP_STATUS]\"\n\texit 1\nfi\n\nHOST_ID=$(echo \"$HTTP_BODY\" | python3 -c \"import sys, json; print(json.load(sys.stdin)['id'])\")\n\n#STEP 4: WAIT FOR MEMBERSHIP TO BE ASSIGNED\nwhile true; do\n\tset +ex\n\tASSIGNMENT=$(curl --retry 100 --retry-delay 10 --retry-max-time 1800 -G -X GET \\\n\t\t-H \"X-Auth-Hostqueue-APIKey: $HOST_QUEUE_TOKEN\" \\\n\t\t-H \"X-Auth-Hostqueue-Account: $ACCOUNT_ID\" \\\n\t\t-d controllerID=\"$CONTROLLER_ID\" \\\n\t\t-d hostID=\"$HOST_ID\" \\\n\t\t\"${API_URL}v2/multishift/hostqueue/host/getAssignment\")\n\tset -ex\n\tisAssigned=$(echo \"$ASSIGNMENT\" | python3 -c \"import sys, json; print(json.load(sys.stdin)['isAssigned'])\" | awk '{print tolower($0)}')\n\tif [[ \"$isAssigned\" == \"true\" ]]; then\n\t\tbreak\n\tfi\n\tif [[ \"$isAssigned\" != \"false\" ]]; then\n\t\techo \"unexpected value for assign retrying\"\n\tfi\n\tsleep 10\ndone\n\n#STEP 5: ASSIGNMENT HAS BEEN MADE. SAVE SCRIPT AND RUN\necho \"$ASSIGNMENT\" | python3 -c \"import sys, json; print(json.load(sys.stdin)['script'])\" \u003e/usr/local/bin/ibm-host-agent.sh\nexport HOST_ID\nASSIGNMENT_ID=$(echo \"$ASSIGNMENT\" | python3 -c \"import sys, json; print(json.load(sys.stdin)['id'])\")\ncat \u003c\u003cEOF \u003e/etc/satelliteflags/ibm-host-agent-vars\nexport HOST_ID=${HOST_ID}\nexport ASSIGNMENT_ID=${ASSIGNMENT_ID}\nEOF\nchmod 0600 /etc/satelliteflags/ibm-host-agent-vars\nchmod 0700 /usr/local/bin/ibm-host-agent.sh\ncat \u003c\u003cEOF \u003e/etc/systemd/system/ibm-host-agent.service\n[Unit]\nDescription=IBM Host Agent Service\nAfter=network.target\n\n[Service]\nEnvironment=\"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"\nExecStart=/usr/local/bin/ibm-host-agent.sh\nRestart=on-failure\nRestartSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\nchmod 0644 /etc/systemd/system/ibm-host-agent.service\nsystemctl daemon-reload\nsystemctl start ibm-host-agent.service\ntouch \"$HOST_ASSIGN_FLAG\"\nHERE\n\nchmod 0700 /usr/local/bin/ibm-host-attach.sh\ncat \u003c\u003c 'EOF' \u003e/etc/systemd/system/ibm-host-attach.service\n[Unit]\nDescription=IBM Host Attach Service\nAfter=network.target\n\n[Service]\nEnvironment=\"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"\nExecStart=/usr/local/bin/ibm-host-attach.sh\nRestart=on-failure\nRestartSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\nchmod 0644 /etc/systemd/system/ibm-host-attach.service\nsystemctl daemon-reload\nsystemctl enable ibm-host-attach.service\nsystemctl start ibm-host-attach.service\n\nSTOPP\n\nsudo nohup bash /tmp/attachHost.sh \u0026\n\n",
            "vcpu": [
              {
                "architecture": "amd64",
                "count": 16
              }
            ],
            "volume_attachments": [
              {
                "id": "0767-24412b62-82b5-4cdc-b046-3f38cc2eaf4d",
                "name": "oversweet-canary-those-octopus",
                "volume_crn": "crn:v1:bluemix:public:is:us-east-2:a/b77832f89c084e1d994ec9ae8e1bce0e::volume:r014-743cdeba-f060-4601-8a7f-e0fd808901f8",
                "volume_id": "r014-743cdeba-f060-4601-8a7f-e0fd808901f8",
                "volume_name": "grandma-sinter-uncross-stash"
              }
            ],
            "volumes": null,
            "vpc": "r014-3b20e91d-b51d-47bf-8fd9-9c26cb716073",
            "wait_before_delete": true,
            "zone": "us-east-2"
          },
          "sensitive_attributes": [],
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjoxODAwMDAwMDAwMDAwLCJkZWxldGUiOjE4MDAwMDAwMDAwMDAsInVwZGF0ZSI6MTgwMDAwMDAwMDAwMH19",
          "dependencies": [
            "module.location.data.ibm_satellite_attach_host_script.script",
            "module.location.data.ibm_satellite_location.location",
            "module.location.ibm_is_security_group.location_security_group",
            "module.location.ibm_is_subnet.location_subnet_zone",
            "module.location.ibm_is_vpc.location_vpc",
            "module.location.ibm_satellite_location.create_location",
            "module.openshift.data.ibm_is_image.host",
            "module.openshift.data.ibm_is_ssh_key.existing"
          ]
        },
        {
          "index_key": 2,
          "schema_version": 0,
          "attributes": {
            "access_tags": [],
            "action": null,
            "auto_delete_volume": null,
            "availability_policy_host_failure": "restart",
            "bandwidth": 32000,
            "boot_volume": [
              {
                "auto_delete_volume": true,
                "encryption": "",
                "iops": 3000,
                "name": "spotlight-phobia-trowel-cupfulls",
                "profile": "general-purpose",
                "size": 100,
                "snapshot": "",
                "tags": [],
                "volume_id": "r014-6ad5f6e5-ebce-4bfd-b473-8814f58c0380"
              }
            ],
            "catalog_offering": [],
            "crn": "crn:v1:bluemix:public:is:us-east-3:a/b77832f89c084e1d994ec9ae8e1bce0e::instance:0777_210b8255-999f-47dc-9fea-3658a9641b0c",
            "dedicated_host": null,
            "dedicated_host_group": null,
            "default_trusted_profile_auto_link": null,
            "default_trusted_profile_target": null,
            "disks": [],
            "force_action": false,
            "force_recovery_time": null,
            "gpu": [],
            "id": "0777_210b8255-999f-47dc-9fea-3658a9641b0c",
            "image": "r014-f0e1d733-f981-445a-ae66-de7a59f11e25",
            "instance_template": null,
            "keys": [
              "r014-c0c9915b-a1e6-4fd4-9e0c-6ad37eaab759"
            ],
            "lifecycle_reasons": [],
            "lifecycle_state": "stable",
            "memory": 64,
            "metadata_service_enabled": false,
            "name": "gs-satellite-ibm1-openshift-03",
            "network_interfaces": [],
            "placement_group": null,
            "placement_target": [],
            "primary_network_interface": [
              {
                "allow_ip_spoofing": false,
                "id": "0777-a6882b12-90ad-4f53-b2bf-455b2363ca97",
                "name": "eth0",
                "port_speed": 24000,
                "primary_ip": [
                  {
                    "address": "10.241.128.6",
                    "auto_delete": true,
                    "href": "https://us-east.iaas.cloud.ibm.com/v1/subnets/0777-aa5ce777-4fda-4ff5-9fa0-1b872e35ef2e/reserved_ips/0777-44aaeed9-440f-4d81-bf69-f0b0eb62e3a8",
                    "name": "husked-sponge-handwrite-submitter",
                    "reserved_ip": "0777-44aaeed9-440f-4d81-bf69-f0b0eb62e3a8",
                    "resource_type": "subnet_reserved_ip"
                  }
                ],
                "primary_ipv4_address": "10.241.128.6",
                "security_groups": [
                  "r014-736bc133-3b71-4d7f-b3c1-c52ef26e626a"
                ],
                "subnet": "0777-aa5ce777-4fda-4ff5-9fa0-1b872e35ef2e"
              }
            ],
            "profile": "bx2-16x64",
            "resource_controller_url": "https://cloud.ibm.com/vpc-ext/compute/vs",
            "resource_crn": "crn:v1:bluemix:public:is:us-east-3:a/b77832f89c084e1d994ec9ae8e1bce0e::instance:0777_210b8255-999f-47dc-9fea-3658a9641b0c",
            "resource_group": "5b9d354ad44b4698aca47651741f47d3",
            "resource_group_name": "Default",
            "resource_name": "gs-satellite-ibm1-openshift-03",
            "resource_status": "running",
            "status": "running",
            "status_reasons": [],
            "tags": [],
            "timeouts": null,
            "total_network_bandwidth": 24000,
            "total_volume_bandwidth": 8000,
            "user_data": "#!/bin/bash\n\nsubscription-manager release --set=8\nsubscription-manager repos --disable='*eus*'\n\ncat \u003c\u003c'STOPP' | tee /tmp/attachHost.sh\n#!/usr/bin/env bash\ncat \u003c\u003c 'HERE' \u003e\u003e/usr/local/bin/ibm-host-attach.sh\n#!/usr/bin/env bash\nset -ex\nmkdir -p /etc/satelliteflags\nHOST_ASSIGN_FLAG=\"/etc/satelliteflags/hostattachflag\"\nif [[ -f \"$HOST_ASSIGN_FLAG\" ]]; then\n\techo \"host has already been assigned. need to reload before you try the attach again\"\n\texit 0\nfi\nset +x\nHOST_QUEUE_TOKEN=\"9f75cd5f618da970de4d6ba7b1eec08bc74ed3dc317881ce8af00c3e34429bec2a3d324dcbd6be3b129fe9e510fd348b7ab95c805b442944db7006c81d170a5a49d20c52bdabc6b6eb2acfe6b79ad6cdb50d8587cec843f2f94c5a57a2f95e089bcfecb0d681af4dede4143b29a64a91d014e6453a5af30e92a48e809d628f001008a8695381ba204f444211e9c6c925218bb97f64c03dea3588f7721114db4f8d2834508b12b1eb9691fd19e4d2412ec52a2e7955e538c7d8c6077d46b9c11fbad7eef398475825ce8b611439c3b1d71eebc6db619fe8951d26a5a6c66bce183c0c729e1cfea9c46f690a6e0c18096eb375c2812418b7c23cacb2c7365e8e8a\"\nset -x\nACCOUNT_ID=\"b77832f89c084e1d994ec9ae8e1bce0e\"\nCONTROLLER_ID=\"cjjme7lw0k8v5b0qob9g\"\nSELECTOR_LABELS='{}'\nAPI_URL=\"https://origin.us-east.containers.cloud.ibm.com/\"\nREGION=\"us-east\"\n\nexport HOST_QUEUE_TOKEN\nexport ACCOUNT_ID\nexport CONTROLLER_ID\nexport REGION\n\n#shutdown known blacklisted services for Satellite (these will break kube)\nset +e\nsystemctl stop -f iptables.service\nsystemctl disable iptables.service\nsystemctl mask iptables.service\nsystemctl stop -f firewalld.service\nsystemctl disable firewalld.service\nsystemctl mask firewalld.service\nset -e\n\n# ensure you can successfully communicate with redhat mirrors (this is a prereq to the rest of the automation working)\nif [[ $(grep -ic \"maipo\" \u003c /etc/redhat-release) -ne 0 ]]; then\n\t#RHEL 7\n\tOPERATING_SYSTEM=\"RHEL7\"\nelif [[ $(grep -ic \"ootpa\" \u003c /etc/redhat-release) -ne 0 ]]; then\n\t#RHEL 8\n\tOPERATING_SYSTEM=\"RHEL8\"\nelif grep -qi \"coreos\" \u003c /etc/redhat-release; then\n\tOPERATING_SYSTEM=\"RHCOS\"\nelse\n\tOPERATING_SYSTEM=\"UNKNOWN\"\nfi\n\nif [[ \"${OPERATING_SYSTEM}\" != \"RHEL7\" \u0026\u0026 \"${OPERATING_SYSTEM}\" != \"RHEL8\" ]]; then\n\techo \"This script is only intended to run with a RHEL7 or RHEL8 operating system. Current operating system ${OPERATING_SYSTEM}.\"\n\texit 1\nfi\nexport OPERATING_SYSTEM\n\nsubscription-manager refresh\nif [[ \"${OPERATING_SYSTEM}\" == \"RHEL7\" ]]; then\n\tsubscription-manager repos --enable rhel-server-rhscl-7-rpms\n\tsubscription-manager repos --enable rhel-7-server-optional-rpms\n\tsubscription-manager repos --enable rhel-7-server-rh-common-rpms\n\tsubscription-manager repos --enable rhel-7-server-supplementary-rpms\n\tsubscription-manager repos --enable rhel-7-server-extras-rpms\nelif [[ \"${OPERATING_SYSTEM}\" == \"RHEL8\" ]]; then\n\tsubscription-manager release --set=8\n\tsubscription-manager repos --disable='*eus*'\n\tsubscription-manager repos --enable rhel-8-for-x86_64-baseos-rpms \n\tsubscription-manager repos --enable rhel-8-for-x86_64-appstream-rpms;\nfi\nyum install container-selinux -y\n\n\nif [[ \"${OPERATING_SYSTEM}\" == \"RHEL7\" ]]; then\n\tyum install rh-python36 -y\n\t# shellcheck disable=SC1091\n\tsource /opt/rh/rh-python36/enable\nelif [[ \"${OPERATING_SYSTEM}\" == \"RHEL8\" ]]; then\n\tyum install python39 -y\nfi\n\nmkdir -p /etc/satellitemachineidgeneration\nif [[ ! -f /etc/satellitemachineidgeneration/machineidgenerated ]]; then\n    rm -f /etc/machine-id\n    systemd-machine-id-setup\n    if openssl rand -hex 16; then\n      openssl rand -hex 16 \u003e /etc/machine-id\n    fi\n    touch /etc/satellitemachineidgeneration/machineidgenerated\nfi\n#STEP 1: GATHER INFORMATION THAT WILL BE USED TO REGISTER THE HOST\nHOSTNAME=$(hostname -s)\nHOSTNAME=${HOSTNAME,,}\nMACHINE_ID=$(cat /etc/machine-id)\nCPUS=$(nproc)\nMEMORY=$(grep MemTotal /proc/meminfo | awk '{print $2}')\nexport CPUS\nexport MEMORY\n\nif [[ \"${OPERATING_SYSTEM}\" != \"RHEL7\" \u0026\u0026 \"${OPERATING_SYSTEM}\" != \"RHEL8\" ]]; then\n  echo \"This script is only intended to run with a RHEL7 or RHEL8 operating system. Current operating system ${OPERATING_SYSTEM}. Going to continue on for backwards compatibility\"\nfi\n\nSELECTOR_LABELS=$(echo \"${SELECTOR_LABELS}\" | python3 -c \"import sys, json, os; z = json.load(sys.stdin); y = {\\\"cpu\\\": os.getenv('CPUS'), \\\"memory\\\": os.getenv('MEMORY'), \\\"os\\\": os.getenv('OPERATING_SYSTEM')}; z.update(y); print(json.dumps(z))\")\n\nset +e\nexport ZONE=\"\"\nexport PROVIDER=\"\"\nexport TOKEN=\"\"\necho \"Probing for AWS metadata\"\ngather_aws_token() {\n\tHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 -X PUT \"http://169.254.169.254/latest/api/token\" -H \"X-aws-ec2-metadata-token-ttl-seconds: 21600\")\n\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\techo \"bad return code\"\n\t\treturn 1\n\tfi\n\tif [[ -z \"$HTTP_BODY\" ]]; then\n\t\techo \"no token found\"\n\t\treturn 1\n\tfi\n\techo \"found aws access token\"\n\tTOKEN=\"$HTTP_BODY\"\n}\ngather_zone_info() {\n\tHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 -H \"X-aws-ec2-metadata-token: $TOKEN\" http://169.254.169.254/latest/meta-data/placement/availability-zone)\n\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\t# if a 401 retry without auth\n\tif [[ \"$HTTP_STATUS\" -eq 401 ]]; then\n\t\techo \"unable to get aws metadata with v2 metadata service, trying v1...\"\n\t\tHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 http://169.254.169.254/latest/meta-data/placement/availability-zone)\n\t\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\t\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\tfi\n\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\techo \"bad return code\"\n\t\treturn 1\n\tfi\n\tif [[ \"$HTTP_BODY\" =~ [^a-zA-Z0-9-] ]]; then\n\t\techo \"invalid zone format\"\n\t\treturn 1\n\tfi\n\tZONE=\"$HTTP_BODY\"\n}\ngather_aws_info() {\n    if ! gather_aws_token; then\n        return 1\n    fi\n    if ! gather_zone_info; then\n        return 1\n    fi\n}\nif gather_aws_info; then\n\techo \"aws metadata detected\"\n\tPROVIDER=\"aws\"\nfi\nif [[ -z \"$ZONE\" ]]; then\n\techo \"echo Probing for Azure Metadata\"\n\texport LOCATION_INFO=\"\"\n\texport AZURE_ZONE_NUMBER_INFO=\"\"\n\tgather_location_info() {\n\t\tHTTP_RESPONSE=$(curl -H Metadata:true --noproxy \"*\" --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 \"http://169.254.169.254/metadata/instance/compute/location?api-version=2021-01-01\u0026format=text\")\n\t\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\t\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\t\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\t\techo \"bad return code\"\n\t\t\treturn 1\n\t\tfi\n\t\tif [[ \"$HTTP_BODY\" =~ [^a-zA-Z0-9-] ]]; then\n\t\t\techo \"invalid format\"\n\t\t\treturn 1\n\t\tfi\n\t\tLOCATION_INFO=\"$HTTP_BODY\"\n\t}\n\tgather_azure_zone_number_info() {\n\t\tHTTP_RESPONSE=$(curl -H Metadata:true --noproxy \"*\" --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 \"http://169.254.169.254/metadata/instance/compute/zone?api-version=2021-01-01\u0026format=text\")\n\t\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\t\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\t\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\t\techo \"bad return code\"\n\t\t\treturn 1\n\t\tfi\n\t\tif [[ \"$HTTP_BODY\" =~ [^a-zA-Z0-9-] ]]; then\n\t\t\techo \"invalid format\"\n\t\t\treturn 1\n\t\tfi\n\t\tAZURE_ZONE_NUMBER_INFO=\"$HTTP_BODY\"\n\t}\n\tgather_zone_info() {\n\t\tif ! gather_location_info; then\n\t\t\treturn 1\n\t\tfi\n\t\tif ! gather_azure_zone_number_info; then\n\t\t\treturn 1\n\t\tfi\n\t\tif [[ -n \"$AZURE_ZONE_NUMBER_INFO\" ]]; then\n\t\t  ZONE=\"${LOCATION_INFO}-${AZURE_ZONE_NUMBER_INFO}\"\n\t\telse\n\t\t  ZONE=\"${LOCATION_INFO}\"\n\t\tfi\n\t}\n\tif gather_zone_info; then\n\t\techo \"azure metadata detected\"\n\t\tPROVIDER=\"azure\"\n\tfi\nfi\nif [[ -z \"$ZONE\" ]]; then\n\techo \"echo Probing for GCP Metadata\"\n\tgather_zone_info() {\n\t\tHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --max-time 10 \"http://metadata.google.internal/computeMetadata/v1/instance/zone\" -H \"Metadata-Flavor: Google\")\n\t\tHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\t\tHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n\t\tif [[ \"$HTTP_STATUS\" -ne 200 ]]; then\n\t\t\techo \"bad return code\"\n\t\t\treturn 1\n\t\tfi\n\t\tPOTENTIAL_ZONE_RESPONSE=$(echo \"$HTTP_BODY\" | awk -F '/' '{print $NF}')\n\t\tif [[ \"$POTENTIAL_ZONE_RESPONSE\" =~ [^a-zA-Z0-9-] ]]; then\n\t\t\techo \"invalid zone format\"\n\t\t\treturn 1\n\t\tfi\n\t\tZONE=\"$POTENTIAL_ZONE_RESPONSE\"\n\t}\n\tif gather_zone_info; then\n\t\techo \"gcp metadata detected\"\n\t\tPROVIDER=\"google\"\n\tfi\nfi\nset -e\nif [[ -n \"$ZONE\" ]]; then\n\tSELECTOR_LABELS=$(echo \"${SELECTOR_LABELS}\" | python3 -c \"import sys, json, os; z = json.load(sys.stdin); y = {\\\"zone\\\": os.getenv('ZONE')}; z.update(y); print(json.dumps(z))\")\nfi\nif [[ -n \"$PROVIDER\" ]]; then\n\tSELECTOR_LABELS=$(echo \"${SELECTOR_LABELS}\" | python3 -c \"import sys, json, os; z = json.load(sys.stdin); y = {\\\"provider\\\": os.getenv('PROVIDER')}; z.update(y); print(json.dumps(z))\")\nfi\n#Step 2: SETUP METADATA\ncat \u003c\u003cEOF \u003eregister.json\n{\n\"controller\": \"$CONTROLLER_ID\",\n\"name\": \"$HOSTNAME\",\n\"identifier\": \"$MACHINE_ID\",\n\"labels\": $SELECTOR_LABELS\n}\nEOF\n\nset +e\n#try to download and run host health check script\nset +x\n#first try to the satellite-health service is enabled\nHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --retry 5 --retry-delay 10 --retry-max-time 60 \\\n        \"${API_URL}satellite-health/api/v1/hello\")\nset -x\nHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\nHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\necho \"$HTTP_STATUS\"\nif [[ \"$HTTP_STATUS\" -eq 200 ]]; then\n        set +x\n        HTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --retry 20 --retry-delay 10 --retry-max-time 360 \\\n                \"${API_URL}satellite-health/sat-host-check\" -o /usr/local/bin/sat-host-check)\n        set -x\n        HTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\n        HTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n        echo \"$HTTP_BODY\"\n        echo \"$HTTP_STATUS\"\n        if [[ \"$HTTP_STATUS\" -eq 200 ]]; then\n                chmod +x /usr/local/bin/sat-host-check\n                set +x\n                timeout 5m /usr/local/bin/sat-host-check --region $REGION  --endpoint $API_URL\n                set -x\n        else\n                echo \"Error downloading host health check script [HTTP status: $HTTP_STATUS]\"\n        fi\nelse\n        echo \"Skipping downloading host health check script [HTTP status: $HTTP_STATUS]\"\nfi\nset -e\n\nset +x\n#STEP 3: REGISTER HOST TO THE HOSTQUEUE. NEED TO EVALUATE HTTP STATUS 409 EXISTS, 201 created. ALL OTHERS FAIL.\nHTTP_RESPONSE=$(curl --write-out \"HTTPSTATUS:%{http_code}\" --retry 100 --retry-delay 10 --retry-max-time 1800 -X POST \\\n\t-H \"X-Auth-Hostqueue-APIKey: $HOST_QUEUE_TOKEN\" \\\n\t-H \"X-Auth-Hostqueue-Account: $ACCOUNT_ID\" \\\n\t-H \"Content-Type: application/json\" \\\n\t-d @register.json \\\n\t\"${API_URL}v2/multishift/hostqueue/host/register\")\nset -x\nHTTP_BODY=$(echo \"$HTTP_RESPONSE\" | sed -E 's/HTTPSTATUS\\:[0-9]{3}$//')\nHTTP_STATUS=$(echo \"$HTTP_RESPONSE\" | tr -d '\\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\\1/')\n\necho \"$HTTP_BODY\"\necho \"$HTTP_STATUS\"\nif [[ \"$HTTP_STATUS\" -ne 201 ]]; then\n\techo \"Error [HTTP status: $HTTP_STATUS]\"\n\texit 1\nfi\n\nHOST_ID=$(echo \"$HTTP_BODY\" | python3 -c \"import sys, json; print(json.load(sys.stdin)['id'])\")\n\n#STEP 4: WAIT FOR MEMBERSHIP TO BE ASSIGNED\nwhile true; do\n\tset +ex\n\tASSIGNMENT=$(curl --retry 100 --retry-delay 10 --retry-max-time 1800 -G -X GET \\\n\t\t-H \"X-Auth-Hostqueue-APIKey: $HOST_QUEUE_TOKEN\" \\\n\t\t-H \"X-Auth-Hostqueue-Account: $ACCOUNT_ID\" \\\n\t\t-d controllerID=\"$CONTROLLER_ID\" \\\n\t\t-d hostID=\"$HOST_ID\" \\\n\t\t\"${API_URL}v2/multishift/hostqueue/host/getAssignment\")\n\tset -ex\n\tisAssigned=$(echo \"$ASSIGNMENT\" | python3 -c \"import sys, json; print(json.load(sys.stdin)['isAssigned'])\" | awk '{print tolower($0)}')\n\tif [[ \"$isAssigned\" == \"true\" ]]; then\n\t\tbreak\n\tfi\n\tif [[ \"$isAssigned\" != \"false\" ]]; then\n\t\techo \"unexpected value for assign retrying\"\n\tfi\n\tsleep 10\ndone\n\n#STEP 5: ASSIGNMENT HAS BEEN MADE. SAVE SCRIPT AND RUN\necho \"$ASSIGNMENT\" | python3 -c \"import sys, json; print(json.load(sys.stdin)['script'])\" \u003e/usr/local/bin/ibm-host-agent.sh\nexport HOST_ID\nASSIGNMENT_ID=$(echo \"$ASSIGNMENT\" | python3 -c \"import sys, json; print(json.load(sys.stdin)['id'])\")\ncat \u003c\u003cEOF \u003e/etc/satelliteflags/ibm-host-agent-vars\nexport HOST_ID=${HOST_ID}\nexport ASSIGNMENT_ID=${ASSIGNMENT_ID}\nEOF\nchmod 0600 /etc/satelliteflags/ibm-host-agent-vars\nchmod 0700 /usr/local/bin/ibm-host-agent.sh\ncat \u003c\u003cEOF \u003e/etc/systemd/system/ibm-host-agent.service\n[Unit]\nDescription=IBM Host Agent Service\nAfter=network.target\n\n[Service]\nEnvironment=\"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"\nExecStart=/usr/local/bin/ibm-host-agent.sh\nRestart=on-failure\nRestartSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\nchmod 0644 /etc/systemd/system/ibm-host-agent.service\nsystemctl daemon-reload\nsystemctl start ibm-host-agent.service\ntouch \"$HOST_ASSIGN_FLAG\"\nHERE\n\nchmod 0700 /usr/local/bin/ibm-host-attach.sh\ncat \u003c\u003c 'EOF' \u003e/etc/systemd/system/ibm-host-attach.service\n[Unit]\nDescription=IBM Host Attach Service\nAfter=network.target\n\n[Service]\nEnvironment=\"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"\nExecStart=/usr/local/bin/ibm-host-attach.sh\nRestart=on-failure\nRestartSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\nchmod 0644 /etc/systemd/system/ibm-host-attach.service\nsystemctl daemon-reload\nsystemctl enable ibm-host-attach.service\nsystemctl start ibm-host-attach.service\n\nSTOPP\n\nsudo nohup bash /tmp/attachHost.sh \u0026\n\n",
            "vcpu": [
              {
                "architecture": "amd64",
                "count": 16
              }
            ],
            "volume_attachments": [
              {
                "id": "0777-2515eaed-f56f-4d5b-9b33-ad9d3f37a486",
                "name": "attire-shore-dig-crux",
                "volume_crn": "crn:v1:bluemix:public:is:us-east-3:a/b77832f89c084e1d994ec9ae8e1bce0e::volume:r014-6ad5f6e5-ebce-4bfd-b473-8814f58c0380",
                "volume_id": "r014-6ad5f6e5-ebce-4bfd-b473-8814f58c0380",
                "volume_name": "spotlight-phobia-trowel-cupfulls"
              }
            ],
            "volumes": null,
            "vpc": "r014-3b20e91d-b51d-47bf-8fd9-9c26cb716073",
            "wait_before_delete": true,
            "zone": "us-east-3"
          },
          "sensitive_attributes": [],
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjoxODAwMDAwMDAwMDAwLCJkZWxldGUiOjE4MDAwMDAwMDAwMDAsInVwZGF0ZSI6MTgwMDAwMDAwMDAwMH19",
          "dependencies": [
            "module.location.data.ibm_satellite_attach_host_script.script",
            "module.location.data.ibm_satellite_location.location",
            "module.location.ibm_is_security_group.location_security_group",
            "module.location.ibm_is_subnet.location_subnet_zone",
            "module.location.ibm_is_vpc.location_vpc",
            "module.location.ibm_satellite_location.create_location",
            "module.openshift.data.ibm_is_image.host",
            "module.openshift.data.ibm_is_ssh_key.existing"
          ]
        }
      ]
    }
  ],
  "check_results": null
}
